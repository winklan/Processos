<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Processos - Gabinete Judicial</title>

    <!-- Google Fonts: Montserrat + Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
/* Reset e Configurações Básicas */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    /* Cores Institucionais - Tema Claro */
    --primary-color: #1e3a5f;
    --primary-dark: #0f172a;
    --primary-light: #2d4a6f;
    --accent-color: #b8860b;
    --accent-light: #d4a847;
    --accent-dark: #8b6914;
    --secondary-color: #475569;
    --success-color: #047857;
    --warning-color: #d97706;
    --danger-color: #b91c1c;
    --light-bg: #f1f5f9;
    --white: #ffffff;
    --text-dark: #0f172a;
    --text-medium: #334155;
    --text-light: #64748b;
    --border-color: #cbd5e1;
    --border-light: #e2e8f0;

    /* Sombras refinadas */
    --shadow-xs: 0 1px 2px rgba(15, 23, 42, 0.05);
    --shadow: 0 1px 3px rgba(15, 23, 42, 0.08), 0 1px 2px rgba(15, 23, 42, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(15, 23, 42, 0.08), 0 2px 4px -2px rgba(15, 23, 42, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(15, 23, 42, 0.1), 0 4px 6px -4px rgba(15, 23, 42, 0.08);
    --shadow-xl: 0 20px 25px -5px rgba(15, 23, 42, 0.1), 0 8px 10px -6px rgba(15, 23, 42, 0.08);

    /* Transições */
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);

    /* Bordas */
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
}

/* Tema Escuro */
[data-theme="dark"] {
    --primary-color: #3b6ea5;
    --primary-dark: #1e3a5f;
    --primary-light: #5a8fc7;
    --accent-color: #d4a847;
    --accent-light: #e8c36a;
    --accent-dark: #b8860b;
    --secondary-color: #94a3b8;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --light-bg: #0f172a;
    --white: #1e293b;
    --text-dark: #f1f5f9;
    --text-medium: #cbd5e1;
    --text-light: #94a3b8;
    --border-color: #334155;
    --border-light: #1e293b;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.6;
    color: var(--text-dark);
    background-color: var(--light-bg);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    transition: background-color var(--transition-slow), color var(--transition-slow);
}

/* Layout com Sidebar */
body {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 260px;
    background: linear-gradient(180deg, var(--white) 0%, #f8fafc 100%);
    color: var(--text-dark);
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    overflow-y: auto;
    box-shadow: 2px 0 20px rgba(15, 23, 42, 0.08);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-light);
    transition: all var(--transition-slow);
}

[data-theme="dark"] .sidebar {
    background: linear-gradient(180deg, var(--white) 0%, #0f172a 100%);
    box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
}

.sidebar-header {
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    border-bottom: 1px solid var(--border-light);
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    position: relative;
    overflow: hidden;
}

.sidebar-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    pointer-events: none;
}

.sidebar-title {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    font-weight: 700;
    margin: 0 0 2px 0;
    line-height: 1.3;
    color: #ffffff;
    letter-spacing: -0.01em;
}

.sidebar-subtitle {
    font-size: 0.75rem;
    font-weight: 500;
    margin: 0;
    color: rgba(255, 255, 255, 0.7);
    letter-spacing: 0.02em;
}

.sidebar-nav {
    flex: 1;
    padding: 8px 0;
    overflow-y: auto;
}

.sidebar-section {
    margin-bottom: 24px;
}

.sidebar-section-title {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #94a3b8;
    padding: 0 20px 8px 20px;
    margin: 0;
}

.sidebar-btn {
    width: 100%;
    background: transparent;
    color: var(--text-medium);
    border: none;
    padding: 11px 20px;
    font-size: 0.875rem;
    font-weight: 500;
    text-align: left;
    cursor: pointer;
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    gap: 12px;
    border-radius: 0;
    position: relative;
}

.sidebar-btn::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 0;
    background: var(--accent-color);
    border-radius: 0 2px 2px 0;
    transition: height var(--transition-base);
}

.sidebar-btn:hover {
    background: linear-gradient(90deg, rgba(184, 134, 11, 0.08) 0%, transparent 100%);
    color: var(--text-dark);
}

.sidebar-btn:hover::before {
    height: 60%;
}

.sidebar-btn svg {
    flex-shrink: 0;
}

.sidebar-icon {
    min-width: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    transition: all var(--transition-base);
}

.sidebar-btn:hover .sidebar-icon {
    color: var(--accent-color);
    transform: scale(1.1);
}

.sidebar-text {
    flex: 1;
    letter-spacing: -0.01em;
}

/* Sidebar Header com Logo Institucional */
.sidebar-logo {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: var(--primary-dark);
    box-shadow: 0 4px 12px rgba(184, 134, 11, 0.3);
    position: relative;
    z-index: 1;
}

.sidebar-logo svg {
    width: 28px;
    height: 28px;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
}

.sidebar-header-text {
    flex: 1;
    overflow: hidden;
    position: relative;
    z-index: 1;
}

/* Botões de Ação Rápida (Novo Processo / Em Lote) */
.sidebar-action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    padding: 16px;
    border-bottom: 1px solid var(--border-light);
    margin-bottom: 8px;
    background: var(--white);
}

.sidebar-action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 16px 8px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 2px solid var(--border-light);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    color: var(--text-medium);
    position: relative;
    overflow: hidden;
}

.sidebar-action-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    opacity: 0;
    transition: opacity var(--transition-base);
}

.sidebar-action-btn:hover {
    border-color: var(--primary-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg), 0 4px 20px rgba(30, 58, 95, 0.2);
}

.sidebar-action-btn:hover::before {
    opacity: 1;
}

.sidebar-action-btn:active {
    transform: translateY(0);
}

.sidebar-action-btn:hover .sidebar-action-icon,
.sidebar-action-btn:hover .sidebar-action-text {
    color: white;
    position: relative;
    z-index: 1;
}

.sidebar-action-icon {
    color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
    position: relative;
    z-index: 1;
}

.sidebar-action-text {
    font-size: 0.8rem;
    font-weight: 600;
    text-align: center;
    position: relative;
    z-index: 1;
    transition: color var(--transition-base);
}

[data-theme="dark"] .sidebar-action-btn {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-color: var(--border-color);
}

/* Sidebar Footer e Botão Recolher */
.sidebar-footer {
    padding: 12px 16px;
    border-top: 1px solid var(--border-light);
    margin-top: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: var(--white);
}

/* Toggle de Tema */
.theme-toggle-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
}

[data-theme="dark"] .theme-toggle-container {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
}

.theme-toggle-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-medium);
    display: flex;
    align-items: center;
    gap: 8px;
}

.theme-toggle {
    position: relative;
    width: 48px;
    height: 26px;
    background: var(--border-color);
    border-radius: 13px;
    cursor: pointer;
    transition: all var(--transition-base);
    border: none;
    padding: 0;
}

.theme-toggle::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: all var(--transition-base);
    box-shadow: var(--shadow-sm);
}

.theme-toggle.active {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
}

.theme-toggle.active::after {
    left: 25px;
    background: var(--accent-light);
}

.sidebar-collapse-btn {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
    border-radius: var(--radius-md) !important;
    color: var(--text-light) !important;
    border: 1px solid var(--border-light) !important;
    transition: all var(--transition-base) !important;
}

.sidebar-collapse-btn:hover {
    background: var(--border-light) !important;
    color: var(--text-dark) !important;
    border-color: var(--border-color) !important;
}

.sidebar-collapse-icon {
    transition: transform var(--transition-slow);
}

.sidebar-collapse-icon svg {
    color: var(--text-light);
}

[data-theme="dark"] .sidebar-collapse-btn {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
    border-color: var(--border-color) !important;
}

/* Badges do Sidebar */
.sidebar-badge {
    background: var(--border-light);
    color: var(--text-medium);
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    min-width: 26px;
    text-align: center;
    margin-left: auto;
    transition: all var(--transition-base);
    letter-spacing: 0.02em;
}

.sidebar-badge.badge-danger {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    color: var(--danger-color);
    box-shadow: 0 2px 8px rgba(185, 28, 28, 0.15);
}

.sidebar-badge.badge-warning {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    color: var(--warning-color);
    box-shadow: 0 2px 8px rgba(217, 119, 6, 0.15);
}

[data-theme="dark"] .sidebar-badge {
    background: var(--border-color);
}

[data-theme="dark"] .sidebar-badge.badge-danger {
    background: rgba(185, 28, 28, 0.2);
}

[data-theme="dark"] .sidebar-badge.badge-warning {
    background: rgba(217, 119, 6, 0.2);
}

/* Indicadores Coloridos (Alertas) */
.sidebar-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.indicator-red {
    background: #ef4444;
}

.indicator-yellow {
    background: #f59e0b;
}

.indicator-blue {
    background: #3b82f6;
}

/* Item de Navegação Ativo */
.sidebar-nav-item.active {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    color: white;
    border-radius: var(--radius-md);
    margin: 0 12px;
    width: calc(100% - 24px);
    box-shadow: var(--shadow-md), 0 4px 12px rgba(30, 58, 95, 0.2);
}

.sidebar-nav-item.active::before {
    display: none;
}

.sidebar-nav-item.active .sidebar-icon {
    color: var(--accent-light);
}

.sidebar-nav-item.active .sidebar-badge {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    box-shadow: none;
}

.sidebar-nav-item.active:hover {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    color: white;
}

/* Estado Recolhido do Sidebar */
.sidebar.collapsed {
    width: 72px;
}

.sidebar.collapsed .sidebar-header {
    padding: 20px 14px;
    justify-content: center;
}

.sidebar.collapsed .sidebar-header-text,
.sidebar.collapsed .sidebar-section-title,
.sidebar.collapsed .sidebar-text,
.sidebar.collapsed .sidebar-action-text {
    display: none;
}

.sidebar.collapsed .sidebar-action-buttons {
    grid-template-columns: 1fr;
    padding: 0 10px 16px 10px;
    gap: 8px;
}

.sidebar.collapsed .sidebar-action-btn {
    padding: 12px 8px;
}

.sidebar.collapsed .sidebar-btn {
    padding: 12px 10px;
    justify-content: center;
    margin: 0 10px;
    width: calc(100% - 20px);
    border-radius: 8px;
}

.sidebar.collapsed .sidebar-nav-item.active {
    margin: 0 10px;
    width: calc(100% - 20px);
}

.sidebar.collapsed .sidebar-icon,
.sidebar.collapsed .sidebar-indicator {
    margin: 0;
}

.sidebar.collapsed .sidebar-badge {
    position: absolute;
    top: 0;
    right: 0;
    font-size: 0.6rem;
    padding: 1px 4px;
    min-width: 16px;
    border-radius: 8px;
}

.sidebar.collapsed .sidebar-btn {
    position: relative;
}

.sidebar.collapsed .sidebar-collapse-icon svg {
    transform: rotate(180deg);
}

.sidebar.collapsed .sidebar-footer {
    padding: 12px 10px;
}

.sidebar.collapsed .theme-toggle-container {
    flex-direction: column;
    gap: 6px;
    padding: 10px 8px;
}

.sidebar.collapsed .theme-toggle-label {
    font-size: 0;
}

.sidebar.collapsed .theme-toggle-label svg {
    width: 18px;
    height: 18px;
}

.sidebar.collapsed .theme-toggle {
    width: 40px;
    height: 22px;
}

.sidebar.collapsed .theme-toggle::after {
    width: 16px;
    height: 16px;
}

.sidebar.collapsed .theme-toggle.active::after {
    left: 21px;
}

.sidebar.collapsed .sidebar-collapse-btn {
    padding: 12px !important;
}

/* Container ajustado para sidebar colapsada */
.container.sidebar-collapsed {
    margin-left: 72px;
    width: calc(100% - 72px);
}

/* Transição suave - já definida no início */
.sidebar {
    transition: width 0.3s ease;
}

.container {
    transition: margin-left var(--transition-slow), width var(--transition-slow);
}

/* Container ajustado para sidebar */
.container {
    margin-left: 260px;
    width: calc(100% - 260px);
    max-width: none;
    padding: 32px;
    background: var(--light-bg);
    min-height: 100vh;
}

/* Animação de entrada suave para seções */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alerts-section,
.table-section-andamento,
.table-section-despachados,
.table-section-finalizados {
    animation: fadeInUp 0.5s ease forwards;
}

.alerts-section {
    animation-delay: 0.1s;
}

.table-section-andamento {
    animation-delay: 0.2s;
}

.table-section-despachados {
    animation-delay: 0.3s;
}

.table-section-finalizados {
    animation-delay: 0.4s;
}

/* Botão Menu Mobile (hambúrguer) */
.menu-toggle {
    display: none;
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1001;
    background: var(--primary-color);
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 8px;
    cursor: pointer;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 6px;
    padding: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.menu-toggle:hover {
    background: var(--primary-dark);
    transform: scale(1.05);
}

.menu-toggle span {
    display: block;
    width: 25px;
    height: 3px;
    background: white;
    border-radius: 2px;
    transition: all 0.3s ease;
}

.btn-lote,
.btn-export,
.btn-import,
.btn-limpar {
    background-color: var(--white);
    color: var(--primary-color);
    padding: 10px 20px;
    font-size: 0.95rem;
    font-weight: 600;
    border: 2px solid var(--white);
    transition: all 0.3s ease;
}

.btn-limpar {
    background-color: var(--danger-color);
    color: var(--white);
    border-color: var(--danger-color);
}

.btn-limpar:hover {
    background-color: #b91c1c !important;
    color: var(--white) !important;
    border-color: #b91c1c !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4) !important;
}

/* Hover para botões no header */
.btn-header-action:hover,
.header-actions .btn-export:hover,
.header-actions .btn-import:hover {
    background-color: #ffffff !important;
    color: #1e40af !important;
    border-color: #ffffff !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4) !important;
}

/* Hover para botão Cadastro em Lote (dentro de section) */
.btn-lote:hover {
    background-color: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

/* Sections */
section {
    background: var(--white);
    padding: 28px;
    border-radius: var(--radius-xl);
    margin-bottom: 24px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-light);
    transition: all var(--transition-base);
}

section:hover {
    box-shadow: var(--shadow-lg);
}

[data-theme="dark"] section {
    border-color: var(--border-color);
}

/* Utilitários */
.section-title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-title-clean {
    margin: 0;
    border: none;
    padding: 0;
}

.modal-description {
    margin-bottom: 20px;
    color: #64748b;
}

.preview-count {
    margin-top: 10px;
    font-weight: 600;
    color: #1e40af;
}

.help-text {
    color: #64748b;
    margin-top: 5px;
    display: block;
}

/* Importação de Excel no Cadastro em Lote */
.excel-import-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.excel-import-container input[type="file"] {
    padding: 12px;
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    background: #f8fafc;
    cursor: pointer;
    transition: all 0.2s ease;
}

.excel-import-container input[type="file"]:hover {
    border-color: #1e40af;
    background: #eff6ff;
}

.divisor-ou {
    display: flex;
    align-items: center;
    text-align: center;
    margin: 16px 0;
    color: #94a3b8;
    font-size: 0.85rem;
}

.divisor-ou::before,
.divisor-ou::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid #e2e8f0;
}

.divisor-ou span {
    padding: 0 12px;
}

.spacer {
    flex: 1;
}

.hidden {
    display: none;
}

/* Painel de Alertas */
.alerts-section {
    background: var(--white);
    border: none;
    animation: fadeIn 0.5s ease;
    padding: 24px;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
}

.alerts-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 50%, var(--primary-color) 100%);
}

.alerts-section h2 {
    font-family: 'Montserrat', sans-serif;
    color: var(--primary-color);
    border-bottom: 2px solid var(--border-light);
    padding-bottom: 12px;
    margin-bottom: 20px;
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alerts-grid {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-top: 16px;
}

.alerts-row {
    display: flex;
    gap: 14px;
    width: 100%;
}

.alert-card {
    background: var(--white);
    padding: 18px 22px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: var(--shadow);
    transition: all var(--transition-base);
    border-left: 4px solid var(--border-light);
    flex: 1;
    position: relative;
    overflow: hidden;
}

.alert-card::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 100px;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.5) 100%);
    pointer-events: none;
    opacity: 0;
    transition: opacity var(--transition-base);
}

.alert-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.alert-card:hover::after {
    opacity: 1;
}

[data-theme="dark"] .alert-card::after {
    background: linear-gradient(90deg, transparent 0%, rgba(30, 58, 95, 0.3) 100%);
}

.alert-clickable {
    cursor: pointer;
    user-select: none;
}

.alert-clickable:active {
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.alert-link {
    font-size: 0.75rem;
    color: #1e40af;
    font-weight: 600;
    text-decoration: none;
    white-space: nowrap;
    margin-left: auto;
}

.alert-link:hover {
    text-decoration: underline;
}

.alert-icon {
    font-size: 1.5rem;
    line-height: 1;
    min-width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-lg);
    background: var(--border-light);
    transition: all var(--transition-base);
    position: relative;
}

.alert-card:hover .alert-icon {
    transform: scale(1.05);
}

.alert-critical {
    border-left-color: var(--danger-color);
    background: linear-gradient(135deg, var(--white) 0%, #fef2f2 100%);
}

.alert-critical .alert-icon {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: var(--danger-color);
    box-shadow: 0 4px 12px rgba(185, 28, 28, 0.15);
}

.alert-warning {
    border-left-color: var(--warning-color);
    background: linear-gradient(135deg, var(--white) 0%, #fffbeb 100%);
}

.alert-warning .alert-icon {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: var(--warning-color);
    box-shadow: 0 4px 12px rgba(217, 119, 6, 0.15);
}

.alert-priority {
    border-left-color: #7c3aed;
    background: linear-gradient(135deg, var(--white) 0%, #f5f3ff 100%);
}

.alert-priority .alert-icon {
    background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    color: #7c3aed;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
}

.alert-success {
    border-left-color: var(--success-color);
    background: linear-gradient(135deg, var(--white) 0%, #ecfdf5 100%);
}

.alert-success .alert-icon {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: var(--success-color);
    box-shadow: 0 4px 12px rgba(4, 120, 87, 0.15);
}

.alert-target {
    border-left-color: var(--accent-color);
    background: linear-gradient(135deg, var(--white) 0%, #fefce8 100%);
}

.alert-target .alert-icon {
    background: linear-gradient(135deg, #fef9c3 0%, #fde047 100%);
    color: var(--accent-dark);
    box-shadow: 0 4px 12px rgba(184, 134, 11, 0.2);
}

[data-theme="dark"] .alert-critical {
    background: linear-gradient(135deg, var(--white) 0%, rgba(185, 28, 28, 0.1) 100%);
}

[data-theme="dark"] .alert-warning {
    background: linear-gradient(135deg, var(--white) 0%, rgba(217, 119, 6, 0.1) 100%);
}

[data-theme="dark"] .alert-priority {
    background: linear-gradient(135deg, var(--white) 0%, rgba(124, 58, 237, 0.1) 100%);
}

[data-theme="dark"] .alert-success {
    background: linear-gradient(135deg, var(--white) 0%, rgba(4, 120, 87, 0.1) 100%);
}

[data-theme="dark"] .alert-target {
    background: linear-gradient(135deg, var(--white) 0%, rgba(184, 134, 11, 0.1) 100%);
}

.alert-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
}

.alert-content h3 {
    font-family: 'Montserrat', sans-serif;
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-light);
    font-weight: 600;
}

.alert-number {
    font-size: 1.8rem;
    font-weight: 700;
    margin: 0;
    line-height: 1;
}

.alert-critical .alert-number {
    color: #dc2626;
}

.alert-warning .alert-number {
    color: #f59e0b;
}

.alert-priority .alert-number {
    color: #8b5cf6;
}

.alert-success .alert-number {
    color: #16a34a;
}

.alert-target .alert-number {
    color: #3b82f6;
}

.alert-desc {
    font-size: 0.75rem;
    color: var(--text-light);
    margin: 0;
}

.alert-card-full {
    width: 100%;
}

.alert-meta {
    font-size: 0.75rem;
    color: var(--text-light);
    margin: 5px 0 0 0;
    font-weight: 600;
}

/* Barra de Progresso */
.progress-bar-container {
    width: 100%;
    margin-top: 12px;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #16a34a, #22c55e);
    border-radius: 10px;
    transition: width 0.5s ease;
    width: 0%;
}

.progress-text {
    font-size: 0.75rem;
    color: #64748b;
    margin: 4px 0 0 0;
    font-weight: 600;
}

.progress-detail {
    font-size: 0.7rem;
    color: #64748b;
    margin: 2px 0 0 0;
    font-weight: 500;
    line-height: 1.4;
}

/* Meta do Mês - Número Grande Dinâmico (Versão Elegante) */
.meta-number-big {
    font-size: 3rem;
    font-weight: 600;
    line-height: 1.1;
    margin: 10px 0 6px 0;
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 6px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    letter-spacing: -0.02em;
}

.meta-number-big span {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.meta-separator {
    color: #cbd5e1;
    font-weight: 300;
    font-size: 2.5rem;
    opacity: 0.5;
}

.meta-subtitle {
    font-size: 0.85rem;
    color: #94a3b8;
    margin: 0 0 14px 0;
    font-weight: 400;
    text-align: center;
    letter-spacing: 0.02em;
}

/* Layout Horizontal - Opção 2 */
.meta-details-horizontal {
    margin-top: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
}

.meta-stat {
    display: flex;
    align-items: center;
    gap: 8px;
}

.meta-stat-clickable {
    text-decoration: none;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.meta-stat-clickable:hover {
    background-color: rgba(0, 0, 0, 0.03);
    transform: translateY(-2px);
}

.meta-stat-clickable:active {
    transform: translateY(0);
}

.meta-stat-clickable::after {
    content: '→';
    position: absolute;
    right: -6px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    color: #94a3b8;
}

.meta-stat-clickable:hover::after {
    opacity: 1;
    right: -12px;
}

.meta-stat-icon {
    font-size: 1.3rem;
    line-height: 1;
}

.meta-stat-done .meta-stat-icon {
    filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.3));
}

.meta-stat-pending .meta-stat-icon {
    filter: drop-shadow(0 2px 4px rgba(245, 158, 11, 0.3));
}

.meta-stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.meta-stat-done .meta-stat-number {
    color: #10b981;
}

.meta-stat-pending .meta-stat-number {
    color: #f59e0b;
}

.meta-stat-label {
    font-size: 0.85rem;
    color: #64748b;
    font-weight: 500;
    letter-spacing: 0.01em;
}

.meta-stat-separator {
    font-size: 1.2rem;
    color: #cbd5e1;
    opacity: 0.5;
    font-weight: 300;
}

/* Cores dinâmicas baseadas no progresso - versão suave */
.meta-progress-low #meta-finalizados {
    color: #ef4444;
    text-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
}

.meta-progress-medium #meta-finalizados {
    color: #f59e0b;
    text-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
}

.meta-progress-high #meta-finalizados {
    color: #10b981;
    text-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
}

/* Barra de progresso com cores suaves */
.meta-progress-low .progress-fill {
    background: linear-gradient(90deg, #f87171, #fca5a5);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
}

.meta-progress-medium .progress-fill {
    background: linear-gradient(90deg, #fbbf24, #fcd34d);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
}

.meta-progress-high .progress-fill {
    background: linear-gradient(90deg, #34d399, #6ee7b7);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
}

/* Animação suave de mudança */
@keyframes metaPulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
}

.meta-number-big span:first-child {
    animation: metaPulse 2s ease-in-out infinite;
}

/* Melhorar aparência geral do card Meta */
.alert-target {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.alert-target:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

/* Estilo mais suave para a barra de progresso */
.progress-bar {
    background: #f1f5f9;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
}

.progress-fill {
    border-radius: 10px;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.progress-text {
    font-size: 0.8rem;
    color: #64748b;
    margin: 6px 0 0 0;
    font-weight: 600;
    letter-spacing: 0.03em;
}

section h2 {
    font-family: 'Montserrat', sans-serif;
    color: var(--primary-color);
    margin-bottom: 20px;
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    border-bottom: 3px solid transparent;
    border-image: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%) 1;
    padding-bottom: 12px;
    position: relative;
}

/* Título clicável para expandir/recolher */
.section-title-toggle {
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: color 0.2s ease;
}

.section-title-toggle:hover {
    color: #3b82f6;
}

.section-title-toggle .toggle-icon {
    font-size: 0.9rem;
    transition: transform 0.3s ease;
    display: inline-block;
}

.section-title-toggle.active .toggle-icon {
    transform: rotate(90deg);
}

/* Formulários */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

label {
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-medium);
    font-size: 0.875rem;
    letter-spacing: -0.01em;
}

input[type="text"],
input[type="date"],
select,
textarea {
    padding: 12px 14px;
    border: 2px solid var(--border-light);
    border-radius: var(--radius-md);
    font-size: 0.95rem;
    transition: all var(--transition-base);
    font-family: inherit;
    background: var(--white);
    color: var(--text-dark);
}

input[type="text"]:hover,
input[type="date"]:hover,
select:hover,
textarea:hover {
    border-color: var(--border-color);
}

input[type="text"]:focus,
input[type="date"]:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(30, 58, 95, 0.1);
}

textarea {
    resize: vertical;
    min-height: 80px;
}

/* Dark mode inputs */
[data-theme="dark"] input[type="text"],
[data-theme="dark"] input[type="date"],
[data-theme="dark"] select,
[data-theme="dark"] textarea {
    background: var(--primary-dark);
    border-color: var(--border-color);
}

[data-theme="dark"] input[type="text"]:focus,
[data-theme="dark"] input[type="date"]:focus,
[data-theme="dark"] select:focus,
[data-theme="dark"] textarea:focus {
    box-shadow: 0 0 0 4px rgba(59, 110, 165, 0.2);
}

/* Botões */
.btn {
    font-family: 'Montserrat', sans-serif;
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius-md);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-base);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
    letter-spacing: -0.01em;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
    transition: left 0.5s ease;
}

.btn:hover::before {
    left: 100%;
}

.btn:active {
    transform: scale(0.98);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    color: white;
    box-shadow: var(--shadow), 0 4px 12px rgba(30, 58, 95, 0.2);
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg), 0 6px 20px rgba(30, 58, 95, 0.25);
}

.btn-secondary {
    background: linear-gradient(135deg, var(--secondary-color) 0%, #64748b 100%);
    color: white;
    box-shadow: var(--shadow);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #475569 0%, var(--secondary-color) 100%);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-cancel {
    background-color: #f97316 !important;
    color: var(--white) !important;
    font-size: 1rem !important;
    font-weight: 600 !important;
    padding: 12px 24px !important;
    border: none !important;
    border-radius: 8px !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
}

.btn-cancel:hover {
    background-color: #ea580c !important;
    transform: translateY(-2px) !important;
    box-shadow: var(--shadow-lg) !important;
}

.btn-danger {
    background-color: var(--danger-color);
    color: var(--white);
    padding: 6px 10px;
    font-size: 0.8rem;
    width: 100%;
    text-align: center;
}

.btn-danger:hover {
    background-color: #b91c1c;
    transform: translateY(-1px);
}

.btn-edit {
    background-color: #3b82f6;
    color: var(--white);
    padding: 6px 10px;
    font-size: 0.8rem;
    width: 100%;
    text-align: center;
}

.btn-edit:hover {
    background-color: #2563eb;
    transform: translateY(-1px);
}

.btn-historico {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: var(--white);
    padding: 6px 10px;
    font-size: 0.8rem;
    width: 100%;
    text-align: center;
    border: none;
}

.btn-historico:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-success {
    background-color: var(--success-color);
    color: var(--white);
    padding: 6px 10px;
    font-size: 0.8rem;
    width: 100%;
    text-align: center;
}

.btn-success:hover {
    background-color: #15803d;
    transform: translateY(-1px);
}

.btn-warning {
    background-color: var(--warning-color);
    color: var(--white);
    padding: 6px 10px;
    font-size: 0.8rem;
    width: 100%;
    text-align: center;
}

.btn-warning:hover {
    background-color: #c2410c;
    transform: translateY(-1px);
}

.btn-despachar {
    background-color: #f59e0b;
    color: var(--white);
    padding: 6px 10px;
    font-size: 0.8rem;
    width: 100%;
    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.btn-despachar:hover {
    background-color: #d97706;
    transform: translateY(-1px);
}

.btn-return {
    background-color: #8b5cf6;
    color: var(--white);
    padding: 6px 10px;
    font-size: 0.8rem;
    width: 100%;
    text-align: center;
}

.btn-return:hover {
    background-color: #7c3aed;
    transform: translateY(-1px);
}

.btn-pdf {
    background-color: #8b5cf6;
    color: var(--white);
    padding: 10px 18px;
    font-size: 0.95rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-pdf:hover {
    background-color: #7c3aed;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-producao {
    background-color: #059669;
    color: var(--white);
}

.btn-producao:hover {
    background-color: #059669;
    color: var(--white);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
}

/* Cards de Produção */
.producao-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.producao-card {
    background: var(--white);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 5px solid;
}

.producao-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.producao-despachados {
    border-left-color: #f59e0b;
    background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
}

.producao-finalizados {
    border-left-color: #16a34a;
    background: linear-gradient(135deg, #ffffff 0%, #d1fae5 100%);
}

.producao-total {
    border-left-color: #1e40af;
    background: linear-gradient(135deg, #ffffff 0%, #dbeafe 100%);
}

.producao-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.producao-info h4 {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    color: #64748b;
    margin: 0 0 10px 0;
    font-weight: 600;
}

.producao-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    color: var(--primary-color);
}

.form-actions {
    display: flex;
    gap: 15px;
    margin-top: 25px;
}


/* Lista de Processos */
.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 15px;
}

.list-header h2 {
    margin: 0;
}

/* Container para campo de busca com botão X */
.busca-wrapper {
    position: relative;
    min-width: 300px;
    max-width: 400px;
    display: flex;
    align-items: center;
}

.busca-integrada {
    padding: 10px 40px 10px 16px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    font-family: inherit;
    width: 100%;
}

.busca-integrada:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

/* Botão X para limpar busca */
.busca-clear-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 4px 8px;
    line-height: 1;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: none;
    opacity: 0;
}

.busca-clear-btn.visible {
    display: block;
    opacity: 1;
}

.busca-clear-btn:hover {
    color: var(--danger-color);
    background-color: rgba(220, 38, 38, 0.1);
}

/* Seções de Processos */
.table-section-andamento {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 22px;
    border-radius: var(--radius-xl);
    margin-bottom: 24px;
    border: 2px solid var(--primary-color);
    box-shadow: var(--shadow-lg), 0 0 0 1px rgba(30, 58, 95, 0.05);
    position: relative;
    overflow: hidden;
}

.table-section-andamento::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
}

.table-section-despachados {
    background: var(--white);
    padding: 22px;
    border-radius: var(--radius-xl);
    margin-bottom: 24px;
    border: 2px solid var(--warning-color);
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
}

.table-section-despachados::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--warning-color) 0%, #fbbf24 100%);
}

.table-section-finalizados {
    background: var(--white);
    padding: 22px;
    border-radius: var(--radius-xl);
    margin-bottom: 24px;
    border: 2px solid var(--success-color);
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
}

.table-section-finalizados::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--success-color) 0%, #34d399 100%);
}

.table-section-title {
    font-family: 'Montserrat', sans-serif;
    color: var(--text-dark);
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0 0 18px 0;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border-light);
    letter-spacing: -0.01em;
    display: flex;
    align-items: center;
    gap: 10px;
}

[data-theme="dark"] .table-section-andamento {
    background: linear-gradient(135deg, var(--white) 0%, rgba(30, 58, 95, 0.1) 100%);
}

[data-theme="dark"] .table-section-despachados,
[data-theme="dark"] .table-section-finalizados {
    background: var(--white);
}

.table-header-with-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.btn-toggle {
    background-color: transparent;
    color: #64748b;
    border: none;
    width: 24px;
    height: 24px;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
    padding: 0;
}

.btn-toggle:hover {
    color: #1e293b;
    transform: scale(1.15);
}

.table-responsive.collapsed {
    display: none;
}

.table-section-andamento .table-section-title {
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stats {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.stat-item {
    background-color: var(--light-bg);
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    color: var(--text-light);
}

.stat-item strong {
    color: var(--primary-color);
    font-size: 1.1rem;
}

/* Tabela */
.table-responsive {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 900px;
    table-layout: auto;
}

thead {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    color: white;
}

th {
    font-family: 'Montserrat', sans-serif;
    padding: 14px 12px;
    text-align: center !important;
    font-weight: 600;
    font-size: 0.8rem;
    vertical-align: middle;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    position: relative;
}

th:first-child {
    border-radius: var(--radius-md) 0 0 0;
}

th:last-child {
    border-radius: 0 var(--radius-md) 0 0;
}

th.sortable {
    cursor: pointer;
    user-select: none;
    transition: all var(--transition-base);
    position: relative;
    padding-right: 22px;
}

th.sortable:hover {
    background: rgba(0, 0, 0, 0.15);
}

.sort-indicator {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.75rem;
    color: var(--accent-light);
    font-weight: bold;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

td {
    padding: 12px 10px;
    border-bottom: 1px solid var(--border-light);
    text-align: center;
    font-size: 0.85rem;
    line-height: 1.5;
    transition: background-color var(--transition-fast);
}

tbody tr {
    transition: all var(--transition-fast);
}

tbody tr:hover {
    background-color: rgba(30, 58, 95, 0.04);
}

tbody tr:hover td {
    border-bottom-color: var(--border-color);
}

[data-theme="dark"] tbody tr:hover {
    background-color: rgba(59, 110, 165, 0.1);
}

tbody tr {
    transition: background-color 0.2s ease;
    position: relative;
}

tbody tr:hover {
    background-color: var(--light-bg);
    z-index: 1;
}

.empty-state {
    text-align: center;
    color: var(--text-light);
    font-style: italic;
}

.text-center {
    text-align: center;
}

/* Status Badges */
.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
}

.status-aguardando-despacho {
    background-color: #e0e7ff;
    color: #4f46e5;
}

.status-concluso {
    background-color: #fce7f3;
    color: #db2777;
}

.status-despachado {
    background-color: #d1fae5;
    color: #059669;
}

.status-finalizado {
    background-color: #e0e7ff;
    color: #4f46e5;
}

/* Dias Conclusos Badges */
.dias-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    text-align: center;
}

.dias-normal {
    background-color: #d1fae5;
    color: #047857;
    border: 2px solid #10b981;
}

.dias-atencao {
    background-color: #fef3c7;
    color: #d97706;
    border: 2px solid #f59e0b;
}

.dias-critico {
    background-color: #fee2e2;
    color: #dc2626;
    border: 2px solid #dc2626;
    animation: pulseDias 2s ease-in-out infinite;
}

@keyframes pulseDias {
    0%, 100% {
        background-color: #fee2e2;
    }
    50% {
        background-color: #fecaca;
    }
}

/* Prioridade Badges */
.prioridade-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-xs);
}

.prioridade-normal {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    color: var(--text-medium);
    border: 1px solid var(--border-light);
}

.prioridade-urgente {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border: 1px solid #fcd34d;
    box-shadow: 0 2px 8px rgba(217, 119, 6, 0.15);
}

.prioridade-muito-urgente {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: var(--danger-color);
    border: 1px solid #fca5a5;
    box-shadow: 0 2px 8px rgba(185, 28, 28, 0.15);
    animation: urgentPulse 2s ease-in-out infinite;
}

@keyframes urgentPulse {
    0%, 100% { box-shadow: 0 2px 8px rgba(185, 28, 28, 0.15); }
    50% { box-shadow: 0 2px 12px rgba(185, 28, 28, 0.3); }
}

.prioridade-prioridade-advogado {
    background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    color: #6d28d9;
    border: 1px solid #c4b5fd;
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.15);
}

[data-theme="dark"] .prioridade-normal {
    background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
    border-color: var(--border-color);
}

[data-theme="dark"] .prioridade-urgente {
    background: linear-gradient(135deg, rgba(217, 119, 6, 0.3) 0%, rgba(217, 119, 6, 0.2) 100%);
}

[data-theme="dark"] .prioridade-muito-urgente {
    background: linear-gradient(135deg, rgba(185, 28, 28, 0.3) 0%, rgba(185, 28, 28, 0.2) 100%);
}

[data-theme="dark"] .prioridade-prioridade-advogado {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.3) 0%, rgba(124, 58, 237, 0.2) 100%);
}

/* Actions - Layout horizontal com botões pill compactos */
.action-buttons {
    display: flex;
    flex-direction: row;
    gap: 6px;
    align-items: center;
    justify-content: center;
}

.action-buttons .btn {
    width: 44px;
    height: 32px;
    padding: 0;
    border-radius: 20px;
    font-size: 1.2rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    flex-shrink: 0;
}

/* Layout horizontal para processos finalizados (apenas Reabrir + Editar) */
.action-buttons-horizontal {
    display: flex;
    flex-direction: row;
    gap: 6px;
}

.action-buttons-horizontal .btn {
    width: 44px;
    height: 32px;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    animation: fadeIn 0.3s ease;
}

[data-theme="dark"] .modal {
    background-color: rgba(0, 0, 0, 0.75);
}

/* Modal de Relatório sobreposto */
#modal-relatorio {
    z-index: 1002;
}

.modal.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: var(--white);
    border-radius: var(--radius-xl);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl), 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--border-light);
}

.modal-large {
    max-width: 1000px;
}

.modal-compact {
    max-width: 400px;
    width: 90%;
}

/* ============================================
   DESIGN 2 - HEADER GRADIENTE INSTITUCIONAL
   ============================================ */

.modal-header {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    padding: 28px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: none;
    position: relative;
    overflow: hidden;
}

.modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    pointer-events: none;
}

.modal-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-color) 0%, var(--accent-light) 100%);
}

.modal-header h2 {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: white;
    margin: 0;
    border: none;
    padding: 0;
}

.modal-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 38px;
    height: 38px;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
}

.modal-close-btn svg {
    width: 20px;
    height: 20px;
}

.modal-body {
    padding: 30px;
}

.modal-body .form-group {
    margin-bottom: 24px;
}

.modal-body .form-group label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 10px;
}

.modal-body .form-group input,
.modal-body .form-group select,
.modal-body .form-group textarea {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.2s ease;
    font-family: 'Montserrat', sans-serif;
}

.modal-body .form-group input:focus,
.modal-body .form-group select:focus,
.modal-body .form-group textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
}

.modal-body .form-group input::placeholder {
    color: #9ca3af;
}

.modal-footer {
    padding: 24px 30px;
    background: linear-gradient(to top, #f8fafc, #ffffff);
    display: flex;
    gap: 14px;
    justify-content: center;
    border-top: 1px solid #e5e7eb;
}

.modal-footer .btn-modal {
    padding: 14px 32px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
    border: none;
    font-family: 'Montserrat', sans-serif;
}

.modal-footer .btn-modal svg {
    width: 18px;
    height: 18px;
}

.modal-footer .btn-modal.primary {
    background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
    color: white;
    box-shadow: 0 4px 14px rgba(22, 163, 74, 0.3);
}

.modal-footer .btn-modal.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(22, 163, 74, 0.4);
}

.modal-footer .btn-modal.secondary {
    background: #f1f5f9;
    color: #475569;
}

.modal-footer .btn-modal.secondary:hover {
    background: #e2e8f0;
}

/* Manter compatibilidade com modal-actions existente */
.modal-actions {
    padding: 24px 30px;
    background: linear-gradient(to top, #f8fafc, #ffffff);
    display: flex;
    gap: 14px;
    justify-content: center;
    border-top: 1px solid #e5e7eb;
    margin-top: 0;
}

.modal-actions .btn-acao-padronizado {
    padding: 14px 32px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
}

.modal-actions .btn-acao-padronizado.success {
    background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
    box-shadow: 0 4px 14px rgba(22, 163, 74, 0.3);
}

.modal-actions .btn-acao-padronizado.success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(22, 163, 74, 0.4);
}

.modal-actions .btn-acao-padronizado.secondary {
    background: #f1f5f9;
    color: #475569;
}

.modal-actions .btn-acao-padronizado.secondary:hover {
    background: #e2e8f0;
    transform: none;
    box-shadow: none;
}

/* Footer */
footer {
    text-align: center;
    padding: 20px;
    color: var(--text-light);
    margin-top: auto;
}

/* Animações */
@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}

/* Acessibilidade */
*:focus-visible {
    outline: 3px solid var(--primary-color);
    outline-offset: 2px;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* Responsividade */
@media (max-width: 768px) {
    /* Sidebar responsiva - esconder em mobile */
    .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }

    .sidebar.show {
        transform: translateX(0);
    }

    /* Reset do estado colapsado em mobile */
    .sidebar.collapsed {
        width: 260px;
    }

    .sidebar.collapsed .sidebar-header-text,
    .sidebar.collapsed .sidebar-section-title,
    .sidebar.collapsed .sidebar-text,
    .sidebar.collapsed .sidebar-action-text {
        display: block;
    }

    .sidebar.collapsed .sidebar-header {
        padding: 24px 20px;
        justify-content: flex-start;
    }

    .sidebar.collapsed .sidebar-btn {
        padding: 10px 20px;
        justify-content: flex-start;
        margin: 0;
        width: 100%;
        border-radius: 0;
    }

    .sidebar.collapsed .sidebar-nav-item.active {
        margin: 0 12px;
        width: calc(100% - 24px);
        border-radius: 8px;
    }

    .sidebar.collapsed .sidebar-action-buttons {
        grid-template-columns: 1fr 1fr;
        padding: 0 16px 20px 16px;
        gap: 10px;
    }

    .sidebar.collapsed .sidebar-action-btn {
        padding: 14px 8px;
    }

    .sidebar.collapsed .sidebar-badge {
        position: static;
        font-size: 0.75rem;
        padding: 2px 10px;
        min-width: 24px;
    }

    .sidebar.collapsed .sidebar-collapse-icon svg {
        transform: none;
    }

    /* Esconder botão recolher em mobile */
    .sidebar-footer {
        display: none;
    }

    /* Mostrar botão hambúrguer em mobile */
    .menu-toggle {
        display: flex;
    }

    /* Container ocupa toda largura em mobile */
    .container {
        margin-left: 0;
        width: 100%;
        padding: 10px;
        padding-top: 80px; /* Espaço para o botão hambúrguer */
    }

    .container.sidebar-collapsed {
        margin-left: 0;
        width: 100%;
    }

    .sidebar-title {
        font-size: 1rem;
    }

    section {
        padding: 20px;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .form-actions {
        flex-direction: column;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }

    .list-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .busca-wrapper {
        width: 100%;
        min-width: auto;
        max-width: none;
    }

    .busca-integrada {
        width: 100%;
    }

    .stats {
        width: 100%;
        flex-direction: column;
        gap: 10px;
    }

    table {
        font-size: 0.9rem;
    }

    th, td {
        padding: 10px;
    }

    .action-buttons {
        min-width: 100px;
    }

    .modal-content {
        width: 95%;
    }

    .modal-body {
        padding: 20px;
    }

    /* Alertas responsivos */
    .alerts-row {
        flex-direction: column;
    }

    .alert-card {
        width: 100%;
    }

    .alert-icon {
        min-width: 45px;
        height: 45px;
        font-size: 1.5rem;
    }

    .alert-number {
        font-size: 1.5rem;
    }

    .alert-link {
        font-size: 0.7rem;
    }

    .progress-bar {
        height: 16px;
    }

    .progress-text {
        font-size: 0.7rem;
    }

    /* Botão PDF responsivo */
    .btn-pdf {
        font-size: 0.85rem;
        padding: 8px 14px;
    }

    /* Header com botão PDF */
    .table-header-with-toggle > div {
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .table-header-with-toggle .btn-pdf {
        width: 100%;
    }
}

/* Link do número do processo */
.processo-link {
    color: var(--primary-color);
    text-decoration: none;
    transition: color 0.2s ease;
    cursor: pointer;
}

.processo-link:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

/* Botão copiar */
.btn-copiar {
    background-color: #e2e8f0;
    border: none;
    border-radius: 6px;
    width: 28px;
    height: 28px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.btn-copiar:hover {
    background-color: var(--primary-color);
    transform: scale(1.1);
}

.btn-copiar:active {
    transform: scale(0.95);
}

/* Coluna Fixa */
.col-numero {
    position: sticky;
    left: 0;
    background-color: var(--primary-color);
    z-index: 10;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
}

tbody td:first-child {
    position: sticky;
    left: 0;
    background-color: var(--white);
    z-index: 5;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
    overflow: visible;
}

tbody tr:hover td:first-child {
    z-index: 1002;
}

tbody tr:hover td:first-child {
    background-color: var(--light-bg);
}

/* Modal de observações */
.obs-info {
    background-color: var(--light-bg);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

/* Info box */
.info-box {
    background-color: #eff6ff;
    border-left: 4px solid #3b82f6;
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
}

.info-box p {
    margin: 5px 0;
    font-size: 0.95rem;
    color: #334155;
}

.info-box strong {
    color: #1e40af;
}

/* Configurações */
.config-section {
    margin-bottom: 20px;
}

.config-section-title {
    font-family: 'Montserrat', sans-serif;
    color: var(--primary-color);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
}

.config-section .form-group {
    margin-bottom: 20px;
}

.config-section .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #334155;
}

.config-section .form-group input[type="number"] {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.config-section .form-group input[type="number"]:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.obs-info p {
    margin: 5px 0;
}

.obs-content {
    margin-top: 20px;
}

.obs-content h3 {
    font-family: 'Montserrat', sans-serif;
    color: var(--primary-color);
    font-size: 1.1rem;
    margin-bottom: 10px;
}

.obs-content p {
    background-color: var(--light-bg);
    padding: 15px;
    border-radius: 8px;
    min-height: 80px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Tooltip personalizado para observações - sempre à direita */
.processo-numero-wrapper {
    position: relative;
    display: inline-block;
}

.tooltip-observacoes {
    visibility: hidden;
    opacity: 0;
    position: fixed;
    background-color: #1e293b;
    color: #ffffff;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.85rem;
    line-height: 1.5;
    white-space: normal;
    max-width: 320px;
    min-width: 220px;
    z-index: 9999;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    transition: opacity 0.3s ease, visibility 0.3s ease;
    pointer-events: none;
    word-wrap: break-word;
}

/* Seta apontando para a esquerda */
.tooltip-observacoes::after {
    content: "";
    position: absolute;
    right: 100%;
    top: 50%;
    transform: translateY(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: transparent #1e293b transparent transparent;
}

.tooltip-observacoes.sem-observacoes {
    background-color: #64748b;
    font-style: italic;
}

.tooltip-observacoes.sem-observacoes::after {
    border-color: transparent #64748b transparent transparent;
}

/* Formulário Recolhível - Opção 3 */
.form-toggle-container {
    width: 100%;
}

.form-toggle-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.form-toggle-button {
    flex: 1;
    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 20px 30px;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.form-toggle-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
}

.form-toggle-button:hover::before {
    left: 100%;
}

.form-toggle-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

.form-toggle-button:active {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.form-toggle-button.active {
    background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
}

.form-toggle-icon {
    font-size: 1.5rem;
    transition: transform 0.3s ease;
}

.form-toggle-button.active .form-toggle-icon {
    transform: rotate(45deg);
}

.form-toggle-text {
    font-size: 1.2rem;
    letter-spacing: 0.5px;
}

.form-wrapper {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-wrapper.open {
    max-height: 2000px;
}

.form-container-collapsible {
    padding-top: 10px;
}

.info-message {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-left: 4px solid #3b82f6;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 25px;
    font-size: 0.95rem;
    color: #1e40af;
    display: none;
    animation: slideIn 0.4s ease;
}

.info-message.show {
    display: block;
}

.info-message strong {
    font-weight: 700;
    margin-right: 5px;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Ajuste para o botão Cadastro em Lote na header */
.form-toggle-header .btn-lote {
    flex-shrink: 0;
    white-space: nowrap;
}

/* Sistema de Abas para Processos Finalizados */
.finalizados-filter-container {
    margin-bottom: 20px;
}

.finalizados-year-selector {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
}

.finalizados-year-selector label {
    font-weight: 600;
    color: #475569;
    margin: 0;
    font-size: 0.95rem;
}

.finalizados-year-select {
    padding: 8px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 600;
    color: #1e40af;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.finalizados-year-select:hover {
    border-color: #1e40af;
}

.finalizados-year-select:focus {
    outline: none;
    border-color: #1e40af;
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.finalizados-tabs-container {
    border-bottom: 2px solid #e2e8f0;
    margin-bottom: 20px;
}

.finalizados-tabs {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    padding: 0 4px;
}

.finalizados-tab {
    padding: 12px 20px;
    background: #f1f5f9;
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    color: #64748b;
    transition: all 0.3s ease;
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 3px solid transparent;
}

.finalizados-tab:hover {
    background: #e2e8f0;
    color: #475569;
}

.finalizados-tab.active {
    background: white;
    color: #1e40af;
    border-bottom-color: #1e40af;
}

.finalizados-tab-badge {
    background: #cbd5e1;
    color: #475569;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    min-width: 24px;
    text-align: center;
}

.finalizados-tab.active .finalizados-tab-badge {
    background: #1e40af;
    color: white;
}

.finalizados-dropdown {
    position: relative;
    display: inline-block;
}

.finalizados-dropdown-button {
    padding: 12px 20px;
    background: #f1f5f9;
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    color: #64748b;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 3px solid transparent;
}

.finalizados-dropdown-button:hover {
    background: #e2e8f0;
    color: #475569;
}

.finalizados-dropdown-button.active {
    background: white;
    color: #1e40af;
    border-bottom-color: #1e40af;
}

.finalizados-dropdown-icon {
    font-size: 0.7rem;
    transition: transform 0.3s ease;
}

.finalizados-dropdown.open .finalizados-dropdown-icon {
    transform: rotate(180deg);
}

.finalizados-dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    min-width: 200px;
    z-index: 1000;
    margin-top: 4px;
    max-height: 300px;
    overflow-y: auto;
}

.finalizados-dropdown.open .finalizados-dropdown-menu {
    display: block;
    animation: dropdownSlideIn 0.3s ease;
}

@keyframes dropdownSlideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.finalizados-dropdown-item {
    padding: 10px 16px;
    cursor: pointer;
    transition: background 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #475569;
    border-bottom: 1px solid #f1f5f9;
}

.finalizados-dropdown-item:last-child {
    border-bottom: none;
}

.finalizados-dropdown-item:hover {
    background: #f8fafc;
}

.finalizados-dropdown-item.active {
    background: #dbeafe;
    color: #1e40af;
    font-weight: 600;
}

.finalizados-dropdown-item-badge {
    background: #e2e8f0;
    color: #64748b;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.finalizados-dropdown-item.active .finalizados-dropdown-item-badge {
    background: #1e40af;
    color: white;
}

.finalizados-tab-content {
    display: none;
}

.finalizados-tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.finalizados-info-bar {
    background: #dbeafe;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #1e40af;
}

.finalizados-empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
}

.finalizados-empty-state-icon {
    font-size: 4rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.finalizados-empty-state-text {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 8px;
}

.finalizados-empty-state-subtext {
    font-size: 0.9rem;
    color: #cbd5e1;
}

/* Print Styles */
@media print {
    body {
        background: white;
    }

    .form-section,
    .filter-section,
    .form-actions,
    .action-buttons,
    footer {
        display: none;
    }

    section {
        box-shadow: none;
        page-break-inside: avoid;
    }

    table {
        font-size: 0.85rem;
    }

    /* Esconder controles de abas na impressão */
    .finalizados-year-selector,
    .finalizados-tabs-container {
        display: none !important;
    }
}

/* Loading Indicator */
.loading-indicator {
    text-align: center;
    padding: 20px;
    margin: 20px 0;
}

.loading-indicator p {
    margin-top: 15px;
    color: var(--primary-color);
    font-weight: 600;
    font-size: 0.95rem;
}

.spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* Loading Overlay for Import/Export */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.loading-overlay-content {
    background: var(--white);
    padding: 40px 60px;
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    text-align: center;
}

.loading-overlay-content .spinner {
    width: 50px;
    height: 50px;
    border-width: 5px;
}

.loading-overlay-content p {
    margin-top: 20px;
    color: var(--text-dark);
    font-weight: 600;
    font-size: 1rem;
}
/* Estilos para Gerenciamento de Classes e Assuntos */
.input-with-manage-btn {
    display: flex;
    gap: 10px;
    align-items: stretch;
}

.input-with-manage-btn select {
    flex: 1;
}

.btn-manage {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    transition: all 0.3s;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
}

.btn-manage:hover {
    background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 123, 255, 0.3);
}

.btn-manage-compact {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1em;
    transition: all 0.3s;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    min-width: 45px;
}

.btn-manage-compact:hover {
    background: #2563eb;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
}

.input-with-add-btn {
    display: flex;
    gap: 10px;
    align-items: stretch;
    margin-bottom: 20px;
}

.input-with-add-btn input {
    flex: 1;
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1em;
    transition: all 0.3s;
}

.input-with-add-btn input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.btn-add {
    background: #28a745;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1em;
    transition: all 0.3s;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
}

.btn-add:hover {
    background: #218838;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);
}

.items-list-container {
    margin-top: 20px;
}

.items-list-container h3 {
    color: #333;
    margin-bottom: 15px;
    font-size: 1.1em;
    font-weight: 600;
}

.items-list {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    max-height: 400px;
    overflow-y: auto;
}

.item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    margin-bottom: 8px;
    background: white;
    border-radius: 8px;
    border-left: 4px solid #007bff;
    transition: all 0.3s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.item:hover {
    background: #f0f7ff;
    transform: translateX(5px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
}

.item-text {
    font-size: 1em;
    color: #333;
    font-weight: 500;
}

.item-actions {
    display: flex;
    gap: 8px;
}

.btn-delete {
    background: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.3s;
}

.btn-delete:hover {
    background: #c82333;
    transform: scale(1.05);
}

.items-list:empty::after {
    content: "Nenhum item cadastrado ainda.";
    display: block;
    text-align: center;
    color: #999;
    padding: 20px;
    font-style: italic;
}

/* ============================================
   HEATMAP DE PRAZOS - CALENDÁRIO MENSAL
   ============================================ */

/* Botão Heatmap no header */
.btn-heatmap {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    border: none;
    transition: all 0.3s ease;
}

.btn-heatmap:hover {
    background: linear-gradient(135deg, #5568d3 0%, #63408a 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* ============================================
   BOTÕES PADRONIZADOS - PLANEJAMENTO
   ============================================ */

/* Botão X de Fechar - Estilo Circular com Fundo */
.close-btn-padronizado {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.close-btn-padronizado:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
}

.close-btn-padronizado svg {
    width: 18px;
    height: 18px;
}

/* Botões de Ação - Estilo Filled */
.btn-acao-padronizado {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    font-family: 'Montserrat', sans-serif;
}

.btn-acao-padronizado svg {
    width: 18px;
    height: 18px;
}

.btn-acao-padronizado.success {
    background: #16a34a;
    color: white;
}

.btn-acao-padronizado.success:hover {
    background: #15803d;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
}

.btn-acao-padronizado.secondary {
    background: #e2e8f0;
    color: #475569;
}

.btn-acao-padronizado.secondary:hover {
    background: #cbd5e1;
}

.btn-acao-padronizado.primary {
    background: #1e40af;
    color: white;
}

.btn-acao-padronizado.primary:hover {
    background: #1e3a8a;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
}

/* Botões do Calendário - Estilo Chip/Pílula */
.btn-chip-calendario {
    background: rgba(255, 255, 255, 0.95);
    border: none;
    border-radius: 25px;
    padding: 10px 18px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    font-weight: 600;
    font-size: 0.9rem;
    color: #374151;
    font-family: 'Montserrat', sans-serif;
}

.btn-chip-calendario:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
}

.btn-chip-calendario svg {
    width: 18px;
    height: 18px;
}

.btn-chip-calendario.green svg {
    color: #16a34a;
}

.btn-chip-calendario.blue svg {
    color: #1e40af;
}

.btn-chip-calendario.purple svg {
    color: #8b5cf6;
}

.btn-chip-calendario.gray svg {
    color: #64748b;
}

/* Cards de Período - Borda Lateral Colorida */
.periodo-card-padronizado {
    background: #f8fafc;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #1e40af;
}

.periodo-card-padronizado .periodo-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.periodo-card-padronizado .periodo-numero {
    background: #1e40af;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
}

.periodo-card-padronizado .periodo-titulo {
    font-weight: 600;
    color: #374151;
    font-size: 1rem;
}

.periodo-card-padronizado .periodo-campos {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.periodo-card-padronizado .periodo-campos label {
    display: block;
    font-size: 0.85rem;
    color: #64748b;
    margin-bottom: 5px;
    font-weight: 500;
}

.periodo-card-padronizado .periodo-campos input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
}

.periodo-card-padronizado .periodo-campos input:focus {
    outline: none;
    border-color: #1e40af;
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

/* Container dos botões do calendário */
.calendar-config-buttons-padronizado {
    display: flex;
    gap: 12px;
    margin: 15px 0;
    justify-content: center;
    flex-wrap: wrap;
}

/* Modal Heatmap - Tela Cheia */
#modal-heatmap .modal-content {
    max-width: 98vw;
    width: 98vw;
    max-height: 98vh;
    height: 98vh;
    margin: 1vh 1vw;
    display: flex;
    flex-direction: column;
}

#modal-heatmap .modal-body {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    padding: 20px 30px;
}

/* Header do Calendário */
.calendar-header-heatmap {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    color: white;
}

.month-title-heatmap {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.4rem;
    font-weight: 600;
}

.nav-button-heatmap {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.nav-button-heatmap:hover {
    background: rgba(255,255,255,0.3);
}

/* Grid do Calendário */
.calendar-grid-heatmap {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    margin-bottom: 20px;
    flex: 1;
}

/* Cabeçalhos dos dias da semana */
.calendar-day-header-heatmap {
    text-align: center;
    padding: 15px;
    font-weight: 700;
    color: #475569;
    background: #f1f5f9;
    border-radius: 8px;
    font-size: 1rem;
    letter-spacing: 0.5px;
}

.calendar-day-header-heatmap.weekend-header {
    color: #ef4444;
    background: #fef2f2;
}

/* Células dos dias */
.calendar-day-heatmap {
    min-height: 180px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 12px;
    background: white;
    transition: all 0.2s;
    position: relative;
    display: flex;
    flex-direction: column;
}

.calendar-day-heatmap:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    border-color: #cbd5e1;
}

.calendar-day-heatmap.weekend {
    background: #f8fafc;
}

.calendar-day-heatmap.feriado {
    background: #fef9c3;
    border-color: #eab308;
}

.calendar-day-heatmap.ferias {
    background: #dbeafe;
    border-color: #3b82f6;
}

.calendar-day-heatmap.other-month {
    opacity: 0.35;
}

/* Número do dia */
.day-number-heatmap {
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.day-number-heatmap.today {
    background: #667eea;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

/* Item de processo dentro do calendário */
.processo-item-heatmap {
    background: #f0f9ff;
    border-left: 4px solid #0ea5e9;
    padding: 8px 10px;
    margin-bottom: 6px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.processo-item-heatmap:hover {
    background: #dbeafe;
    transform: translateX(3px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.processo-item-heatmap.urgente {
    background: #fef3c7;
    border-left-color: #f59e0b;
}

.processo-item-heatmap.urgente:hover {
    background: #fde68a;
}

.processo-item-heatmap.critico {
    background: #fee2e2;
    border-left-color: #ef4444;
}

.processo-item-heatmap.critico:hover {
    background: #fecaca;
}

.processo-numero-heatmap {
    font-weight: 700;
    color: #0f172a;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 4px;
    font-size: 0.78rem;
}

.btn-copiar-heatmap {
    background: transparent;
    border: none;
    padding: 2px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 3px;
    flex-shrink: 0;
}

.btn-copiar-heatmap svg {
    width: 12px;
    height: 12px;
    color: #94a3b8;
}

.btn-copiar-heatmap:hover svg {
    color: #1e40af;
}

.processo-dias-heatmap {
    color: #64748b;
    font-size: 0.72rem;
    font-weight: 600;
}

/* Drag and Drop - Estilos */
.processo-item-heatmap[draggable="true"] {
    cursor: grab;
    user-select: none;
}

.processo-item-heatmap[draggable="true"]:active {
    cursor: grabbing;
}

.processo-item-heatmap.dragging {
    opacity: 0.5;
    transform: scale(0.95);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.calendar-day-heatmap.drag-over {
    background: #dbeafe !important;
    border: 2px dashed #3b82f6 !important;
    transform: scale(1.02);
}

.calendar-day-heatmap.drag-over.weekend {
    background: #e0f2fe !important;
}

.calendar-day-heatmap.drag-over.feriado,
.calendar-day-heatmap.drag-over.ferias {
    background: #fef3c7 !important;
    border-color: #f59e0b !important;
}

.processo-item-heatmap.customizado {
    border-left-color: #8b5cf6 !important;
    position: relative;
}

.processo-item-heatmap.customizado::after {
    content: '';
    position: absolute;
    top: 4px;
    right: 4px;
    width: 8px;
    height: 8px;
    background: #8b5cf6;
    border-radius: 50%;
}

.drag-ghost {
    position: fixed;
    pointer-events: none;
    z-index: 9999;
    opacity: 0.9;
    transform: rotate(3deg);
}

/* Legenda */
.legenda-heatmap {
    display: flex;
    gap: 20px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 8px;
    flex-wrap: wrap;
    justify-content: center;
}

.legenda-item-heatmap {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.legenda-cor-heatmap {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

/* =====================================================
   MODAL DE HISTÓRICO DO PROCESSO
   ===================================================== */

.modal-historico .modal-body {
    padding: 30px;
    overflow-y: auto;
    max-height: calc(85vh - 100px);
}

/* Corrigir botões do modal de histórico */
#modal-historico .modal-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    padding: 20px 30px;
    border-top: 1px solid #e2e8f0;
    margin-top: 0;
}

#modal-historico .modal-actions .btn {
    flex: 0 0 auto;
    min-width: auto;
    padding: 10px 20px;
}

/* Informações do Processo */
.processo-info-historico {
    background: #f8fafc;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
    border-left: 4px solid #667eea;
}

.processo-info-historico h3 {
    color: #1e293b;
    font-size: 1.1rem;
    margin-bottom: 10px;
    font-family: 'Montserrat', sans-serif;
}

.processo-info-historico p {
    color: #64748b;
    margin: 5px 0;
}

.processo-info-historico strong {
    color: #334155;
}

/* Estatísticas Resumidas */
.stats-resumo-historico {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card-historico {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
}

.stat-number-historico {
    font-size: 1.8rem;
    font-weight: 700;
    color: #667eea;
    font-family: 'Montserrat', sans-serif;
}

.stat-label-historico {
    font-size: 0.85rem;
    color: #64748b;
    margin-top: 5px;
}

/* Timeline de Histórico */
.timeline-historico {
    position: relative;
    padding-left: 40px;
}

.timeline-historico::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(to bottom, #667eea, #764ba2);
}

.timeline-item-historico {
    position: relative;
    margin-bottom: 30px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.timeline-item-historico:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    transform: translateX(5px);
}

.timeline-item-historico::before {
    content: '';
    position: absolute;
    left: -33px;
    top: 25px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: white;
    border: 3px solid #667eea;
    box-shadow: 0 0 0 4px white;
}

/* Tipos de movimentação */
.timeline-item-historico.criacao::before {
    border-color: #10b981;
    background: #10b981;
}

.timeline-item-historico.edicao::before {
    border-color: #3b82f6;
    background: #3b82f6;
}

.timeline-item-historico.status-change::before {
    border-color: #f59e0b;
    background: #f59e0b;
}

.timeline-item-historico.despacho::before {
    border-color: #8b5cf6;
    background: #8b5cf6;
}

.timeline-item-historico.finalizacao::before {
    border-color: #ef4444;
    background: #ef4444;
}

.timeline-item-historico.retorno::before {
    border-color: #ec4899;
    background: #ec4899;
}

.timeline-header-historico {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.timeline-icon-historico {
    font-size: 1.5rem;
    margin-right: 10px;
}

.timeline-title-historico {
    font-weight: 600;
    color: #1e293b;
    font-size: 1.05rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.timeline-datetime-historico {
    color: #64748b;
    font-size: 0.85rem;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.timeline-date-historico {
    font-weight: 600;
}

.timeline-time-historico {
    opacity: 0.8;
}

.timeline-content-historico {
    color: #475569;
    line-height: 1.6;
}

.timeline-changes-historico {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e2e8f0;
}

.change-item-historico {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 8px 0;
    font-size: 0.9rem;
    flex-wrap: wrap;
}

.change-label-historico {
    font-weight: 600;
    color: #64748b;
}

.change-old-historico {
    color: #ef4444;
    text-decoration: line-through;
    background: #fee2e2;
    padding: 2px 8px;
    border-radius: 4px;
}

.change-new-historico {
    color: #10b981;
    background: #d1fae5;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
}

.change-arrow-historico {
    color: #94a3b8;
}

/* Badges do histórico */
.badge-historico {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
}

.badge-criacao {
    background: #d1fae5;
    color: #065f46;
}

.badge-edicao {
    background: #dbeafe;
    color: #1e40af;
}

.badge-status {
    background: #fef3c7;
    color: #92400e;
}

.badge-despacho {
    background: #ede9fe;
    color: #5b21b6;
}

.badge-finalizacao {
    background: #fee2e2;
    color: #991b1b;
}

.badge-retorno {
    background: #fce7f3;
    color: #9f1239;
}

/* Empty state do histórico */
.empty-state-historico {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
}

.empty-state-icon-historico {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

/* Responsividade */
@media (max-width: 768px) {
    .calendar-grid-heatmap {
        gap: 4px;
    }

    .calendar-day-heatmap {
        min-height: 100px;
        padding: 6px;
    }

    .month-title-heatmap {
        font-size: 1.1rem;
    }

    .nav-button-heatmap {
        padding: 6px 12px;
        font-size: 0.9rem;
    }
}

/* ============================================
   ESTILOS DE IMPRESSÃO - CALENDÁRIO
   ============================================ */
@media print {
    /* Configuração da página */
    @page {
        size: A4 landscape;
        margin: 8mm;
    }

    /* Reset para impressão */
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /* Esconder tudo da página */
    html, body {
        height: auto !important;
        overflow: visible !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    body > *:not(#modal-heatmap) {
        display: none !important;
    }

    /* Esconder sidebar, container principal, etc */
    .sidebar,
    .container,
    .modal:not(#modal-heatmap) {
        display: none !important;
    }

    /* Container do modal */
    #modal-heatmap {
        display: block !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: auto !important;
        background: white !important;
        z-index: 999999 !important;
        overflow: visible !important;
        margin: 0 !important;
        padding: 0 !important;
        page-break-after: avoid !important;
        page-break-inside: avoid !important;
    }

    #modal-heatmap .modal-content {
        position: relative !important;
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        max-height: none !important;
        margin: 0 !important;
        padding: 5mm !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        overflow: visible !important;
        background: white !important;
        page-break-inside: avoid !important;
    }

    /* Esconder cabeçalho do modal e botões/controles */
    #modal-heatmap .modal-header {
        display: none !important;
    }

    /* Esconder botões e controles */
    #modal-heatmap .close-modal-heatmap,
    #modal-heatmap .close-btn-padronizado,
    #modal-heatmap .calendar-config-buttons-padronizado,
    #modal-heatmap .modal-actions,
    #modal-heatmap .nav-button-heatmap,
    #modal-heatmap .btn-copiar-heatmap,
    #modal-heatmap .prioridade-badge {
        display: none !important;
    }

    /* Header do calendário (mês/ano) */
    #modal-heatmap .calendar-header-heatmap {
        display: flex !important;
        justify-content: center !important;
        margin-bottom: 8px !important;
    }

    #modal-heatmap .month-title-heatmap {
        font-size: 14pt !important;
        font-weight: 700 !important;
        color: #1e293b !important;
    }

    /* Modal body */
    #modal-heatmap .modal-body {
        padding: 0 !important;
        overflow: visible !important;
    }

    /* Grid do calendário */
    #modal-heatmap .calendar-grid-heatmap {
        display: grid !important;
        grid-template-columns: repeat(7, 1fr) !important;
        gap: 1px !important;
        background: #cbd5e1 !important;
        border: 1px solid #cbd5e1 !important;
        width: 100% !important;
    }

    /* Cabeçalhos dos dias da semana */
    #modal-heatmap .calendar-day-header-heatmap {
        background: #1e40af !important;
        color: white !important;
        font-size: 8pt !important;
        font-weight: 700 !important;
        padding: 6px 4px !important;
        text-align: center !important;
    }

    #modal-heatmap .calendar-day-header-heatmap.weekend-header {
        background: #64748b !important;
    }

    /* Células dos dias */
    #modal-heatmap .calendar-day-heatmap {
        background: white !important;
        padding: 3px !important;
        min-height: 70px !important;
        height: auto !important;
        font-size: 7pt !important;
        vertical-align: top !important;
        overflow: hidden !important;
        border: none !important;
    }

    #modal-heatmap .calendar-day-heatmap.weekend {
        background: #f1f5f9 !important;
    }

    #modal-heatmap .calendar-day-heatmap.other-month {
        background: #f8fafc !important;
        opacity: 0.5 !important;
    }

    #modal-heatmap .calendar-day-heatmap.feriado {
        background: #fef9c3 !important;
    }

    #modal-heatmap .calendar-day-heatmap.ferias {
        background: #dbeafe !important;
    }

    /* Número do dia */
    #modal-heatmap .day-number-heatmap {
        font-size: 9pt !important;
        font-weight: 700 !important;
        color: #374151 !important;
        margin-bottom: 2px !important;
    }

    #modal-heatmap .day-number-heatmap.today {
        background: #1e40af !important;
        color: white !important;
        border-radius: 50% !important;
        width: 18px !important;
        height: 18px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* Processos */
    #modal-heatmap .processo-item-heatmap {
        background: #f0f9ff !important;
        border: 1px solid #0ea5e9 !important;
        border-radius: 2px !important;
        padding: 2px 3px !important;
        margin-bottom: 2px !important;
        font-size: 6pt !important;
        line-height: 1.2 !important;
        overflow: hidden !important;
    }

    #modal-heatmap .processo-item-heatmap.urgente {
        background: #fef3c7 !important;
        border-color: #f59e0b !important;
    }

    #modal-heatmap .processo-item-heatmap.critico {
        background: #fee2e2 !important;
        border-color: #ef4444 !important;
    }

    #modal-heatmap .processo-numero-heatmap {
        display: block !important;
        font-size: 6pt !important;
        font-weight: 600 !important;
        color: #1e293b !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }

    #modal-heatmap .processo-dias-heatmap {
        display: block !important;
        font-size: 5.5pt !important;
        color: #64748b !important;
    }

    /* Legenda */
    #modal-heatmap .legenda-heatmap {
        display: flex !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
        gap: 12px !important;
        margin-top: 8px !important;
        padding-top: 8px !important;
        border-top: 1px solid #e2e8f0 !important;
    }

    #modal-heatmap .legenda-item-heatmap {
        display: flex !important;
        align-items: center !important;
        gap: 4px !important;
        font-size: 7pt !important;
    }

    #modal-heatmap .legenda-cor-heatmap {
        width: 12px !important;
        height: 12px !important;
        border-radius: 2px !important;
        flex-shrink: 0 !important;
    }
}

</style>
</head>
<body>
    <!-- Sidebar Vertical -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <!-- Ícone de Balança da Justiça Estilizado -->
                <svg viewBox="0 0 24 24" fill="currentColor" width="26" height="26">
                    <path d="M12 2C12.55 2 13 2.45 13 3V3.93C14.65 4.29 16.16 5.12 17.36 6.29L19.5 5.42L20.21 7.21L18.07 8.08C18.67 9.28 19 10.61 19 12H20V14H19C19 15.39 18.67 16.72 18.07 17.92L20.21 18.79L19.5 20.58L17.36 19.71C16.16 20.88 14.65 21.71 13 22.07V23C13 23.55 12.55 24 12 24C11.45 24 11 23.55 11 23V22.07C9.35 21.71 7.84 20.88 6.64 19.71L4.5 20.58L3.79 18.79L5.93 17.92C5.33 16.72 5 15.39 5 14H4V12H5C5 10.61 5.33 9.28 5.93 8.08L3.79 7.21L4.5 5.42L6.64 6.29C7.84 5.12 9.35 4.29 11 3.93V3C11 2.45 11.45 2 12 2ZM12 6C8.69 6 6 8.69 6 12C6 15.31 8.69 18 12 18C15.31 18 18 15.31 18 12C18 8.69 15.31 6 12 6ZM12 8C14.21 8 16 9.79 16 12C16 14.21 14.21 16 12 16C9.79 16 8 14.21 8 12C8 9.79 9.79 8 12 8Z"/>
                </svg>
            </div>
            <div class="sidebar-header-text">
                <h1 class="sidebar-title">Controle de Processos</h1>
                <p class="sidebar-subtitle">Gabinete Judicial</p>
            </div>
        </div>

        <!-- Botões de Ação Rápida -->
        <div class="sidebar-action-buttons">
            <button class="sidebar-action-btn" onclick="manager.abrirModalNovoProcesso()" aria-label="Novo Processo">
                <span class="sidebar-action-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </span>
                <span class="sidebar-action-text">Novo processo</span>
            </button>
            <button class="sidebar-action-btn" onclick="manager.abrirModalCadastroLote()" aria-label="Cadastro em Lote">
                <span class="sidebar-action-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                </span>
                <span class="sidebar-action-text">Em lote</span>
            </button>
        </div>

        <nav class="sidebar-nav">
            <!-- Seção: Processos -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Processos</h3>
                <button class="sidebar-btn sidebar-nav-item active" data-section="andamento" onclick="manager.navegarParaSecao('andamento')" aria-label="Em Andamento">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </span>
                    <span class="sidebar-text">Em andamento</span>
                    <span class="sidebar-badge" id="sidebar-badge-andamento">0</span>
                </button>
                <button class="sidebar-btn sidebar-nav-item" data-section="despachados" onclick="manager.navegarParaSecao('despachados')" aria-label="Despachados">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M22 2L11 13"></path>
                            <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
                        </svg>
                    </span>
                    <span class="sidebar-text">Despachados</span>
                </button>
                <button class="sidebar-btn sidebar-nav-item" data-section="finalizados" onclick="manager.navegarParaSecao('finalizados')" aria-label="Finalizados">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </span>
                    <span class="sidebar-text">Finalizados</span>
                </button>
            </div>

            <!-- Seção: Alertas -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Alertas</h3>
                <button class="sidebar-btn sidebar-alert-item" onclick="manager.abrirModalAlertas('criticos')" aria-label="Críticos">
                    <span class="sidebar-indicator indicator-red"></span>
                    <span class="sidebar-text">Críticos</span>
                    <span class="sidebar-badge badge-danger" id="sidebar-criticos">0</span>
                </button>
                <button class="sidebar-btn sidebar-alert-item" onclick="manager.abrirModalAlertas('atencao')" aria-label="Atenção">
                    <span class="sidebar-indicator indicator-yellow"></span>
                    <span class="sidebar-text">Atenção</span>
                    <span class="sidebar-badge badge-warning" id="sidebar-atencao">0</span>
                </button>
                <button class="sidebar-btn sidebar-alert-item" onclick="manager.abrirModalAlertas('70dias')" aria-label="Processos críticos">
                    <span class="sidebar-indicator indicator-blue"></span>
                    <span class="sidebar-text" id="sidebar-criticos-label">Críticos</span>
                    <span class="sidebar-badge" id="sidebar-70dias">0</span>
                </button>
            </div>

            <!-- Seção: Relatórios -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Relatórios</h3>
                <button class="sidebar-btn" onclick="manager.abrirModalProducao()" aria-label="Produção Mensal">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </span>
                    <span class="sidebar-text">Produção mensal</span>
                </button>
                <button class="sidebar-btn" onclick="manager.abrirModalHeatmap()" aria-label="Planejamento de Prazos">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </span>
                    <span class="sidebar-text">Planejamento</span>
                </button>
                <button class="sidebar-btn" onclick="manager.abrirModalRelatorio()" aria-label="Gerar PDF">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                    </span>
                    <span class="sidebar-text">Gerar PDF</span>
                </button>
            </div>

            <!-- Seção: Dados -->
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Dados</h3>
                <button class="sidebar-btn" onclick="manager.exportarDados()" aria-label="Salvar dados">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                    </span>
                    <span class="sidebar-text">Salvar</span>
                </button>
                <button class="sidebar-btn" onclick="document.getElementById('import-file').click()" aria-label="Carregar dados">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </span>
                    <span class="sidebar-text">Carregar</span>
                </button>
                <button class="sidebar-btn" onclick="manager.limparDados()" aria-label="Limpar todos os dados">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </span>
                    <span class="sidebar-text">Limpar</span>
                </button>
                <button class="sidebar-btn" onclick="manager.abrirModalConfiguracoes()" aria-label="Configurações">
                    <span class="sidebar-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </span>
                    <span class="sidebar-text">Configurações</span>
                </button>
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="manager.importarDados(event)">
            </div>
        </nav>

        <!-- Footer com Toggle de Tema e Recolher -->
        <div class="sidebar-footer">
            <!-- Toggle de Tema -->
            <div class="theme-toggle-container">
                <span class="theme-toggle-label">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <span class="sidebar-text">Tema</span>
                </span>
                <button class="theme-toggle" id="theme-toggle" onclick="manager.toggleTheme()" aria-label="Alternar tema escuro"></button>
            </div>

            <button class="sidebar-btn sidebar-collapse-btn" onclick="manager.toggleSidebarCollapse()" aria-label="Recolher menu">
                <span class="sidebar-icon sidebar-collapse-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </span>
                <span class="sidebar-text">Recolher menu</span>
            </button>
        </div>
    </aside>

    <div class="container">
        <!-- Botão Menu Mobile -->
        <button class="menu-toggle" id="menu-toggle" onclick="manager.toggleSidebar()" aria-label="Abrir menu">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Loading Overlay for Import/Export -->
        <div id="import-export-loading" class="loading-overlay" style="display: none;">
            <div class="loading-overlay-content">
                <div class="spinner"></div>
                <p id="import-export-loading-text">Processando...</p>
            </div>
        </div>

        <main>
            <!-- Painel de Alertas -->
            <section class="alerts-section hidden" id="alerts-section">
                <h2>Alertas e Notificações</h2>
                <div class="alerts-grid">
                    <!-- Primeira linha: Críticos, Atenção, Produção -->
                    <div class="alerts-row">
                        <div class="alert-card alert-critical alert-clickable" onclick="manager.abrirModalAlertas('criticos')" role="button" tabindex="0" aria-label="Ver processos críticos">
                            <div class="alert-icon">🚨</div>
                            <div class="alert-content">
                                <h3>Críticos</h3>
                                <p class="alert-number" id="alert-criticos">0</p>
                                <p class="alert-desc" id="alert-criticos-desc">≥89 dias</p>
                            </div>
                            <p class="alert-link">Ver →</p>
                        </div>
                        <div class="alert-card alert-warning alert-clickable" onclick="manager.abrirModalAlertas('atencao')" role="button" tabindex="0" aria-label="Ver processos de atenção">
                            <div class="alert-icon">⚠️</div>
                            <div class="alert-content">
                                <h3>Atenção</h3>
                                <p class="alert-number" id="alert-atencao">0</p>
                                <p class="alert-desc" id="alert-atencao-desc">70-88 dias</p>
                            </div>
                            <p class="alert-link">Ver →</p>
                        </div>
                        <div class="alert-card alert-success alert-clickable" onclick="manager.abrirModalAlertas('producao')" role="button" tabindex="0" aria-label="Ver produção do mês">
                            <div class="alert-icon">📊</div>
                            <div class="alert-content">
                                <h3>Produção</h3>
                                <p class="alert-number" id="alert-producao-mes">0</p>
                                <p class="alert-desc">Finalizados <span id="alert-producao-desc"></span></p>
                            </div>
                            <p class="alert-link">Ver →</p>
                        </div>
                    </div>

                    <!-- Segunda linha: Card de processos críticos -->
                    <div class="alerts-row">
                        <div class="alert-card alert-card-full alert-info alert-clickable" onclick="manager.abrirModalAlertas('70dias')" role="button" tabindex="0" aria-label="Ver processos críticos">
                            <div class="alert-icon">📅</div>
                            <div class="alert-content">
                                <h3>Monitoramento dos processos</h3>
                                <div class="meta-details-horizontal">
                                    <div class="meta-stat">
                                        <span class="meta-stat-icon">🔴</span>
                                        <span class="meta-stat-number" id="alert-70dias-atuais">0</span>
                                        <span class="meta-stat-label" id="alert-70dias-atuais-label">Já críticos</span>
                                    </div>
                                    <span class="meta-stat-separator">•</span>
                                    <div class="meta-stat">
                                        <span class="meta-stat-icon">⏰</span>
                                        <span class="meta-stat-number" id="alert-70dias-proximos">0</span>
                                        <span class="meta-stat-label" id="alert-70dias-proximos-label">Atingirão nível crítico <span id="alert-70dias-mes-desc"></span></span>
                                    </div>
                                    <span class="meta-stat-separator">•</span>
                                    <div class="meta-stat">
                                        <span class="meta-stat-icon">📊</span>
                                        <span class="meta-stat-number" id="alert-70dias-total">0</span>
                                        <span class="meta-stat-label">Total</span>
                                    </div>
                                </div>
                            </div>
                            <p class="alert-link">Ver →</p>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Lista de Processos -->
            <section class="list-section" aria-labelledby="list-title">
                <div class="list-header">
                    <h2 id="list-title">Processos Cadastrados</h2>
                    <div class="busca-wrapper">
                        <input type="text" id="busca" placeholder="Digite número ou assunto..." class="busca-integrada" aria-label="Buscar por número ou assunto">
                        <button type="button" class="busca-clear-btn" id="busca-clear-btn" aria-label="Limpar busca">&times;</button>
                    </div>
                </div>
                <div class="stats">
                    <span class="stat-item">Em andamento: <strong id="em-andamento">0</strong></span>
                </div>

                <!-- Processos em Andamento -->
                <div class="table-section-andamento">
                    <div class="table-header-with-toggle">
                        <h3 class="table-section-title">PROCESSOS EM ANDAMENTO</h3>
                        <button class="btn-toggle" onclick="manager.toggleTabela('andamento')" aria-label="Expandir/Recolher tabela">
                            <span id="toggle-icon-andamento">▼</span>
                        </button>
                    </div>

                    <!-- Modo Tabela -->
                    <div class="table-responsive" id="table-content-andamento">
                        <table id="processos-andamento-table" aria-label="Tabela de processos em andamento">
                            <thead>
                                <tr>
                                    <th scope="col" class="sortable col-numero" onclick="manager.ordenarPor('andamento', 'numero')">
                                        Número <span class="sort-indicator" id="sort-andamento-numero"></span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('andamento', 'assunto')">
                                        Assunto <span class="sort-indicator" id="sort-andamento-assunto"></span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('andamento', 'classe')">
                                        Classe processual <span class="sort-indicator" id="sort-andamento-classe"></span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('andamento', 'dataConclusao')">
                                        Data da Conclusão <span class="sort-indicator" id="sort-andamento-dataConclusao"></span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('andamento', 'diasConclusos')">
                                        Dias conclusos <span class="sort-indicator" id="sort-andamento-diasConclusos">▲</span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('andamento', 'status')">
                                        Status <span class="sort-indicator" id="sort-andamento-status"></span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('andamento', 'prioridade')">
                                        Prioridade <span class="sort-indicator" id="sort-andamento-prioridade"></span>
                                    </th>
                                    <th scope="col">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="processos-andamento-tbody">
                                <tr class="empty-state">
                                    <td colspan="8" class="text-center">
                                        Nenhum processo em andamento.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Processos Despachados -->
                <div class="table-section-despachados">
                    <div class="table-header-with-toggle">
                        <h3 class="table-section-title">PROCESSOS DESPACHADOS</h3>
                        <button class="btn-toggle" onclick="manager.toggleTabela('despachados')" aria-label="Expandir/Recolher tabela">
                            <span id="toggle-icon-despachados">▶</span>
                        </button>
                    </div>
                    <div class="table-responsive collapsed" id="table-content-despachados">
                        <table id="processos-despachados-table" aria-label="Tabela de processos despachados">
                            <thead>
                                <tr>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('despachados', 'numero')">
                                        Número <span class="sort-indicator" id="sort-despachados-numero"></span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('despachados', 'assunto')">
                                        Assunto <span class="sort-indicator" id="sort-despachados-assunto"></span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('despachados', 'classe')">
                                        Classe processual <span class="sort-indicator" id="sort-despachados-classe"></span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('despachados', 'dataDespacho')">
                                        Data do Despacho <span class="sort-indicator" id="sort-despachados-dataDespacho">▼</span>
                                    </th>
                                    <th scope="col" class="sortable" onclick="manager.ordenarPor('despachados', 'status')">
                                        Status <span class="sort-indicator" id="sort-despachados-status"></span>
                                    </th>
                                    <th scope="col">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="processos-despachados-tbody">
                                <tr class="empty-state">
                                    <td colspan="6" class="text-center">
                                        Nenhum processo despachado.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Processos Finalizados -->
                <div class="table-section-finalizados">
                    <div class="table-header-with-toggle">
                        <h3 class="table-section-title">PROCESSOS FINALIZADOS</h3>
                        <button class="btn-toggle" onclick="manager.toggleTabela('finalizados')" aria-label="Expandir/Recolher tabela">
                            <span id="toggle-icon-finalizados">▶</span>
                        </button>
                    </div>
                    <div class="table-responsive collapsed" id="table-content-finalizados">
                        <!-- Sistema de Filtros por Abas -->
                        <div class="finalizados-filter-container">
                            <!-- Seletor de Ano -->
                            <div class="finalizados-year-selector">
                                <label for="finalizados-year-select">📅 Ano:</label>
                                <select id="finalizados-year-select" class="finalizados-year-select" onchange="manager.mudarAnoFinalizados(this.value)">
                                    <!-- Preenchido dinamicamente -->
                                </select>
                            </div>

                            <!-- Abas de Meses -->
                            <div class="finalizados-tabs-container">
                                <div class="finalizados-tabs" id="finalizados-tabs">
                                    <!-- Abas preenchidas dinamicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Conteúdo das Abas -->
                        <div id="finalizados-tabs-content">
                            <!-- Conteúdo preenchido dinamicamente -->
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2024 Sistema de Controle de Processos - Gabinete Judicial</p>
        </footer>
    </div>

    <!-- Modal de Observações -->
    <div id="modal-observacoes" class="modal" role="dialog" aria-labelledby="modal-obs-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-obs-title">Observações do Processo</h2>
                <button class="close-modal-obs" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="obs-info">
                    <p><strong>Número do Processo:</strong> <span id="obs-numero"></span></p>
                    <p><strong>Assunto:</strong> <span id="obs-assunto"></span></p>
                </div>
                <div class="obs-content">
                    <h3>Observações:</h3>
                    <p id="obs-texto"></p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary close-modal-obs">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Relatório PDF -->
    <div id="modal-relatorio" class="modal" role="dialog" aria-labelledby="modal-relatorio-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-relatorio-title">Gerar Relatório de Processos Finalizados</h2>
                <button class="close-modal-relatorio" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    Selecione o período para gerar o relatório em PDF dos processos finalizados:
                </p>

                <form id="relatorio-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="relatorio-data-inicial">Data Inicial *</label>
                            <input type="date" id="relatorio-data-inicial" required>
                        </div>

                        <div class="form-group">
                            <label for="relatorio-data-final">Data Final *</label>
                            <input type="date" id="relatorio-data-final" required>
                        </div>
                    </div>

                    <div class="info-box">
                        <p><strong>ℹ️ Informação:</strong></p>
                        <p>O relatório incluirá todos os processos finalizados no período selecionado.</p>
                        <p id="preview-count" class="preview-count"></p>
                    </div>

                    <div id="relatorio-loading" class="loading-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <p>Gerando relatório PDF, aguarde...</p>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary" id="btn-gerar-pdf">
                            📄 Gerar PDF
                        </button>
                        <button type="button" class="btn btn-cancel close-modal-relatorio">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Novo Processo -->
    <div id="modal-novo-processo" class="modal" role="dialog" aria-labelledby="modal-novo-processo-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-novo-processo-title">➕ Cadastrar Novo Processo</h2>
                <button class="close-modal-novo-processo" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-message show">
                    <strong>💡 Dica:</strong> Preencha todos os campos obrigatórios marcados com *
                </div>

                <form id="processo-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="numero-processo">📋 Número do Processo *</label>
                            <input type="text" id="numero-processo" name="numero-processo" required
                                   placeholder="0000000-00.0000.0.00.0000" aria-required="true">
                        </div>

                        <div class="form-group">
                            <label for="data-conclusao">📅 Data da Conclusão *</label>
                            <input type="date" id="data-conclusao" name="data-conclusao" required aria-required="true">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="assunto">📝 Assunto *</label>
                            <div class="input-with-manage-btn">
                                <select id="assunto" name="assunto" required aria-required="true">
                                    <option value="">Selecione...</option>
                                </select>
                                <button type="button" class="btn btn-manage-compact" onclick="manager.abrirModalGerenciarAssuntos()" aria-label="Gerenciar assuntos">
                                    ⚙️
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="classe-processual">⚖️ Classe processual *</label>
                            <div class="input-with-manage-btn">
                                <select id="classe-processual" name="classe-processual" required aria-required="true">
                                    <option value="">Selecione...</option>
                                </select>
                                <button type="button" class="btn btn-manage-compact" onclick="manager.abrirModalGerenciarClasses()" aria-label="Gerenciar classes processuais">
                                    ⚙️
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">📊 Status *</label>
                            <select id="status" name="status" required aria-required="true">
                                <option value="">Selecione...</option>
                                <option value="aguardando-despacho">Aguardando despacho</option>
                                <option value="concluso">Concluso para julgamento</option>
                                <option value="despachado">Despachado</option>
                                <option value="finalizado">Finalizado</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="prioridade">⭐ Prioridade</label>
                            <select id="prioridade" name="prioridade">
                                <option value="normal">Normal</option>
                                <option value="urgente">Urgente</option>
                                <option value="muito-urgente">Muito Urgente</option>
                                <option value="prioridade-advogado">Prioridade a pedido do advogado</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="observacoes">💬 Observações</label>
                        <textarea id="observacoes" name="observacoes" rows="3" placeholder="Digite observações sobre o processo (opcional)"></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">
                            ✓ Cadastrar Processo
                        </button>
                        <button type="button" class="btn btn-cancel close-modal-novo-processo">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro em Lote -->
    <div id="modal-cadastro-lote" class="modal" role="dialog" aria-labelledby="modal-lote-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-lote-title">Cadastro em Lote de Processos</h2>
                <button class="close-modal-lote" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    Importe de uma planilha Excel ou cole os números dos processos manualmente:
                </p>

                <form id="cadastro-lote-form">
                    <!-- Importação de Excel -->
                    <div class="form-group">
                        <label for="arquivo-excel-lote">📊 Importar do Excel (.xlsx)</label>
                        <div class="excel-import-container">
                            <input type="file" id="arquivo-excel-lote" accept=".xlsx,.xls" onchange="manager.processarArquivoExcel(this)">
                            <small class="help-text">
                                💡 A planilha deve ter: <strong>Coluna A</strong> = Número do processo, <strong>Coluna B</strong> = Data de conclusão
                            </small>
                        </div>
                    </div>

                    <div class="divisor-ou">
                        <span>ou cole manualmente</span>
                    </div>

                    <div class="form-group">
                        <label for="numeros-lote">Processos e Datas de Conclusão *</label>
                        <textarea id="numeros-lote" rows="8" placeholder="Cole os processos aqui, um por linha no formato:&#10;0871222-20.2024.8.20.5001 09/10/2025&#10;0859333-87.2021.8.20.5001 02/04/2025&#10;0876111-49.2024.8.20.5001 03/05/2025" required></textarea>
                        <small class="help-text">
                            💡 Formato: Número do processo + espaço + Data (DD/MM/AAAA)
                        </small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="lote-classe-processual">Classe Processual *</label>
                            <select id="lote-classe-processual" required>
                                <option value="apelacao-civel">Apelação Cível</option>
                                <option value="agravo-instrumento">Agravo de Instrumento</option>
                                <option value="pedido-efeito-suspensivo">Pedido de Efeito Suspensivo</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="lote-status">Status *</label>
                            <select id="lote-status" required>
                                <option value="aguardando-despacho">Aguardando despacho</option>
                                <option value="concluso">Concluso para julgamento</option>
                                <option value="despachado">Despachado</option>
                                <option value="finalizado">Finalizado</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="lote-prioridade">Prioridade</label>
                            <select id="lote-prioridade">
                                <option value="normal">Normal</option>
                                <option value="urgente">Urgente</option>
                                <option value="muito-urgente">Muito Urgente</option>
                                <option value="prioridade-advogado">Prioridade a pedido do advogado</option>
                            </select>
                        </div>
                    </div>

                    <div class="info-box">
                        <p><strong>ℹ️ Informação:</strong></p>
                        <p>Todos os processos serão cadastrados com o assunto <strong>"A editar"</strong>.</p>
                        <p>Cada processo usará sua própria data de conclusão informada.</p>
                        <p>O sistema calculará automaticamente há quantos dias cada processo está concluso.</p>
                        <p id="preview-count-lote" class="preview-count"></p>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">
                            ➕ Cadastrar Processos
                        </button>
                        <button type="button" class="btn btn-cancel close-modal-lote">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Alertas -->
    <div id="modal-alertas" class="modal" role="dialog" aria-labelledby="modal-alertas-title" aria-hidden="true">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modal-alertas-title">Processos</h2>
                <button class="close-modal-alertas" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modal-alertas-descricao" class="modal-description"></p>
                <div class="table-responsive">
                    <table id="tabela-alertas" aria-label="Tabela de processos filtrados">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Assunto</th>
                                <th>Classe processual</th>
                                <th id="modal-alertas-col-data">Data da Conclusão</th>
                                <th id="modal-alertas-col-dias">Dias conclusos</th>
                                <th id="modal-alertas-col-prioridade">Prioridade</th>
                            </tr>
                        </thead>
                        <tbody id="modal-alertas-tbody">
                        </tbody>
                    </table>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary close-modal-alertas">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Despacho -->
    <div id="modal-despachar" class="modal" role="dialog" aria-labelledby="modal-despachar-title" aria-hidden="true">
        <div class="modal-content modal-compact">
            <div class="modal-header">
                <h2 id="modal-despachar-title">Despachar processo?</h2>
                <button class="close-modal-despachar" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="despachar-form">
                    <input type="hidden" id="despachar-processo-id">

                    <div class="form-group">
                        <label for="despachar-data">Data do Despacho: *</label>
                        <input type="date" id="despachar-data" required>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">
                            Confirmar
                        </button>
                        <button type="button" class="btn btn-cancel close-modal-despachar">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Finalização -->
    <div id="modal-finalizar" class="modal" role="dialog" aria-labelledby="modal-finalizar-title" aria-hidden="true">
        <div class="modal-content modal-compact">
            <div class="modal-header">
                <h2 id="modal-finalizar-title">Finalizar processo?</h2>
                <button class="close-modal-finalizar" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="finalizar-form">
                    <input type="hidden" id="finalizar-processo-id">

                    <div class="form-group">
                        <label for="finalizar-data">Data: *</label>
                        <input type="date" id="finalizar-data" required>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">
                            Confirmar
                        </button>
                        <button type="button" class="btn btn-cancel close-modal-finalizar">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Retorno -->
    <div id="modal-retornar" class="modal" role="dialog" aria-labelledby="modal-retornar-title" aria-hidden="true">
        <div class="modal-content modal-compact">
            <div class="modal-header">
                <h2 id="modal-retornar-title">Retornar processo?</h2>
                <button class="close-modal-retornar" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="retornar-form">
                    <input type="hidden" id="retornar-processo-id">

                    <div class="form-group">
                        <label for="retornar-data">Data da Conclusão após o retorno: *</label>
                        <input type="date" id="retornar-data" required>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">
                            Confirmar
                        </button>
                        <button type="button" class="btn btn-cancel close-modal-retornar">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Reabertura de Processo Finalizado -->
    <div id="modal-reabrir-finalizado" class="modal" role="dialog" aria-labelledby="modal-reabrir-finalizado-title" aria-hidden="true">
        <div class="modal-content modal-compact">
            <div class="modal-header">
                <h2 id="modal-reabrir-finalizado-title">Reabrir processo finalizado</h2>
                <button class="close-modal-reabrir-finalizado" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    Este processo será reaberto e voltará para <strong>Processos em Andamento</strong>.
                    Informe a nova data de conclusão:
                </p>
                <form id="reabrir-finalizado-form">
                    <input type="hidden" id="reabrir-finalizado-processo-id">

                    <div class="form-group">
                        <label for="reabrir-finalizado-data">Data da Conclusão: *</label>
                        <input type="date" id="reabrir-finalizado-data" required>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">
                            Confirmar Reabertura
                        </button>
                        <button type="button" class="btn btn-cancel close-modal-reabrir-finalizado">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Produção Mensal -->
    <div id="modal-producao" class="modal" role="dialog" aria-labelledby="modal-producao-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-producao-title">📊 Relatório de Produção Mensal</h2>
                <button class="close-modal-producao" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="producao-mes">Mês</label>
                        <select id="producao-mes">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Março</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="producao-ano">Ano</label>
                        <select id="producao-ano"></select>
                    </div>
                </div>

                <!-- Cards de Produção -->
                <div class="producao-cards">
                    <div class="producao-card producao-despachados">
                        <div class="producao-icon">⚖️</div>
                        <div class="producao-info">
                            <h4>Despachados</h4>
                            <p class="producao-number" id="producao-total-despachados">0</p>
                        </div>
                    </div>

                    <div class="producao-card producao-finalizados">
                        <div class="producao-icon">✅</div>
                        <div class="producao-info">
                            <h4>Finalizados</h4>
                            <p class="producao-number" id="producao-total-finalizados">0</p>
                        </div>
                    </div>

                    <div class="producao-card producao-total">
                        <div class="producao-icon">📊</div>
                        <div class="producao-info">
                            <h4>Total</h4>
                            <p class="producao-number" id="producao-total-geral">0</p>
                        </div>
                    </div>
                </div>

                <!-- Mensagem de produção vazia -->
                <div id="producao-mensagem" style="display: none; margin-top: 15px; padding: 10px; background-color: #f8fafc; border-radius: 8px; text-align: center; color: #64748b; font-weight: 600;"></div>

                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="manager.atualizarRelatorioProducao()">
                        🔄 Atualizar Relatório
                    </button>
                    <button class="btn btn-pdf" onclick="manager.abrirModalRelatorio()" aria-label="Gerar relatório PDF">
                        📄 Gerar Relatório PDF
                    </button>
                    <button type="button" class="btn btn-secondary close-modal-producao">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="modal-editar" class="modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Editar Processo</h2>
                <button class="close-modal" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editar-form">
                    <input type="hidden" id="edit-id">

                    <div class="form-group">
                        <label for="edit-numero-processo">📋 Número do Processo</label>
                        <input type="text" id="edit-numero-processo" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-assunto">📝 Assunto</label>
                        <div class="input-with-manage-btn">
                            <select id="edit-assunto" required>
                                <option value="">Selecione...</option>
                            </select>
                            <button type="button" class="btn btn-manage-compact" onclick="manager.abrirModalGerenciarAssuntos()" aria-label="Gerenciar assuntos">
                                ⚙️
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="edit-classe-processual">⚖️ Classe processual</label>
                        <div class="input-with-manage-btn">
                            <select id="edit-classe-processual" required>
                                <option value="">Selecione...</option>
                            </select>
                            <button type="button" class="btn btn-manage-compact" onclick="manager.abrirModalGerenciarClasses()" aria-label="Gerenciar classes processuais">
                                ⚙️
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="edit-data-conclusao">📅 Data da Conclusão</label>
                        <input type="date" id="edit-data-conclusao" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-prioridade">⭐ Prioridade</label>
                        <select id="edit-prioridade">
                            <option value="normal">Normal</option>
                            <option value="urgente">Urgente</option>
                            <option value="muito-urgente">Muito Urgente</option>
                            <option value="prioridade-advogado">Prioridade a pedido do advogado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="edit-status">📊 Status</label>
                        <select id="edit-status" required>
                            <option value="aguardando-despacho">Aguardando despacho</option>
                            <option value="concluso">Concluso para julgamento</option>
                            <option value="despachado">Despachado</option>
                            <option value="finalizado">Finalizado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="edit-observacoes">💬 Observações</label>
                        <textarea id="edit-observacoes" rows="3"></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                        <button type="button" class="btn btn-cancel close-modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Gerenciar Classes Processuais -->
    <div id="modal-gerenciar-classes" class="modal" role="dialog" aria-labelledby="modal-gerenciar-classes-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-gerenciar-classes-title">Gerenciar Classes Processuais</h2>
                <button class="close-modal-gerenciar-classes" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="nova-classe">Adicionar nova classe processual:</label>
                    <div class="input-with-add-btn">
                        <input type="text" id="nova-classe" placeholder="Digite o nome da classe...">
                        <button type="button" class="btn btn-add" onclick="manager.adicionarClasse()">
                            ➕ Adicionar
                        </button>
                    </div>
                </div>

                <div class="items-list-container">
                    <h3>Classes cadastradas:</h3>
                    <div id="lista-classes" class="items-list">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary close-modal-gerenciar-classes">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gerenciar Assuntos -->
    <div id="modal-gerenciar-assuntos" class="modal" role="dialog" aria-labelledby="modal-gerenciar-assuntos-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-gerenciar-assuntos-title">Gerenciar Assuntos</h2>
                <button class="close-modal-gerenciar-assuntos" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="novo-assunto">Adicionar novo assunto:</label>
                    <div class="input-with-add-btn">
                        <input type="text" id="novo-assunto" placeholder="Digite o nome do assunto...">
                        <button type="button" class="btn btn-add" onclick="manager.adicionarAssunto()">
                            ➕ Adicionar
                        </button>
                    </div>
                </div>

                <div class="items-list-container">
                    <h3>Assuntos cadastrados:</h3>
                    <div id="lista-assuntos" class="items-list">
                        <!-- Preenchido dinamicamente -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary close-modal-gerenciar-assuntos">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Heatmap de Prazos -->
    <div id="modal-heatmap" class="modal" role="dialog" aria-labelledby="modal-heatmap-title" aria-hidden="true">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modal-heatmap-title">Planejamento de Prazos</h2>
                <button class="close-modal-heatmap close-btn-padronizado" aria-label="Fechar modal">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="calendar-header-heatmap">
                    <button class="nav-button-heatmap" id="prev-month-btn" onclick="manager.navegarMesHeatmap(-1)">← Anterior</button>
                    <div class="month-title-heatmap" id="month-title-heatmap">Janeiro 2025</div>
                    <button class="nav-button-heatmap" id="next-month-btn" onclick="manager.navegarMesHeatmap(1)">Próximo →</button>
                </div>
                <div class="calendar-config-buttons-padronizado">
                    <button class="btn-chip-calendario green" onclick="manager.abrirModalAdicionarFeriado()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Feriado
                    </button>
                    <button class="btn-chip-calendario green" onclick="manager.abrirModalAdicionarFerias()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Férias
                    </button>
                    <button class="btn-chip-calendario blue" onclick="manager.abrirModalGerenciarDiasNaoUteis()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Gerenciar
                    </button>
                    <button class="btn-chip-calendario purple" onclick="manager.limparPosicoesCustomizadas()" title="Resetar processos movidos manualmente">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Resetar Posições
                    </button>
                    <button class="btn-chip-calendario gray" onclick="manager.imprimirCalendario()" title="Imprimir calendário">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                        </svg>
                        Imprimir
                    </button>
                </div>
                <div id="heatmap-container" class="calendar-grid-heatmap">
                    <!-- Gerado dinamicamente pelo JS -->
                </div>
                <div class="legenda-heatmap">
                    <div class="legenda-item-heatmap">
                        <div class="legenda-cor-heatmap" style="background: #fee2e2; border: 2px solid #ef4444;"></div>
                        <span id="legenda-critico">Crítico (≥89 dias)</span>
                    </div>
                    <div class="legenda-item-heatmap">
                        <div class="legenda-cor-heatmap" style="background: #fef3c7; border: 2px solid #f59e0b;"></div>
                        <span id="legenda-atencao">Atenção (70-88 dias)</span>
                    </div>
                    <div class="legenda-item-heatmap">
                        <div class="legenda-cor-heatmap" style="background: #f0f9ff; border: 2px solid #0ea5e9;"></div>
                        <span id="legenda-normal">Normal (&lt;70 dias)</span>
                    </div>
                    <div class="legenda-item-heatmap">
                        <div class="legenda-cor-heatmap" style="background: #f8fafc; border: 2px solid #cbd5e1;"></div>
                        <span>Final de semana</span>
                    </div>
                    <div class="legenda-item-heatmap">
                        <div class="legenda-cor-heatmap" style="background: #fef9c3; border: 2px solid #eab308;"></div>
                        <span>Feriado</span>
                    </div>
                    <div class="legenda-item-heatmap">
                        <div class="legenda-cor-heatmap" style="background: #dbeafe; border: 2px solid #3b82f6;"></div>
                        <span>Férias</span>
                    </div>
                    <div class="legenda-item-heatmap">
                        <div class="legenda-cor-heatmap" style="background: #f0f9ff; border-left: 4px solid #8b5cf6; position: relative;">
                            <span style="position: absolute; top: 2px; right: 2px; width: 6px; height: 6px; background: #8b5cf6; border-radius: 50%;"></span>
                        </div>
                        <span>Movido manualmente</span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-acao-padronizado secondary close-modal-heatmap">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Feriado -->
    <div id="modal-adicionar-feriado" class="modal" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adicionar Feriado</h2>
                <button class="modal-close-btn" onclick="manager.fecharModalAdicionarFeriado()" aria-label="Fechar">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="adicionar-feriado-form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="feriado-nome">Nome do Feriado</label>
                        <input type="text" id="feriado-nome" required placeholder="Ex: Natal">
                    </div>
                    <div class="form-group">
                        <label for="feriado-data">Data</label>
                        <input type="date" id="feriado-data" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-modal primary">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Adicionar
                    </button>
                    <button type="button" class="btn-modal secondary" onclick="manager.fecharModalAdicionarFeriado()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Adicionar Férias -->
    <div id="modal-adicionar-ferias" class="modal" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adicionar Períodos de Férias</h2>
                <button class="modal-close-btn" onclick="manager.fecharModalAdicionarFerias()" aria-label="Fechar">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="adicionar-ferias-form">
                <div class="modal-body">
                    <p style="color: #64748b; margin-bottom: 20px; font-size: 0.95rem;">Preencha os períodos desejados. Campos vazios serão ignorados.</p>

                    <!-- Período 1 -->
                    <div class="periodo-card-padronizado">
                        <div class="periodo-header">
                            <div class="periodo-numero">1</div>
                            <span class="periodo-titulo">Período 1</span>
                        </div>
                        <div class="periodo-campos">
                            <div>
                                <label for="ferias-data-inicial-1">Data Inicial</label>
                                <input type="date" id="ferias-data-inicial-1">
                            </div>
                            <div>
                                <label for="ferias-data-final-1">Data Final</label>
                                <input type="date" id="ferias-data-final-1">
                            </div>
                        </div>
                    </div>

                    <!-- Período 2 -->
                    <div class="periodo-card-padronizado">
                        <div class="periodo-header">
                            <div class="periodo-numero">2</div>
                            <span class="periodo-titulo">Período 2</span>
                        </div>
                        <div class="periodo-campos">
                            <div>
                                <label for="ferias-data-inicial-2">Data Inicial</label>
                                <input type="date" id="ferias-data-inicial-2">
                            </div>
                            <div>
                                <label for="ferias-data-final-2">Data Final</label>
                                <input type="date" id="ferias-data-final-2">
                            </div>
                        </div>
                    </div>

                    <!-- Período 3 -->
                    <div class="periodo-card-padronizado">
                        <div class="periodo-header">
                            <div class="periodo-numero">3</div>
                            <span class="periodo-titulo">Período 3</span>
                        </div>
                        <div class="periodo-campos">
                            <div>
                                <label for="ferias-data-inicial-3">Data Inicial</label>
                                <input type="date" id="ferias-data-inicial-3">
                            </div>
                            <div>
                                <label for="ferias-data-final-3">Data Final</label>
                                <input type="date" id="ferias-data-final-3">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-modal primary">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Adicionar
                    </button>
                    <button type="button" class="btn-modal secondary" onclick="manager.fecharModalAdicionarFerias()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Gerenciar Dias Não Úteis -->
    <div id="modal-gerenciar-dias-nao-uteis" class="modal" role="dialog" aria-hidden="true">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Gerenciar Dias Não Úteis</h2>
                <button class="modal-close-btn" onclick="manager.fecharModalGerenciarDiasNaoUteis()" aria-label="Fechar">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <h3 style="color: #1e40af; margin-bottom: 15px; font-size: 1.1rem;">Feriados</h3>
                <div id="lista-feriados" style="margin-bottom: 30px;">
                    <!-- Gerado dinamicamente -->
                </div>
                <h3 style="color: #1e40af; margin-bottom: 15px; font-size: 1.1rem;">Períodos de Férias</h3>
                <div id="lista-ferias">
                    <!-- Gerado dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal secondary" onclick="manager.fecharModalGerenciarDiasNaoUteis()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico do Processo -->
    <div id="modal-historico" class="modal" role="dialog" aria-labelledby="modal-historico-title" aria-hidden="true">
        <div class="modal-content modal-large modal-historico">
            <div class="modal-header">
                <h2 id="modal-historico-title">📜 Histórico do Processo</h2>
                <button class="close-modal-historico" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Informações do Processo -->
                <div class="processo-info-historico">
                    <h3 id="historico-processo-numero">📋 Processo nº</h3>
                    <p><strong>Assunto:</strong> <span id="historico-processo-assunto"></span></p>
                    <p><strong>Classe:</strong> <span id="historico-processo-classe"></span></p>
                    <p><strong>Status atual:</strong> <span id="historico-processo-status"></span></p>
                </div>

                <!-- Estatísticas Resumidas -->
                <div class="stats-resumo-historico">
                    <div class="stat-card-historico">
                        <div class="stat-number-historico" id="historico-total-movimentacoes">0</div>
                        <div class="stat-label-historico">Movimentações</div>
                    </div>
                    <div class="stat-card-historico">
                        <div class="stat-number-historico" id="historico-total-edicoes">0</div>
                        <div class="stat-label-historico">Edições</div>
                    </div>
                    <div class="stat-card-historico">
                        <div class="stat-number-historico" id="historico-total-status">0</div>
                        <div class="stat-label-historico">Status alterados</div>
                    </div>
                    <div class="stat-card-historico">
                        <div class="stat-number-historico" id="historico-dias-conclusos">0</div>
                        <div class="stat-label-historico">Dias conclusos</div>
                    </div>
                </div>

                <!-- Timeline de Histórico -->
                <div id="historico-timeline" class="timeline-historico">
                    <!-- Preenchido dinamicamente pelo JavaScript -->
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-pdf" onclick="manager.exportarHistoricoPDF()" aria-label="Exportar histórico em PDF">
                    📄 Exportar PDF
                </button>
                <button type="button" class="btn btn-secondary close-modal-historico">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configurações -->
    <div id="modal-configuracoes" class="modal" role="dialog" aria-labelledby="modal-configuracoes-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-configuracoes-title">⚙️ Configurações do Sistema</h2>
                <button class="close-modal-configuracoes" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h3 class="config-section-title">Alertas de Prazos</h3>

                    <div class="form-group">
                        <label for="config-dias-atencao">Dias para "Atenção" (amarelo):</label>
                        <input type="number" id="config-dias-atencao" min="1" max="365" value="70">
                        <small class="help-text">Processos com este número de dias ou mais serão marcados como "Atenção"</small>
                    </div>

                    <div class="form-group">
                        <label for="config-dias-critico">Dias para "Crítico" (vermelho):</label>
                        <input type="number" id="config-dias-critico" min="1" max="365" value="89">
                        <small class="help-text">Processos com este número de dias ou mais serão marcados como "Crítico"</small>
                    </div>

                    <div class="info-box">
                        <p><strong>ℹ️ Informação:</strong></p>
                        <p>As alterações serão aplicadas imediatamente em todos os alertas, cálculos de prioridade e no planejamento.</p>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="manager.salvarConfiguracoes()">
                        💾 Salvar Configurações
                    </button>
                    <button type="button" class="btn btn-cancel close-modal-configuracoes">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Biblioteca jsPDF para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS para leitura de arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
// Sistema de Controle de Processos - Gabinete Judicial

class ProcessoManager {
    // Constantes para thresholds de dias (valores padrão, podem ser alterados nas configurações)
    static DIAS_ATENCAO = 70;      // >= 70 dias = Atenção (urgente)
    static DIAS_CRITICO = 89;       // >= 89 dias = Crítico (muito-urgente)

    constructor() {
        this.carregarConfiguracoes(); // Carregar configurações personalizadas
        this.processos = this.carregarProcessos();
        this.processoEditandoId = null;
        this.ordenacao = this.carregarPreferenciasOrdenacao();
        this.idSequence = 0; // Contador para IDs únicos
        this.classesProcessuais = this.carregarClassesProcessuais();
        this.assuntos = this.carregarAssuntos();
        this.historico = this.carregarHistorico(); // Sistema de logs
        this.feriados = this.carregarFeriados(); // Feriados cadastrados
        this.ferias = this.carregarFerias(); // Períodos de férias
        this.inicializarDragDrop(); // Sistema de drag and drop do calendário
        this.inicializar();
    }

    gerarIdUnico() {
        // Gera ID único combinando timestamp, random e sequência
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000000);
        const sequence = this.idSequence++;

        // Criar ID único: timestamp.random.sequence
        return parseFloat(`${timestamp}.${random}${sequence}`);
    }

    // Função auxiliar para encontrar processo por ID de forma robusta
    // Lida com casos onde o ID pode ser string ou número
    encontrarProcessoPorId(id) {
        // Converter id para número se necessário
        const idNumerico = typeof id === 'string' ? parseFloat(id) : id;

        // Tentar encontrar por comparação estrita primeiro
        let processo = this.processos.find(p => p.id === idNumerico);

        // Se não encontrou, tentar comparação flexível
        if (!processo) {
            processo = this.processos.find(p => String(p.id) === String(idNumerico));
        }

        return processo;
    }

    // Função auxiliar para encontrar índice de processo por ID de forma robusta
    encontrarIndicePorId(id) {
        // Converter id para número se necessário
        const idNumerico = typeof id === 'string' ? parseFloat(id) : id;

        // Tentar encontrar por comparação estrita primeiro
        let index = this.processos.findIndex(p => p.id === idNumerico);

        // Se não encontrou, tentar comparação flexível
        if (index === -1) {
            index = this.processos.findIndex(p => String(p.id) === String(idNumerico));
        }

        return index;
    }

    carregarPreferenciasOrdenacao() {
        const saved = localStorage.getItem('ordenacao-preferencias');
        if (saved) {
            return JSON.parse(saved);
        }
        // Padrões: andamento ordena por dias crescente, outros por data decrescente
        return {
            andamento: { campo: 'diasConclusos', crescente: true },
            despachados: { campo: 'dataDespacho', crescente: false },
            finalizados: { campo: 'dataFinalizacao', crescente: false }
        };
    }

    salvarPreferenciasOrdenacao() {
        localStorage.setItem('ordenacao-preferencias', JSON.stringify(this.ordenacao));
    }

    inicializar() {
        this.configurarEventos();
        this.configurarLimitesData();
        // this.adicionarProcessosIniciais(); // REMOVIDO: Dados de teste/desenvolvimento
        this.migrarDatasFinalizacao();
        this.migrarIDsParaDecimal();
        this.atualizarSelectClasses();
        this.atualizarSelectAssuntos();
        this.atualizarLabelsConfiguracoes(); // Atualizar labels com valores das configurações
        this.renderizarProcessos();
        this.atualizarEstatisticas();
        this.inicializarSidebar(); // Inicializar sidebar com estado salvo
        this.inicializarTema(); // Inicializar tema escuro/claro
    }

    // Sistema de Tema Escuro/Claro
    inicializarTema() {
        const temaSalvo = localStorage.getItem('tema-preferencia');
        const prefereEscuro = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (temaSalvo === 'dark' || (!temaSalvo && prefereEscuro)) {
            document.documentElement.setAttribute('data-theme', 'dark');
            const toggle = document.getElementById('theme-toggle');
            if (toggle) toggle.classList.add('active');
        }

        // Ouvir mudanças na preferência do sistema
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('tema-preferencia')) {
                this.aplicarTema(e.matches ? 'dark' : 'light');
            }
        });
    }

    toggleTheme() {
        const temaAtual = document.documentElement.getAttribute('data-theme');
        const novoTema = temaAtual === 'dark' ? 'light' : 'dark';
        this.aplicarTema(novoTema);
        localStorage.setItem('tema-preferencia', novoTema);
    }

    aplicarTema(tema) {
        const toggle = document.getElementById('theme-toggle');

        if (tema === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            if (toggle) toggle.classList.add('active');
        } else {
            document.documentElement.removeAttribute('data-theme');
            if (toggle) toggle.classList.remove('active');
        }
    }

    configurarLimitesData() {
        // Configurar data máxima (hoje) para todos os inputs de data
        const hoje = new Date().toISOString().split('T')[0];

        // Inputs que não devem aceitar data futura
        const inputsDataPassado = [
            'data-conclusao',
            'edit-data-conclusao',
            'finalizar-data',
            'retornar-data',
            'relatorio-data-inicial',
            'relatorio-data-final'
        ];

        inputsDataPassado.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.setAttribute('max', hoje);
            }
        });
    }

    debounce(func, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    }

    migrarDatasFinalizacao() {
        // Corrigir processos finalizados sem dataFinalizacao
        let houveMudanca = false;
        let processosMigrados = 0;
        let processosComErro = [];

        try {
            this.processos.forEach((processo, index) => {
                // Verificar se é processo finalizado sem dataFinalizacao
                if (processo.status === 'finalizado' && !processo.dataFinalizacao) {
                    try {
                        // Validar se dataConclusao existe e é válida
                        if (!processo.dataConclusao) {
                            processosComErro.push({
                                index,
                                numeroProcesso: processo.numeroProcesso || `ID: ${processo.id}`,
                                motivo: 'Sem dataConclusao para migrar'
                            });
                            console.warn(`⚠️ Processo ${processo.numeroProcesso || processo.id} está finalizado mas não tem dataConclusao`);
                            return;
                        }

                        // Validar formato da data (YYYY-MM-DD)
                        const regexData = /^\d{4}-\d{2}-\d{2}$/;
                        if (!regexData.test(processo.dataConclusao)) {
                            processosComErro.push({
                                index,
                                numeroProcesso: processo.numeroProcesso || `ID: ${processo.id}`,
                                motivo: `Data inválida: ${processo.dataConclusao}`
                            });
                            console.warn(`⚠️ Processo ${processo.numeroProcesso || processo.id} tem dataConclusao em formato inválido: ${processo.dataConclusao}`);
                            return;
                        }

                        // Usar dataConclusao como dataFinalizacao para processos antigos
                        processo.dataFinalizacao = processo.dataConclusao;
                        houveMudanca = true;
                        processosMigrados++;
                    } catch (error) {
                        processosComErro.push({
                            index,
                            numeroProcesso: processo.numeroProcesso || `ID: ${processo.id}`,
                            motivo: `Erro: ${error.message}`
                        });
                        console.error(`❌ Erro ao migrar processo ${processo.numeroProcesso || processo.id}:`, error);
                    }
                }
            });

            if (houveMudanca) {
                this.salvarProcessos();
                console.log(`✓ Migração de datas de finalização concluída: ${processosMigrados} processo(s) migrado(s).`);
            }

            // Relatar erros se houver
            if (processosComErro.length > 0) {
                console.warn(`⚠️ ${processosComErro.length} processo(s) não puderam ser migrados:`, processosComErro);
            }

        } catch (error) {
            console.error('❌ Erro crítico durante migração de datas de finalização:', error);
            // Não bloquear a inicialização do sistema mesmo com erro na migração
        }
    }

    migrarIDsParaDecimal() {
        // Verificar se a migração já foi executada
        const migracaoFeita = localStorage.getItem('migracao-ids-decimal');
        if (migracaoFeita === 'true') {
            return; // Migração já foi executada anteriormente
        }

        let houveMudanca = false;

        // Converter IDs inteiros para decimais
        this.processos.forEach(processo => {
            // Verificar se o ID é um número inteiro (sem parte decimal)
            if (Number.isInteger(processo.id)) {
                // Adicionar uma pequena parte decimal ao ID
                processo.id = processo.id + Math.random();
                houveMudanca = true;
            }
        });

        if (houveMudanca) {
            this.salvarProcessos();
            console.log(`✓ Migração de IDs concluída: ${this.processos.length} processo(s) verificado(s).`);
        }

        // Marcar migração como concluída
        localStorage.setItem('migracao-ids-decimal', 'true');
    }

    // FUNÇÃO DESABILITADA - Adicionava dados de teste/desenvolvimento
    // adicionarProcessosIniciais() {
    //     // Lista de números de processos para adicionar
    //     const numerosProcessos = [
    //         '08338184620198205001',
    //         '08093175720218205001',
    //         '08819661520248205001',
    //         '08242856320198205001',
    //         '02295074120108200001',
    //         '08453969820228205001',
    //         '08102690720198205001',
    //         '08036072720198205001',
    //         '01000615220158200116',
    //         '08019668020248205113',
    //         '08436507420178205001',
    //         '08064379720238205300',
    //         '08037224820248205300',
    //         '08213074020248205001',
    //         '08009406820248205106'
    //     ];
    //
    //     // Verificar se já foram adicionados (para não duplicar)
    //     const jaAdicionados = localStorage.getItem('processos-iniciais-adicionados');
    //     if (jaAdicionados) return;
    //
    //     // Adicionar cada processo com dados padrão
    //     numerosProcessos.forEach(numero => {
    //         const novoProcesso = {
    //             id: Date.now() + Math.random(),
    //             numeroProcesso: numero,
    //             assunto: 'A editar',
    //             classeProcessual: 'apelacao-civel',
    //             dataConclusao: new Date().toISOString().split('T')[0],
    //             prioridade: 'normal',
    //             status: 'aguardando-despacho',
    //             observacoes: ''
    //         };
    //         this.processos.push(novoProcesso);
    //     });
    //
    //     // Salvar e marcar como adicionados
    //     this.salvarProcessos();
    //     localStorage.setItem('processos-iniciais-adicionados', 'true');
    // }

    configurarEventos() {
        // Formulário de cadastro
        document.getElementById('processo-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.cadastrarProcesso();
        });

        // Formulário de edição
        document.getElementById('editar-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.salvarEdicao();
        });

        // Formulário de cadastro em lote
        document.getElementById('cadastro-lote-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.processarCadastroLote();
        });

        // Formulário de relatório
        document.getElementById('relatorio-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.gerarRelatorioPDF();
        });

        // Busca com debouncing
        const campoBusca = document.getElementById('busca');
        const btnLimparBusca = document.getElementById('busca-clear-btn');

        // Criar função debounced para filtrar processos
        const filtrarComDebounce = this.debounce(() => {
            this.filtrarProcessos();
        }, 300); // 300ms de delay

        campoBusca.addEventListener('input', () => {
            // Mostrar/ocultar botão X baseado no conteúdo (imediato)
            if (campoBusca.value.trim() !== '') {
                btnLimparBusca.classList.add('visible');
            } else {
                btnLimparBusca.classList.remove('visible');
            }

            // Filtrar com debouncing (delay de 300ms)
            filtrarComDebounce();
        });

        // Botão para limpar busca
        btnLimparBusca.addEventListener('click', () => {
            campoBusca.value = '';
            btnLimparBusca.classList.remove('visible');
            this.filtrarProcessos();
            campoBusca.focus();
        });

        // Modal de edição
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModal());
        });

        // Fechar modal de edição ao clicar fora
        document.getElementById('modal-editar').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModal();
            }
        });

        // Modal de observações
        document.querySelectorAll('.close-modal-obs').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalObservacoes());
        });

        // Fechar modal de observações ao clicar fora
        document.getElementById('modal-observacoes').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalObservacoes();
            }
        });

        // Modal de relatório
        document.querySelectorAll('.close-modal-relatorio').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalRelatorio());
        });

        // Fechar modal de relatório ao clicar fora
        document.getElementById('modal-relatorio').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalRelatorio();
            }
        });

        // Atualizar contagem ao mudar datas
        document.getElementById('relatorio-data-inicial').addEventListener('change', () => this.atualizarContagemRelatorio());
        document.getElementById('relatorio-data-final').addEventListener('change', () => this.atualizarContagemRelatorio());

        // Modal de cadastro em lote
        document.querySelectorAll('.close-modal-lote').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalCadastroLote());
        });

        // Fechar modal de cadastro em lote ao clicar fora
        document.getElementById('modal-cadastro-lote').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalCadastroLote();
            }
        });

        // Atualizar contagem ao digitar números
        document.getElementById('numeros-lote').addEventListener('input', () => this.atualizarContagemLote());

        // Modal de alertas
        document.querySelectorAll('.close-modal-alertas').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalAlertas());
        });

        // Fechar modal de alertas ao clicar fora
        document.getElementById('modal-alertas').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalAlertas();
            }
        });

        // Modal de produção
        document.querySelectorAll('.close-modal-producao').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalProducao());
        });

        // Fechar modal de produção ao clicar fora
        document.getElementById('modal-producao').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalProducao();
            }
        });

        // Modal de heatmap
        document.querySelectorAll('.close-modal-heatmap').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalHeatmap());
        });

        // Fechar modal de heatmap ao clicar fora
        document.getElementById('modal-heatmap')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalHeatmap();
            }
        });

        // Modal de despacho
        document.querySelectorAll('.close-modal-despachar').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalDespachar());
        });

        // Fechar modal de despacho ao clicar fora
        document.getElementById('modal-despachar').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalDespachar();
            }
        });

        // Formulário de despacho
        document.getElementById('despachar-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.confirmarDespacho();
        });

        // Modal de finalização
        document.querySelectorAll('.close-modal-finalizar').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalFinalizar());
        });

        // Fechar modal de finalização ao clicar fora
        document.getElementById('modal-finalizar').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalFinalizar();
            }
        });

        // Formulário de finalização
        document.getElementById('finalizar-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.confirmarFinalizacao();
        });

        // Modal de retorno
        document.querySelectorAll('.close-modal-retornar').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalRetornar());
        });

        // Fechar modal de retorno ao clicar fora
        document.getElementById('modal-retornar').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalRetornar();
            }
        });

        // Formulário de retorno
        document.getElementById('retornar-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.confirmarRetorno();
        });

        // Modal de reabertura de finalizado
        document.querySelectorAll('.close-modal-reabrir-finalizado').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalReabrirFinalizado());
        });

        // Fechar modal de reabertura ao clicar fora
        document.getElementById('modal-reabrir-finalizado').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalReabrirFinalizado();
            }
        });

        // Formulário de reabertura de finalizado
        document.getElementById('reabrir-finalizado-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.confirmarReaberturaFinalizado();
        });

        // Modal de gerenciar classes
        document.querySelectorAll('.close-modal-gerenciar-classes').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalGerenciarClasses());
        });

        document.getElementById('modal-gerenciar-classes').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalGerenciarClasses();
            }
        });

        // Enter no campo de nova classe para adicionar
        document.getElementById('nova-classe').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.adicionarClasse();
            }
        });

        // Modal de gerenciar assuntos
        document.querySelectorAll('.close-modal-gerenciar-assuntos').forEach(btn => {
            btn.addEventListener('click', () => this.fecharModalGerenciarAssuntos());
        });

        document.getElementById('modal-gerenciar-assuntos').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                this.fecharModalGerenciarAssuntos();
            }
        });

        // Enter no campo de novo assunto para adicionar
        document.getElementById('novo-assunto').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.adicionarAssunto();
            }
        });

        // Formulário de adicionar feriado
        document.getElementById('adicionar-feriado-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.adicionarFeriado();
        });

        // Formulário de adicionar férias
        document.getElementById('adicionar-ferias-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.adicionarFerias();
        });

        // ESC para fechar modais (apenas o modal mais no topo)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Fechar apenas o modal que está aberto (ativo)
                // Verificar na ordem inversa de prioridade (último aberto primeiro)
                if (document.getElementById('modal-gerenciar-classes').classList.contains('active')) {
                    this.fecharModalGerenciarClasses();
                } else if (document.getElementById('modal-gerenciar-assuntos').classList.contains('active')) {
                    this.fecharModalGerenciarAssuntos();
                } else if (document.getElementById('modal-reabrir-finalizado').classList.contains('active')) {
                    this.fecharModalReabrirFinalizado();
                } else if (document.getElementById('modal-retornar').classList.contains('active')) {
                    this.fecharModalRetornar();
                } else if (document.getElementById('modal-despachar').classList.contains('active')) {
                    this.fecharModalDespachar();
                } else if (document.getElementById('modal-finalizar').classList.contains('active')) {
                    this.fecharModalFinalizar();
                } else if (document.getElementById('modal-producao').classList.contains('active')) {
                    this.fecharModalProducao();
                } else if (document.getElementById('modal-heatmap')?.classList.contains('active')) {
                    this.fecharModalHeatmap();
                } else if (document.getElementById('modal-alertas').classList.contains('active')) {
                    this.fecharModalAlertas();
                } else if (document.getElementById('modal-cadastro-lote').classList.contains('active')) {
                    this.fecharModalCadastroLote();
                } else if (document.getElementById('modal-relatorio').classList.contains('active')) {
                    this.fecharModalRelatorio();
                } else if (document.getElementById('modal-observacoes').classList.contains('active')) {
                    this.fecharModalObservacoes();
                } else if (document.getElementById('modal-editar').classList.contains('active')) {
                    this.fecharModal();
                } else if (document.getElementById('modal-configuracoes').classList.contains('active')) {
                    this.fecharModalConfiguracoes();
                } else if (document.getElementById('modal-novo-processo').classList.contains('active')) {
                    this.fecharModalNovoProcesso();
                }
            }
        });
    }


    cadastrarProcesso() {
        const numeroProcesso = document.getElementById('numero-processo').value.trim();
        const assunto = document.getElementById('assunto').value.trim();
        const classeProcessual = document.getElementById('classe-processual').value;
        const dataConclusao = document.getElementById('data-conclusao').value;
        const status = document.getElementById('status').value;

        // Validações básicas
        if (!numeroProcesso) {
            alert('O número do processo é obrigatório.');
            return;
        }

        if (!assunto) {
            alert('O assunto é obrigatório.');
            return;
        }

        if (!classeProcessual) {
            alert('A classe processual é obrigatória.');
            return;
        }

        if (!dataConclusao) {
            alert('A data de conclusão é obrigatória.');
            return;
        }

        if (!status) {
            alert('O status é obrigatório.');
            return;
        }

        // Validar se a data de conclusão não é futura
        const hoje = new Date().toISOString().split('T')[0];
        if (dataConclusao > hoje) {
            alert('A data de conclusão não pode ser no futuro.');
            return;
        }

        // Verificar se já existe um processo com o mesmo número
        const processoExistente = this.processos.find(p =>
            p.numeroProcesso && p.numeroProcesso.trim() === numeroProcesso
        );

        if (processoExistente) {
            alert(`Já existe um processo cadastrado com o número "${numeroProcesso}".\nStatus atual: ${this.obterNomeStatus(processoExistente.status)}`);
            return;
        }

        const processo = {
            id: this.gerarIdUnico(),
            numeroProcesso: numeroProcesso,
            assunto: document.getElementById('assunto').value,
            classeProcessual: document.getElementById('classe-processual').value,
            dataConclusao: document.getElementById('data-conclusao').value,
            prioridade: document.getElementById('prioridade').value,
            status: document.getElementById('status').value,
            observacoes: document.getElementById('observacoes').value,
            dataCadastro: new Date().toISOString()
        };

        this.processos.push(processo);

        // Registrar log de criação
        this.adicionarLog(processo.id, 'criacao', 'O processo foi cadastrado no sistema.', {
            numeroProcesso: { depois: processo.numeroProcesso },
            assunto: { depois: this.getAssuntoLabel(processo.assunto) },
            classeProcessual: { depois: this.getClasseProcessualLabel(processo.classeProcessual) },
            dataConclusao: { depois: this.formatarData(processo.dataConclusao) },
            status: { depois: this.getStatusLabel(processo.status) },
            prioridade: { depois: this.getPrioridadeLabel(processo.prioridade) }
        });

        this.salvarProcessos();
        this.renderizarProcessos();
        this.atualizarEstatisticas();

        document.getElementById('processo-form').reset();

        // Fechar modal de novo processo se estiver aberto
        this.fecharModalNovoProcesso();

        this.mostrarNotificacao('Processo cadastrado com sucesso!', 'success');
    }

    editarProcesso(id) {
        const processo = this.encontrarProcessoPorId(id);
        if (!processo) {
            console.error(`Processo não encontrado. ID recebido: ${id} (tipo: ${typeof id})`);
            this.mostrarNotificacao('Erro: Processo não encontrado. Tente recarregar a página.', 'error');
            return;
        }

        this.processoEditandoId = processo.id; // Usar o ID do processo encontrado

        // Abrir modal primeiro para garantir que elementos existam
        this.abrirModal();

        // Usar setTimeout para garantir que o DOM foi atualizado
        setTimeout(() => {
            // Atualizar selects do modal de edição
            this.atualizarSelectEditClasses();
            this.atualizarSelectEditAssuntos();

            // Preencher campos
            document.getElementById('edit-id').value = processo.id;
            document.getElementById('edit-numero-processo').value = processo.numeroProcesso;
            document.getElementById('edit-assunto').value = processo.assunto;
            document.getElementById('edit-classe-processual').value = processo.classeProcessual;
            document.getElementById('edit-data-conclusao').value = processo.dataConclusao;
            document.getElementById('edit-prioridade').value = processo.prioridade;
            document.getElementById('edit-status').value = processo.status;
            document.getElementById('edit-observacoes').value = processo.observacoes || '';

            // Debug: verificar o que foi definido
            console.log('Editando processo:', processo);
            console.log('Classes disponíveis:', this.classesProcessuais);
            console.log('Classe selecionada:', processo.classeProcessual);
            console.log('Valor do select após definir:', document.getElementById('edit-classe-processual').value);
        }, 10);
    }

    salvarEdicao() {
        const id = this.processoEditandoId;
        const processoIndex = this.encontrarIndicePorId(id);

        if (processoIndex === -1) {
            console.error(`Processo não encontrado ao salvar edição. ID: ${id} (tipo: ${typeof id})`);
            this.mostrarNotificacao('Erro: Não foi possível salvar as alterações. Tente recarregar a página.', 'error');
            return;
        }

        const novoNumeroProcesso = document.getElementById('edit-numero-processo').value.trim();
        const novoAssunto = document.getElementById('edit-assunto').value; // SELECT não precisa trim()
        const novaClasseProcessual = document.getElementById('edit-classe-processual').value;
        const novaDataConclusao = document.getElementById('edit-data-conclusao').value;
        const novoStatus = document.getElementById('edit-status').value;

        // Debug
        console.log('Salvando edição:');
        console.log('Assunto selecionado:', novoAssunto);
        console.log('Classe selecionada:', novaClasseProcessual);

        // Validações básicas
        if (!novoNumeroProcesso) {
            alert('O número do processo é obrigatório.');
            return;
        }

        if (!novoAssunto) {
            alert('O assunto é obrigatório.');
            return;
        }

        if (!novaClasseProcessual) {
            alert('A classe processual é obrigatória.');
            return;
        }

        if (!novaDataConclusao) {
            alert('A data de conclusão é obrigatória.');
            return;
        }

        if (!novoStatus) {
            alert('O status é obrigatório.');
            return;
        }

        // Validar se a data de conclusão não é futura
        const hoje = new Date().toISOString().split('T')[0];
        if (novaDataConclusao > hoje) {
            alert('A data de conclusão não pode ser no futuro.');
            return;
        }

        // Verificar se já existe outro processo com o mesmo número
        // Usar o processo atual para garantir compatibilidade de comparação
        const processoAtual = this.processos[processoIndex];
        const processoExistente = this.processos.find(p =>
            p.id !== processoAtual.id && p.numeroProcesso && p.numeroProcesso.trim() === novoNumeroProcesso
        );

        if (processoExistente) {
            alert(`Já existe outro processo cadastrado com o número "${novoNumeroProcesso}".\nStatus: ${this.obterNomeStatus(processoExistente.status)}`);
            return;
        }

        const processoAnterior = {...this.processos[processoIndex]};
        const statusAnterior = this.processos[processoIndex].status;

        this.processos[processoIndex] = {
            ...this.processos[processoIndex],
            numeroProcesso: novoNumeroProcesso,
            assunto: document.getElementById('edit-assunto').value,
            classeProcessual: document.getElementById('edit-classe-processual').value,
            dataConclusao: document.getElementById('edit-data-conclusao').value,
            prioridade: document.getElementById('edit-prioridade').value,
            status: novoStatus,
            observacoes: document.getElementById('edit-observacoes').value,
            dataModificacao: new Date().toISOString()
        };

        // Registrar data de finalização se o status mudou para finalizado
        if (novoStatus === 'finalizado' && statusAnterior !== 'finalizado') {
            this.processos[processoIndex].dataFinalizacao = new Date().toISOString().split('T')[0];
        }

        // Registrar data de despacho se o status mudou para despachado
        if (novoStatus === 'despachado' && statusAnterior !== 'despachado') {
            this.processos[processoIndex].dataDespacho = new Date().toISOString().split('T')[0];
        }

        // Registrar logs de alterações
        const alteracoes = {};
        const processoNovo = this.processos[processoIndex];

        if (processoAnterior.numeroProcesso !== processoNovo.numeroProcesso) {
            alteracoes.numeroProcesso = { antes: processoAnterior.numeroProcesso, depois: processoNovo.numeroProcesso };
        }
        if (processoAnterior.assunto !== processoNovo.assunto) {
            alteracoes.assunto = {
                antes: this.getAssuntoLabel(processoAnterior.assunto),
                depois: this.getAssuntoLabel(processoNovo.assunto)
            };
        }
        if (processoAnterior.classeProcessual !== processoNovo.classeProcessual) {
            alteracoes.classeProcessual = {
                antes: this.getClasseProcessualLabel(processoAnterior.classeProcessual),
                depois: this.getClasseProcessualLabel(processoNovo.classeProcessual)
            };
        }
        if (processoAnterior.dataConclusao !== processoNovo.dataConclusao) {
            alteracoes.dataConclusao = {
                antes: this.formatarData(processoAnterior.dataConclusao),
                depois: this.formatarData(processoNovo.dataConclusao)
            };
        }
        if (processoAnterior.prioridade !== processoNovo.prioridade) {
            alteracoes.prioridade = {
                antes: this.getPrioridadeLabel(processoAnterior.prioridade),
                depois: this.getPrioridadeLabel(processoNovo.prioridade)
            };
        }
        if (processoAnterior.observacoes !== processoNovo.observacoes) {
            alteracoes.observacoes = {
                antes: processoAnterior.observacoes || '(vazio)',
                depois: processoNovo.observacoes || '(vazio)'
            };
        }

        // Se houve mudança de status, registrar como status-change
        if (statusAnterior !== novoStatus) {
            this.adicionarLog(id, 'status-change', 'O status do processo foi alterado durante edição.', {
                status: {
                    antes: this.getStatusLabel(statusAnterior),
                    depois: this.getStatusLabel(novoStatus)
                }
            });
        }

        // Se houve outras alterações, registrar como edição
        if (Object.keys(alteracoes).length > 0) {
            this.adicionarLog(id, 'edicao', 'O processo foi editado e teve os seguintes campos alterados:', alteracoes);
        }

        this.salvarProcessos();

        // Verificar se há filtro ativo e manter o filtro aplicado
        const campoBusca = document.getElementById('busca');
        if (campoBusca && campoBusca.value.trim()) {
            this.filtrarProcessos();
        } else {
            this.renderizarProcessos();
        }

        this.atualizarEstatisticas();
        this.fecharModal();

        this.mostrarNotificacao('Processo atualizado com sucesso!', 'success');
    }

    excluirProcesso(id) {
        // Buscar o processo para mostrar detalhes na confirmação
        const processo = this.encontrarProcessoPorId(id);

        if (!processo) {
            this.mostrarNotificacao('Processo não encontrado.', 'error');
            return;
        }

        // Confirmação detalhada
        const mensagem = `Tem certeza que deseja excluir este processo?\n\n` +
            `Número: ${processo.numeroProcesso}\n` +
            `Assunto: ${this.getAssuntoLabel(processo.assunto)}\n` +
            `Status: ${this.obterNomeStatus(processo.status)}\n` +
            `Classe: ${this.getClasseProcessualLabel(processo.classeProcessual)}\n\n` +
            `⚠️ ATENÇÃO: Esta ação não pode ser desfeita!`;

        if (!confirm(mensagem)) {
            return;
        }

        // Usar o ID do processo encontrado para garantir compatibilidade
        this.processos = this.processos.filter(p => p.id !== processo.id);

        // Limpar histórico do processo excluído
        this.limparHistoricoProcesso(id);

        this.salvarProcessos();
        this.renderizarProcessos();
        this.atualizarEstatisticas();

        this.mostrarNotificacao(`Processo ${processo.numeroProcesso} excluído com sucesso!`, 'success');
    }

    mudarStatusRapido(id, novoStatus) {
        const processo = this.encontrarProcessoPorId(id);
        if (!processo) return;

        // Se for finalizar, abrir o modal
        if (novoStatus === 'finalizado') {
            this.abrirModalFinalizar(id);
            return;
        }

        // Se for despachar, abrir o modal
        if (novoStatus === 'despachado') {
            this.abrirModalDespachar(id);
            return;
        }

        // Se for retornar de despachado para concluso, abrir o modal de retorno
        if (novoStatus === 'concluso' && processo.status === 'despachado') {
            this.abrirModalRetornar(id);
            return;
        }

        // Se for reabrir um processo finalizado, abrir modal pedindo nova data de conclusão
        if (novoStatus === 'concluso' && processo.status === 'finalizado') {
            this.abrirModalReabrirFinalizado(id);
            return;
        }

        // Mensagens de confirmação baseadas na ação
        let mensagemConfirmacao = '';
        let mensagemSucesso = '';

        if (novoStatus === 'concluso') {
            mensagemConfirmacao = 'Deseja retornar este processo para Em Andamento?';
            mensagemSucesso = 'Processo retornado para Em Andamento!';
        }

        if (!confirm(mensagemConfirmacao)) {
            return;
        }

        processo.status = novoStatus;

        // Registrar a data do despacho quando o processo for despachado
        if (novoStatus === 'despachado') {
            processo.dataDespacho = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
        }

        // Registrar data de modificação
        processo.dataModificacao = new Date().toISOString();

        this.salvarProcessos();
        this.renderizarProcessos();
        this.atualizarEstatisticas();

        this.mostrarNotificacao(mensagemSucesso, 'success');
    }

    renderizarProcessos() {
        // PERFORMANCE: Para datasets grandes (>1000 processos), considere implementar:
        // 1. Virtual scrolling (renderizar apenas linhas visíveis no viewport)
        // 2. Paginação (dividir em páginas de 50-100 processos)
        // 3. Lazy loading (carregar processos sob demanda)
        // Bibliotecas sugeridas: react-window, react-virtualized, ou implementação manual com Intersection Observer

        // Limpar tooltips órfãos antes de re-renderizar
        this.limparTooltipsOrfaos();

        // Verificar se há filtro de busca ativo
        const busca = document.getElementById('busca').value.trim();
        if (busca) {
            // Se houver filtro, usar filtrarProcessos para manter o filtro ativo
            this.filtrarProcessos();
            return;
        }

        // Separar processos por status
        const processosAndamento = this.processos.filter(p =>
            p.status === 'aguardando-despacho' || p.status === 'concluso'
        );
        const processosDespachados = this.processos.filter(p => p.status === 'despachado');
        const processosFinalizados = this.processos.filter(p => p.status === 'finalizado');

        // Atualizar prioridades automaticamente para processos em andamento
        this.atualizarPrioridadesAutomaticas(processosAndamento);

        // Atualizar alertas visuais
        this.atualizarAlertas(processosAndamento);

        // Renderizar tabelas
        this.renderizarTabelaAndamento(processosAndamento);
        this.renderizarTabelaDespachados(processosDespachados);
        this.renderizarTabelaFinalizados(processosFinalizados);
    }

    atualizarPrioridadesAutomaticas(processosAndamento) {
        let houveMudanca = false;
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        processosAndamento.forEach(processo => {
            if (!processo.dataConclusao) return;

            const dataConc = new Date(processo.dataConclusao + 'T00:00:00');
            const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));

            // Não alterar se já for "prioridade-advogado"
            if (processo.prioridade === 'prioridade-advogado') {
                return;
            }

            let novaPrioridade = processo.prioridade;

            // >= 89 dias = Crítico (muito-urgente)
            if (diffDias >= ProcessoManager.DIAS_CRITICO) {
                novaPrioridade = 'muito-urgente';
            }
            // >= 70 dias e < 89 = Atenção (urgente)
            else if (diffDias >= ProcessoManager.DIAS_ATENCAO) {
                novaPrioridade = 'urgente';
            }
            // < 70 dias = Normal (apenas se anteriormente era urgente ou muito-urgente)
            else if (processo.prioridade === 'urgente' || processo.prioridade === 'muito-urgente') {
                novaPrioridade = 'normal';
            }

            if (processo.prioridade !== novaPrioridade) {
                processo.prioridade = novaPrioridade;
                houveMudanca = true;
            }
        });

        // Salvar se houve mudanças
        if (houveMudanca) {
            this.salvarProcessos();
        }
    }

    atualizarAlertas(processosAndamento) {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        let criticos = 0;
        let atencao = 0;

        processosAndamento.forEach(processo => {
            if (!processo.dataConclusao) return;

            const dataConc = new Date(processo.dataConclusao + 'T00:00:00');
            const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));

            // Contar processos críticos (>= 89 dias)
            if (diffDias >= ProcessoManager.DIAS_CRITICO) {
                criticos++;
            }
            // Contar processos de atenção (70-88 dias)
            else if (diffDias >= ProcessoManager.DIAS_ATENCAO && diffDias < ProcessoManager.DIAS_CRITICO) {
                atencao++;
            }
        });

        // Calcular produção do mês (apenas finalizados)
        const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        primeiroDiaMes.setHours(0, 0, 0, 0);

        // Contar finalizados no mês (mesmo critério da tabela)
        const producaoMes = this.processos.filter(p => {
            if (p.status !== 'finalizado') return false;
            if (!p.dataFinalizacao) return false;
            const dataFinal = new Date(p.dataFinalizacao + 'T00:00:00');
            return dataFinal >= primeiroDiaMes && dataFinal <= hoje;
        }).length;

        // Calcular processos críticos (usando DIAS_CRITICO)
        const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        ultimoDiaMes.setHours(23, 59, 59, 999);

        // Processos que já são críticos (>= DIAS_CRITICO dias)
        const processosCriticosAtuais = processosAndamento.filter(p => {
            if (!p.dataConclusao) return false;
            const dataConc = new Date(p.dataConclusao + 'T00:00:00');
            const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));
            return diffDias >= ProcessoManager.DIAS_CRITICO;
        }).length;

        // Processos que se tornarão críticos até o fim do mês (mas ainda não são)
        const processosCriticosProximos = processosAndamento.filter(p => {
            if (!p.dataConclusao) return false;
            const dataConc = new Date(p.dataConclusao + 'T00:00:00');
            const diasHoje = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));
            const diasNoFimDoMes = Math.floor((ultimoDiaMes - dataConc) / (1000 * 60 * 60 * 24));

            // Ainda não é crítico, mas será até o fim do mês
            return diasHoje < ProcessoManager.DIAS_CRITICO && diasNoFimDoMes >= ProcessoManager.DIAS_CRITICO;
        }).length;

        // Calcular total de processos críticos (atuais + futuros no mês)
        const processosCriticosTotal = processosCriticosAtuais + processosCriticosProximos;

        // Atualizar números no painel
        document.getElementById('alert-criticos').textContent = criticos;
        document.getElementById('alert-atencao').textContent = atencao;
        document.getElementById('alert-producao-mes').textContent = producaoMes;
        document.getElementById('alert-70dias-atuais').textContent = processosCriticosAtuais;
        document.getElementById('alert-70dias-proximos').textContent = processosCriticosProximos;
        document.getElementById('alert-70dias-total').textContent = processosCriticosTotal;

        // Atualizar descrição do mês
        const nomeMes = hoje.toLocaleDateString('pt-BR', { month: 'short' });
        document.getElementById('alert-producao-desc').textContent = `em ${nomeMes}`;
        document.getElementById('alert-70dias-mes-desc').textContent = `até o fim de ${nomeMes}`;

        // Mostrar/esconder painel de alertas
        const alertsSection = document.getElementById('alerts-section');
        if (criticos > 0 || atencao > 0 || producaoMes > 0 || processosCriticosAtuais > 0 || processosCriticosProximos > 0) {
            alertsSection.classList.remove('hidden');
        } else {
            alertsSection.classList.add('hidden');
        }

        // Atualizar badges do sidebar
        this.atualizarBadgesSidebar();
    }

    renderizarTabelaAndamento(processos) {
        const tbody = document.getElementById('processos-andamento-tbody');

        if (processos.length === 0) {
            tbody.innerHTML = `
                <tr class="empty-state">
                    <td colspan="8" class="text-center">
                        Nenhum processo em andamento.
                    </td>
                </tr>
            `;
            return;
        }

        // PERFORMANCE: Esta operação renderiza TODOS os processos de uma vez.
        // Com >500 processos, pode haver lag. Considere virtual scrolling ou paginação.
        const processosOrdenados = this.ordenarProcessos(processos, 'andamento');


        tbody.innerHTML = processosOrdenados.map((processo, index) =>
            this.gerarLinhaProcesso(processo, true, true, index < 10)
        ).join('');
        this.atualizarIndicadoresOrdenacao('andamento');
    }

    renderizarTabelaDespachados(processos) {
        const tbody = document.getElementById('processos-despachados-tbody');

        if (processos.length === 0) {
            tbody.innerHTML = `
                <tr class="empty-state">
                    <td colspan="6" class="text-center">
                        Nenhum processo despachado.
                    </td>
                </tr>
            `;
            return;
        }

        // PERFORMANCE: Renderização completa pode ser lenta com muitos processos
        const processosOrdenados = this.ordenarProcessos(processos, 'despachados');
        tbody.innerHTML = processosOrdenados.map(processo => this.gerarLinhaProcesso(processo, false, false)).join('');
        this.atualizarIndicadoresOrdenacao('despachados');
    }

    renderizarTabelaFinalizados(processos) {
        const busca = document.getElementById('busca').value.trim();

        // Se houver busca ativa, usar modo simplificado
        if (busca) {
            // Garantir que a tabela de finalizados esteja expandida quando houver busca
            const contentFinalizados = document.getElementById('table-content-finalizados');
            const iconFinalizados = document.getElementById('toggle-icon-finalizados');
            if (contentFinalizados && contentFinalizados.classList.contains('collapsed')) {
                contentFinalizados.classList.remove('collapsed');
                if (iconFinalizados) {
                    iconFinalizados.textContent = '▼';
                }
            }
            this.renderizarFinalizadosModoSimplificado(processos);
        } else {
            // Usar o sistema de abas normal
            this.inicializarSistemaFinalizados();
        }
    }

    renderizarFinalizadosModoSimplificado(processos) {
        const container = document.getElementById('finalizados-tabs-content');

        if (!container) {
            console.error('Container finalizados-tabs-content não encontrado');
            return;
        }

        if (processos.length === 0) {
            container.innerHTML = `
                <div class="finalizados-empty-state">
                    <div class="finalizados-empty-state-icon">🔍</div>
                    <p class="finalizados-empty-state-text">Nenhum processo finalizado encontrado</p>
                    <p class="finalizados-empty-state-subtext">Tente outro termo de busca</p>
                </div>
            `;
            // Esconder sistema de abas durante a busca
            const filterContainer = document.querySelector('.finalizados-filter-container');
            if (filterContainer) {
                filterContainer.style.display = 'none';
            }
            return;
        }

        // Esconder sistema de abas durante a busca
        const filterContainer = document.querySelector('.finalizados-filter-container');
        if (filterContainer) {
            filterContainer.style.display = 'none';
        }

        // Ordenar processos por data de finalização (mais recentes primeiro)
        const processosOrdenados = [...processos].sort((a, b) => {
            const dataA = new Date(a.dataFinalizacao || a.dataConclusao);
            const dataB = new Date(b.dataFinalizacao || b.dataConclusao);
            return dataB - dataA;
        });

        // PERFORMANCE: Renderizar todos os resultados pode ser lento se a busca retornar centenas de processos
        // Renderizar tabela simplificada
        // Parâmetros: mostrarDiasConclusos=false, mostrarPrioridade=false, isPrimeirasDezLinhas=false, mostrarStatus=false
        const linhas = processosOrdenados.map(processo => this.gerarLinhaProcesso(processo, false, false, false, false)).join('');

        container.innerHTML = `
            <div class="finalizados-info-bar">
                🔍 Mostrando ${processos.length} processo(s) finalizado(s) encontrado(s)
            </div>
            <div class="table-responsive">
                <table aria-label="Tabela de processos finalizados filtrados">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Assunto</th>
                            <th>Classe processual</th>
                            <th>Data de Finalização</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${linhas}
                    </tbody>
                </table>
            </div>
        `;
    }

    gerarLinhaProcesso(processo, mostrarDiasConclusos = true, mostrarPrioridade = true, isPrimeirasDezLinhas = false, mostrarStatus = true) {
        // Validar processo tem campos obrigatórios
        if (!processo || !processo.id || !processo.numeroProcesso) {
            console.error('Processo inválido encontrado:', processo);
            return ''; // Retorna string vazia ao invés de crashar
        }

        // Garantir valores padrão para campos opcionais
        processo.assunto = processo.assunto || 'Sem assunto';
        processo.classeProcessual = processo.classeProcessual || 'apelacao-civel';
        processo.status = processo.status || 'aguardando-despacho';
        processo.prioridade = processo.prioridade || 'normal';
        processo.observacoes = processo.observacoes || '';

        // Gerar botões de ação rápida baseados no status
        let botoesAcaoRapida = '';
        let mostrarBotaoExcluir = true;

        if (processo.status === 'aguardando-despacho' || processo.status === 'concluso') {
            // Processos em Andamento
            botoesAcaoRapida = `
                <button class="btn btn-despachar" onclick="manager.mudarStatusRapido(${processo.id}, 'despachado')" aria-label="Despachar processo ${this.escaparHTML(processo.numeroProcesso)}" title="Despachar">
                    📤
                </button>
                <button class="btn btn-success" onclick="manager.mudarStatusRapido(${processo.id}, 'finalizado')" aria-label="Finalizar processo ${this.escaparHTML(processo.numeroProcesso)}" title="Finalizar">
                    ✅
                </button>
            `;
            mostrarBotaoExcluir = true; // Mostrar botão excluir em processos em andamento
        } else if (processo.status === 'despachado') {
            // Processos Despachados
            botoesAcaoRapida = `
                <button class="btn btn-return" onclick="manager.mudarStatusRapido(${processo.id}, 'concluso')" aria-label="Retornar processo ${this.escaparHTML(processo.numeroProcesso)}" title="Retornar">
                    ↩️
                </button>
            `;
        } else if (processo.status === 'finalizado') {
            // Processos Finalizados
            botoesAcaoRapida = `
                <button class="btn btn-return" onclick="manager.mudarStatusRapido(${processo.id}, 'concluso')" aria-label="Reabrir processo ${this.escaparHTML(processo.numeroProcesso)}" title="Reabrir">
                    ↩️
                </button>
            `;
            mostrarBotaoExcluir = false; // Não mostrar botão excluir em processos finalizados
        }

        // Determinar qual data mostrar
        let dataExibir = '';
        if (processo.status === 'despachado' && processo.dataDespacho) {
            dataExibir = this.formatarData(processo.dataDespacho);
        } else if (processo.status === 'finalizado' && processo.dataFinalizacao) {
            dataExibir = this.formatarData(processo.dataFinalizacao);
        } else {
            dataExibir = this.formatarData(processo.dataConclusao);
        }

        // Coluna de Dias Conclusos (opcional)
        const colunaDiasConclusos = mostrarDiasConclusos
            ? `<td>${this.renderizarDiasConclusosBadge(processo.dataConclusao)}</td>`
            : '';

        // Coluna de Prioridade (opcional)
        const colunaPrioridade = mostrarPrioridade
            ? `<td>${this.renderizarPrioridadeBadge(processo.prioridade)}</td>`
            : '';

        // Coluna de Status (opcional)
        const colunaStatus = mostrarStatus
            ? `<td>${this.renderizarStatusBadge(processo.status)}</td>`
            : '';

        // Botão de excluir (condicional)
        const botaoExcluir = mostrarBotaoExcluir
            ? `<button class="btn btn-danger" onclick="manager.excluirProcesso(${processo.id})" aria-label="Excluir processo ${this.escaparHTML(processo.numeroProcesso)}" title="Excluir">
                   🗑️
               </button>`
            : '';

        // Preparar observações para o tooltip
        const observacoes = processo.observacoes && processo.observacoes.trim()
            ? this.escaparHTML(processo.observacoes)
            : '';
        const tooltipClass = observacoes ? '' : 'sem-observacoes';
        const tooltipTexto = observacoes || 'Sem observações cadastradas';

        return `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                        <div class="processo-numero-wrapper" onmouseenter="manager.posicionarTooltip(event, this)" onmouseleave="manager.esconderTooltip(this)">
                            <a href="#" class="processo-link" onclick="manager.mostrarObservacoes(${processo.id}); return false;" aria-label="Ver observações do processo ${this.escaparHTML(processo.numeroProcesso)}">
                                <strong>${this.escaparHTML(processo.numeroProcesso)}</strong>
                            </a>
                            <div class="tooltip-observacoes ${tooltipClass}">
                                ${tooltipTexto}
                            </div>
                        </div>
                        <button class="btn-copiar" onclick="manager.copiarPorId(${processo.id}, event)" aria-label="Copiar número do processo" title="Copiar número">
                            📋
                        </button>
                    </div>
                </td>
                <td>${this.escaparHTML(this.getAssuntoLabel(processo.assunto))}</td>
                <td>${this.renderizarClasseProcessualBadge(processo.classeProcessual)}</td>
                <td>${dataExibir}</td>
                ${colunaDiasConclusos}
                ${colunaStatus}
                ${colunaPrioridade}
                <td>
                    <div class="action-buttons ${processo.status === 'finalizado' ? 'action-buttons-horizontal' : ''}">
                        <button class="btn btn-historico" onclick="manager.abrirHistoricoProcesso(${processo.id})" aria-label="Ver histórico do processo ${this.escaparHTML(processo.numeroProcesso)}" title="Histórico">
                            📜
                        </button>
                        ${botoesAcaoRapida}
                        <button class="btn btn-edit" onclick="manager.editarProcesso(${processo.id})" aria-label="Editar processo ${this.escaparHTML(processo.numeroProcesso)}" title="Editar">
                            ✏️
                        </button>
                        ${botaoExcluir}
                    </div>
                </td>
            </tr>
        `;
    }

    ordenarPor(tabela, campo) {
        // Se clicar no mesmo campo, inverte a ordem
        if (this.ordenacao[tabela].campo === campo) {
            this.ordenacao[tabela].crescente = !this.ordenacao[tabela].crescente;
        } else {
            // Se for um campo novo, usa ordem padrão baseada no tipo
            this.ordenacao[tabela].campo = campo;
            this.ordenacao[tabela].crescente = this.getOrdemPadrao(campo);
        }

        this.salvarPreferenciasOrdenacao();
        this.renderizarProcessos();
    }

    getOrdemPadrao(campo) {
        // Datas e dias conclusos: mais recente primeiro (decrescente)
        if (campo.includes('data') || campo === 'diasConclusos') {
            return false;
        }
        // Texto: ordem alfabética (crescente)
        return true;
    }

    ordenarProcessos(processos, tabela) {
        const { campo, crescente } = this.ordenacao[tabela];
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        return [...processos].sort((a, b) => {
            let valorA, valorB;

            switch(campo) {
                case 'numero':
                    valorA = a.numeroProcesso;
                    valorB = b.numeroProcesso;
                    break;
                case 'assunto':
                    valorA = a.assunto.toLowerCase();
                    valorB = b.assunto.toLowerCase();
                    break;
                case 'classe':
                    valorA = a.classeProcessual;
                    valorB = b.classeProcessual;
                    break;
                case 'dataConclusao':
                    valorA = new Date((a.dataConclusao || '1900-01-01') + 'T00:00:00');
                    valorB = new Date((b.dataConclusao || '1900-01-01') + 'T00:00:00');
                    break;
                case 'dataDespacho':
                    valorA = new Date((a.dataDespacho || '1900-01-01') + 'T00:00:00');
                    valorB = new Date((b.dataDespacho || '1900-01-01') + 'T00:00:00');
                    break;
                case 'dataFinalizacao':
                    valorA = new Date((a.dataFinalizacao || '1900-01-01') + 'T00:00:00');
                    valorB = new Date((b.dataFinalizacao || '1900-01-01') + 'T00:00:00');
                    break;
                case 'diasConclusos':
                    valorA = a.dataConclusao ? Math.floor((hoje - new Date(a.dataConclusao + 'T00:00:00')) / (1000 * 60 * 60 * 24)) : -1;
                    valorB = b.dataConclusao ? Math.floor((hoje - new Date(b.dataConclusao + 'T00:00:00')) / (1000 * 60 * 60 * 24)) : -1;
                    break;
                case 'status':
                    valorA = a.status;
                    valorB = b.status;
                    break;
                case 'prioridade':
                    // Ordem de prioridade: muito-urgente > urgente > prioridade-advogado > normal
                    const ordemPrioridade = {
                        'muito-urgente': 4,
                        'urgente': 3,
                        'prioridade-advogado': 2,
                        'normal': 1
                    };
                    valorA = ordemPrioridade[a.prioridade] || 0;
                    valorB = ordemPrioridade[b.prioridade] || 0;
                    break;
                default:
                    valorA = a[campo];
                    valorB = b[campo];
            }

            // Comparação
            let resultado = 0;
            if (valorA < valorB) resultado = -1;
            if (valorA > valorB) resultado = 1;

            return crescente ? resultado : -resultado;
        });
    }

    atualizarIndicadoresOrdenacao(tabela) {
        const { campo, crescente } = this.ordenacao[tabela];

        // Limpar todos os indicadores da tabela
        const campos = tabela === 'andamento'
            ? ['numero', 'assunto', 'classe', 'dataConclusao', 'diasConclusos', 'status', 'prioridade']
            : ['numero', 'assunto', 'classe', tabela === 'despachados' ? 'dataDespacho' : 'dataFinalizacao', 'status'];

        campos.forEach(c => {
            const indicator = document.getElementById(`sort-${tabela}-${c}`);
            if (indicator) {
                indicator.textContent = c === campo ? (crescente ? '▲' : '▼') : '';
            }
        });
    }

    toggleTabela(tipo) {
        const content = document.getElementById(`table-content-${tipo}`);
        const icon = document.getElementById(`toggle-icon-${tipo}`);

        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            icon.textContent = '▼';
        } else {
            content.classList.add('collapsed');
            icon.textContent = '▶';
        }
    }

    filtrarProcessos() {
        const buscaOriginal = document.getElementById('busca').value;
        const busca = this.normalizarTexto(buscaOriginal);

        const processosFiltrados = this.processos.filter(processo => {
            // Normalizar os campos do processo para comparação sem acentos
            const numeroNormalizado = this.normalizarTexto(processo.numeroProcesso);
            const assuntoNormalizado = this.normalizarTexto(this.getAssuntoLabel(processo.assunto));

            const matchBusca = !busca ||
                numeroNormalizado.includes(busca) ||
                assuntoNormalizado.includes(busca);

            return matchBusca;
        });

        // Separar processos filtrados por status
        const processosAndamento = processosFiltrados.filter(p =>
            p.status === 'aguardando-despacho' || p.status === 'concluso'
        );
        const processosDespachados = processosFiltrados.filter(p => p.status === 'despachado');
        const processosFinalizados = processosFiltrados.filter(p => p.status === 'finalizado');

        // Expandir tabelas automaticamente se houver busca e resultados
        if (busca) {
            // Expandir tabela de andamento se houver resultados
            if (processosAndamento.length > 0) {
                const contentAndamento = document.getElementById('table-content-andamento');
                const iconAndamento = document.getElementById('toggle-icon-andamento');
                if (contentAndamento.classList.contains('collapsed')) {
                    contentAndamento.classList.remove('collapsed');
                    iconAndamento.textContent = '▼';
                }
            }

            // Expandir tabela de despachados se houver resultados
            if (processosDespachados.length > 0) {
                const contentDespachados = document.getElementById('table-content-despachados');
                const iconDespachados = document.getElementById('toggle-icon-despachados');
                if (contentDespachados.classList.contains('collapsed')) {
                    contentDespachados.classList.remove('collapsed');
                    iconDespachados.textContent = '▼';
                }
            }

            // Expandir tabela de finalizados se houver resultados
            if (processosFinalizados.length > 0) {
                const contentFinalizados = document.getElementById('table-content-finalizados');
                const iconFinalizados = document.getElementById('toggle-icon-finalizados');
                if (contentFinalizados.classList.contains('collapsed')) {
                    contentFinalizados.classList.remove('collapsed');
                    iconFinalizados.textContent = '▼';
                }
            }
        }

        // Atualizar alertas com TODOS os processos (não filtrados)
        const todosProcessosAndamento = this.processos.filter(p =>
            p.status === 'aguardando-despacho' || p.status === 'concluso'
        );
        this.atualizarAlertas(todosProcessosAndamento);

        this.renderizarTabelaAndamento(processosAndamento);
        this.renderizarTabelaDespachados(processosDespachados);
        this.renderizarTabelaFinalizados(processosFinalizados);

        this.atualizarEstatisticas();
    }

    renderizarStatusBadge(status) {
        const labels = {
            'aguardando-despacho': 'Aguardando despacho',
            'concluso': 'Concluso para julgamento',
            'despachado': 'Despachado',
            'finalizado': 'Finalizado'
        };

        return `<span class="status-badge status-${status}">${labels[status]}</span>`;
    }

    renderizarPrioridadeBadge(prioridade) {
        const labels = {
            'normal': 'Normal',
            'urgente': 'Urgente',
            'muito-urgente': 'Muito Urgente',
            'prioridade-advogado': 'Prioridade a pedido do advogado'
        };

        return `<span class="prioridade-badge prioridade-${prioridade}">${labels[prioridade]}</span>`;
    }

    renderizarClasseProcessualBadge(classeProcessual) {
        // Usar a função getClasseProcessualLabel para buscar o nome correto
        const label = this.getClasseProcessualLabel(classeProcessual);
        return `<span class="status-badge">${label}</span>`;
    }


    atualizarEstatisticas() {
        const emAndamento = this.processos.filter(p =>
            p.status === 'aguardando-despacho' || p.status === 'concluso'
        ).length;

        document.getElementById('em-andamento').textContent = emAndamento;
    }

    abrirModal() {
        const modal = document.getElementById('modal-editar');
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModal() {
        const modal = document.getElementById('modal-editar');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        this.processoEditandoId = null;
    }

    mostrarObservacoes(id) {
        const processo = this.encontrarProcessoPorId(id);
        if (!processo) return;

        document.getElementById('obs-numero').textContent = processo.numeroProcesso;
        document.getElementById('obs-assunto').textContent = this.getAssuntoLabel(processo.assunto);
        document.getElementById('obs-texto').textContent = processo.observacoes || 'Nenhuma observação cadastrada para este processo.';

        this.abrirModalObservacoes();
    }

    abrirModalObservacoes() {
        const modal = document.getElementById('modal-observacoes');
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalObservacoes() {
        const modal = document.getElementById('modal-observacoes');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    abrirModalRelatorio() {
        const modal = document.getElementById('modal-relatorio');

        // Definir data padrão: primeiro dia do mês atual até hoje
        const hoje = new Date();
        const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);

        document.getElementById('relatorio-data-inicial').value = primeiroDiaMes.toISOString().split('T')[0];
        document.getElementById('relatorio-data-final').value = hoje.toISOString().split('T')[0];

        this.atualizarContagemRelatorio();

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalRelatorio() {
        const modal = document.getElementById('modal-relatorio');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    abrirModalCadastroLote() {
        const modal = document.getElementById('modal-cadastro-lote');

        // Limpar textarea e input de arquivo
        document.getElementById('numeros-lote').value = '';
        document.getElementById('preview-count-lote').textContent = '';
        document.getElementById('arquivo-excel-lote').value = '';

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalCadastroLote() {
        const modal = document.getElementById('modal-cadastro-lote');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    processarArquivoExcel(input) {
        const arquivo = input.files[0];
        if (!arquivo) return;

        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const dados = new Uint8Array(e.target.result);
                const workbook = XLSX.read(dados, { type: 'array' });

                // Pegar a primeira planilha
                const primeiraPlanilha = workbook.Sheets[workbook.SheetNames[0]];

                // Converter para JSON
                const linhas = XLSX.utils.sheet_to_json(primeiraPlanilha, { header: 1 });

                // Processar linhas (ignorar cabeçalho se existir)
                const processosTexto = [];

                for (let i = 0; i < linhas.length; i++) {
                    const linha = linhas[i];
                    if (!linha || linha.length < 2) continue;

                    let numeroProcesso = linha[0];
                    let dataConclusao = linha[1];

                    // Pular se parecer ser cabeçalho
                    if (typeof numeroProcesso === 'string' &&
                        (numeroProcesso.toLowerCase().includes('processo') ||
                         numeroProcesso.toLowerCase().includes('número') ||
                         numeroProcesso.toLowerCase().includes('numero'))) {
                        continue;
                    }

                    // Converter número do processo para string
                    numeroProcesso = String(numeroProcesso).trim();

                    // Tratar a data
                    let dataFormatada = '';
                    if (dataConclusao instanceof Date) {
                        // Se for objeto Date
                        const dia = String(dataConclusao.getDate()).padStart(2, '0');
                        const mes = String(dataConclusao.getMonth() + 1).padStart(2, '0');
                        const ano = dataConclusao.getFullYear();
                        dataFormatada = `${dia}/${mes}/${ano}`;
                    } else if (typeof dataConclusao === 'number') {
                        // Se for número serial do Excel
                        const dataConvertida = XLSX.SSF.parse_date_code(dataConclusao);
                        if (dataConvertida) {
                            const dia = String(dataConvertida.d).padStart(2, '0');
                            const mes = String(dataConvertida.m).padStart(2, '0');
                            const ano = dataConvertida.y;
                            dataFormatada = `${dia}/${mes}/${ano}`;
                        }
                    } else if (typeof dataConclusao === 'string') {
                        // Se já for string, tentar usar diretamente
                        dataFormatada = dataConclusao.trim();
                    }

                    if (numeroProcesso && dataFormatada) {
                        processosTexto.push(`${numeroProcesso} ${dataFormatada}`);
                    }
                }

                if (processosTexto.length > 0) {
                    // Preencher o textarea com os dados
                    document.getElementById('numeros-lote').value = processosTexto.join('\n');
                    // Atualizar contagem
                    this.atualizarContagemLote();
                    this.mostrarNotificacao(`${processosTexto.length} processos importados do Excel!`, 'success');
                } else {
                    this.mostrarNotificacao('Nenhum processo válido encontrado na planilha.', 'warning');
                }

            } catch (erro) {
                console.error('Erro ao processar Excel:', erro);
                this.mostrarNotificacao('Erro ao processar arquivo Excel. Verifique o formato.', 'error');
            }
        };

        reader.onerror = () => {
            this.mostrarNotificacao('Erro ao ler o arquivo.', 'error');
        };

        reader.readAsArrayBuffer(arquivo);
    }

    abrirModalAlertas(tipo) {
        const modal = document.getElementById('modal-alertas');
        const titulo = document.getElementById('modal-alertas-title');
        const descricao = document.getElementById('modal-alertas-descricao');
        const tbody = document.getElementById('modal-alertas-tbody');
        const colData = document.getElementById('modal-alertas-col-data');
        const colDias = document.getElementById('modal-alertas-col-dias');

        // Pegar processos em andamento
        const processosAndamento = this.processos.filter(p =>
            p.status === 'aguardando-despacho' || p.status === 'concluso'
        );

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        let processosFiltrados = [];
        let tituloTexto = '';
        let descricaoTexto = '';

        if (tipo === 'criticos') {
            // Processos >= 89 dias
            processosFiltrados = processosAndamento.filter(p => {
                if (!p.dataConclusao) return false;
                const dataConc = new Date(p.dataConclusao + 'T00:00:00');
                const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));
                return diffDias >= ProcessoManager.DIAS_CRITICO;
            });

            // Ordenar por data crescente (mais antigo primeiro - mais dias conclusos)
            processosFiltrados.sort((a, b) => {
                const dataA = new Date(a.dataConclusao + 'T00:00:00');
                const dataB = new Date(b.dataConclusao + 'T00:00:00');
                return dataA - dataB;
            });

            tituloTexto = '🚨 Processos Críticos';
            descricaoTexto = `Processos com ${ProcessoManager.DIAS_CRITICO} dias ou mais conclusos. Total: ${processosFiltrados.length}`;
            colData.textContent = 'Data da Conclusão';
            colDias.textContent = 'Dias conclusos';
        } else if (tipo === 'atencao') {
            // Processos entre 70 e 88 dias
            processosFiltrados = processosAndamento.filter(p => {
                if (!p.dataConclusao) return false;
                const dataConc = new Date(p.dataConclusao + 'T00:00:00');
                const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));
                return diffDias >= ProcessoManager.DIAS_ATENCAO && diffDias < ProcessoManager.DIAS_CRITICO;
            });

            // Ordenar por data crescente (mais antigo primeiro - mais dias conclusos)
            processosFiltrados.sort((a, b) => {
                const dataA = new Date(a.dataConclusao + 'T00:00:00');
                const dataB = new Date(b.dataConclusao + 'T00:00:00');
                return dataA - dataB;
            });

            tituloTexto = '⚠️ Processos de Atenção';
            descricaoTexto = `Processos entre ${ProcessoManager.DIAS_ATENCAO} e ${ProcessoManager.DIAS_CRITICO - 1} dias conclusos. Total: ${processosFiltrados.length}`;
            colData.textContent = 'Data da Conclusão';
            colDias.textContent = 'Dias conclusos';
        } else if (tipo === 'producao') {
            // Processos finalizados no mês atual (mesmo critério da tabela)
            const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            primeiroDiaMes.setHours(0, 0, 0, 0);
            const nomeMes = hoje.toLocaleDateString('pt-BR', { month: 'long' });

            processosFiltrados = this.processos.filter(p => {
                if (p.status !== 'finalizado') return false;
                if (!p.dataFinalizacao) return false;
                const dataFinal = new Date(p.dataFinalizacao + 'T00:00:00');
                return dataFinal >= primeiroDiaMes && dataFinal <= hoje;
            });

            // Ordenar por data crescente (mais antiga primeiro)
            processosFiltrados.sort((a, b) => {
                const dataA = new Date(a.dataFinalizacao + 'T00:00:00');
                const dataB = new Date(b.dataFinalizacao + 'T00:00:00');
                return dataA - dataB; // Ordem crescente
            });

            tituloTexto = '📊 Produção do Mês';
            descricaoTexto = `Processos finalizados em ${nomeMes}. Total: ${processosFiltrados.length}`;
            colData.textContent = 'Data de Finalização';
            // Não ocultar aqui, será feito depois no bloco de renderização
        } else if (tipo === 'meta') {
            // Processos que atingirão nível de Atenção (DIAS_ATENCAO) até o fim do mês
            const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            ultimoDiaMes.setHours(23, 59, 59, 999);
            const nomeMes = hoje.toLocaleDateString('pt-BR', { month: 'long' });

            processosFiltrados = processosAndamento.filter(p => {
                if (!p.dataConclusao) return false;
                const dataConc = new Date(p.dataConclusao + 'T00:00:00');
                const diasNoFimDoMes = Math.floor((ultimoDiaMes - dataConc) / (1000 * 60 * 60 * 24));
                return diasNoFimDoMes >= ProcessoManager.DIAS_ATENCAO;
            });
            tituloTexto = '🎯 Meta do Mês';
            descricaoTexto = `Processos que devem ser feitos em ${nomeMes} para evitar atingir ${ProcessoManager.DIAS_ATENCAO} dias. Total: ${processosFiltrados.length}`;
            colData.textContent = 'Data da Conclusão';
            colDias.textContent = 'Dias conclusos';
        } else if (tipo === 'urgentes') {
            // Processos urgentes ou muito urgentes
            processosFiltrados = processosAndamento.filter(p =>
                p.prioridade === 'urgente' || p.prioridade === 'muito-urgente'
            );
            tituloTexto = '⏰ Prioridades Urgentes';
            descricaoTexto = `Processos com prioridade Urgente ou Muito Urgente. Total: ${processosFiltrados.length}`;
            colData.textContent = 'Data da Conclusão';
            colDias.textContent = 'Dias conclusos';
        } else if (tipo === '70dias') {
            // Processos críticos (atuais + próximos que se tornarão críticos no mês)
            const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            ultimoDiaMes.setHours(23, 59, 59, 999);

            processosFiltrados = processosAndamento.filter(p => {
                if (!p.dataConclusao) return false;
                const dataConc = new Date(p.dataConclusao + 'T00:00:00');
                const diasNoFimDoMes = Math.floor((ultimoDiaMes - dataConc) / (1000 * 60 * 60 * 24));
                // Inclui processos que já são críticos OU que serão até o fim do mês
                return diasNoFimDoMes >= ProcessoManager.DIAS_CRITICO;
            });

            // Ordenar por dias conclusos (mais antigo primeiro)
            processosFiltrados.sort((a, b) => {
                const dataA = new Date(a.dataConclusao + 'T00:00:00');
                const dataB = new Date(b.dataConclusao + 'T00:00:00');
                return dataA - dataB;
            });

            tituloTexto = `🚨 Processos Críticos (${ProcessoManager.DIAS_CRITICO}+ dias)`;
            descricaoTexto = `Processos que já são críticos ou que atingirão nível crítico até o final do mês. Total: ${processosFiltrados.length}`;
            colData.textContent = 'Data da Conclusão';
            colDias.textContent = 'Dias conclusos';
        }

        titulo.textContent = tituloTexto;
        descricao.textContent = descricaoTexto;

        // Ocultar/mostrar colunas baseado no tipo
        const colPrioridade = document.getElementById('modal-alertas-col-prioridade');
        if (tipo === 'producao') {
            // Ocultar colunas para produção
            colDias.style.display = 'none';
            if (colPrioridade) colPrioridade.style.display = 'none';
        } else {
            // Mostrar colunas para outros tipos
            colDias.style.display = '';
            if (colPrioridade) colPrioridade.style.display = '';
        }

        // Renderizar tabela
        if (processosFiltrados.length === 0) {
            // Calcular colspan baseado nas colunas visíveis
            // Para produção: 4 colunas (sem Dias conclusos e Prioridade)
            // Para outros tipos: 6 colunas (todas visíveis)
            const colspan = tipo === 'producao' ? 4 : 6;

            tbody.innerHTML = `
                <tr class="empty-state">
                    <td colspan="${colspan}" class="text-center">
                        Nenhum processo encontrado nesta categoria.
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = processosFiltrados.map(p => {
                // Para tipo 'producao', usar dataFinalizacao ao invés de dataConclusao
                const dataExibir = tipo === 'producao' ? p.dataFinalizacao : p.dataConclusao;

                // Para produção, não mostrar colunas de dias e prioridade
                if (tipo === 'producao') {
                    return `
                        <tr>
                            <td><strong>${p.numeroProcesso}</strong></td>
                            <td>${this.escaparHTML(this.getAssuntoLabel(p.assunto))}</td>
                            <td>${this.renderizarClasseProcessualBadge(p.classeProcessual)}</td>
                            <td>${this.formatarData(dataExibir)}</td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr>
                            <td><strong>${p.numeroProcesso}</strong></td>
                            <td>${this.escaparHTML(this.getAssuntoLabel(p.assunto))}</td>
                            <td>${this.renderizarClasseProcessualBadge(p.classeProcessual)}</td>
                            <td>${this.formatarData(dataExibir)}</td>
                            <td>${this.renderizarDiasConclusosBadge(dataExibir)}</td>
                            <td>${this.renderizarPrioridadeBadge(p.prioridade)}</td>
                        </tr>
                    `;
                }
            }).join('');
        }

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalAlertas() {
        const modal = document.getElementById('modal-alertas');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }


    atualizarContagemLote() {
        const texto = document.getElementById('numeros-lote').value;
        const linhas = texto.split('\n').filter(linha => linha.trim() !== '');

        if (linhas.length === 0) {
            document.getElementById('preview-count-lote').textContent = '';
            return;
        }

        // Validar cada linha
        let validos = 0;
        let invalidos = 0;

        linhas.forEach((linha) => {
            const partes = linha.trim().split(/\s+/);

            // Precisa ter pelo menos número e data
            if (partes.length < 2) {
                invalidos++;
                return;
            }

            // Validar formato da data (DD/MM/AAAA)
            const data = partes[partes.length - 1];
            const regexData = /^(\d{2})\/(\d{2})\/(\d{4})$/;

            if (regexData.test(data)) {
                validos++;
            } else {
                invalidos++;
            }
        });

        const previewElement = document.getElementById('preview-count-lote');

        if (validos === 0 && invalidos > 0) {
            previewElement.textContent = `⚠️ ${invalidos} linha(s) com formato inválido. Use: Número Data`;
            previewElement.style.color = '#dc2626';
        } else if (invalidos > 0) {
            previewElement.textContent = `✓ ${validos} válido(s) | ⚠️ ${invalidos} inválido(s)`;
            previewElement.style.color = '#f59e0b';
        } else if (validos === 1) {
            previewElement.textContent = '✓ 1 processo será cadastrado.';
            previewElement.style.color = '#16a34a';
        } else {
            previewElement.textContent = `✓ ${validos} processos serão cadastrados.`;
            previewElement.style.color = '#16a34a';
        }
    }

    processarCadastroLote() {
        const texto = document.getElementById('numeros-lote').value;
        const classeProcessual = document.getElementById('lote-classe-processual').value;
        const prioridade = document.getElementById('lote-prioridade').value;
        const status = document.getElementById('lote-status').value;

        // Processar linhas e extrair número + data
        const linhas = texto
            .split('\n')
            .map(linha => linha.trim())
            .filter(linha => linha !== '');

        if (linhas.length === 0) {
            alert('Por favor, insira pelo menos um processo com sua data.');
            return;
        }

        // Fazer parsing de cada linha
        const processosParaCadastrar = [];
        const erros = [];

        linhas.forEach((linha, index) => {
            // Separar número e data (último espaço)
            const partes = linha.split(/\s+/);

            if (partes.length < 2) {
                erros.push(`Linha ${index + 1}: Formato inválido (falta data ou número)`);
                return;
            }

            // Pegar a data (último elemento) e o número (todo o resto)
            const data = partes[partes.length - 1];
            const numeroProcesso = partes.slice(0, -1).join(' ');

            // Validar formato da data (DD/MM/AAAA)
            const regexData = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = data.match(regexData);

            if (!match) {
                erros.push(`Linha ${index + 1}: Data inválida (use DD/MM/AAAA)`);
                return;
            }

            const [_, dia, mes, ano] = match;

            // Converter para formato YYYY-MM-DD
            const dataConclusao = `${ano}-${mes}-${dia}`;

            // Validar se a data é válida
            const dataObj = new Date(dataConclusao + 'T00:00:00');
            if (isNaN(dataObj.getTime())) {
                erros.push(`Linha ${index + 1}: Data inválida`);
                return;
            }

            // Validar se a data não é futura
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            if (dataObj > hoje) {
                erros.push(`Linha ${index + 1}: Data de conclusão não pode ser no futuro (${data})`);
                return;
            }

            // Validar range de data (não aceitar datas muito antigas)
            const ano1900 = new Date('1900-01-01T00:00:00');
            if (dataObj < ano1900) {
                erros.push(`Linha ${index + 1}: Data muito antiga (${data})`);
                return;
            }

            // Validar se o número do processo não está vazio
            if (!numeroProcesso || numeroProcesso.trim().length === 0) {
                erros.push(`Linha ${index + 1}: Número do processo não pode estar vazio`);
                return;
            }

            processosParaCadastrar.push({
                numeroProcesso: numeroProcesso,
                dataConclusao: dataConclusao,
                dataFormatada: data
            });
        });

        // Se houver erros, mostrar e não continuar
        if (erros.length > 0) {
            alert(`Erros encontrados:\n\n${erros.join('\n')}\n\nPor favor, corrija e tente novamente.`);
            return;
        }

        if (processosParaCadastrar.length === 0) {
            alert('Nenhum processo válido encontrado.');
            return;
        }

        // Confirmar cadastro
        const confirmar = confirm(
            `Deseja cadastrar ${processosParaCadastrar.length} processo(s)?\n\n` +
            `Classe: ${this.getClasseProcessualLabel(classeProcessual)}\n` +
            `Status: ${this.getStatusLabel(status)}\n` +
            `Prioridade: ${this.getPrioridadeLabel(prioridade)}\n\n` +
            `Assunto: A editar\n` +
            `Cada processo usará sua própria data de conclusão`
        );

        if (!confirmar) return;

        // Cadastrar processos
        let cadastrados = 0;
        let duplicados = 0;

        processosParaCadastrar.forEach(({ numeroProcesso, dataConclusao }) => {
            // Verificar se já existe
            const jaExiste = this.processos.some(p => p.numeroProcesso === numeroProcesso);

            if (jaExiste) {
                duplicados++;
                return;
            }

            const novoProcesso = {
                id: this.gerarIdUnico(),
                numeroProcesso: numeroProcesso,
                assunto: 'A editar',
                classeProcessual: classeProcessual,
                dataConclusao: dataConclusao,
                prioridade: prioridade,
                status: status,
                observacoes: '',
                dataCadastro: new Date().toISOString()
            };

            this.processos.push(novoProcesso);

            // Registrar log de criação para cada processo
            this.adicionarLog(novoProcesso.id, 'criacao', 'O processo foi cadastrado no sistema via Cadastro em Lote.', {
                numeroProcesso: { depois: novoProcesso.numeroProcesso },
                assunto: { depois: this.getAssuntoLabel(novoProcesso.assunto) },
                classeProcessual: { depois: this.getClasseProcessualLabel(novoProcesso.classeProcessual) },
                dataConclusao: { depois: this.formatarData(novoProcesso.dataConclusao) },
                status: { depois: this.getStatusLabel(novoProcesso.status) },
                prioridade: { depois: this.getPrioridadeLabel(novoProcesso.prioridade) }
            });

            cadastrados++;
        });

        this.salvarProcessos();
        this.renderizarProcessos();
        this.atualizarEstatisticas();
        this.fecharModalCadastroLote();

        // Mensagem de sucesso
        let mensagem = `${cadastrados} processo(s) cadastrado(s) com sucesso!`;
        if (duplicados > 0) {
            mensagem += `\n${duplicados} processo(s) duplicado(s) foram ignorados.`;
        }

        this.mostrarNotificacao(mensagem, 'success');
    }

    getStatusLabel(status) {
        const labels = {
            'aguardando-despacho': 'Aguardando despacho',
            'concluso': 'Concluso para julgamento',
            'despachado': 'Despachado',
            'finalizado': 'Finalizado'
        };
        return labels[status] || status;
    }

    getPrioridadeLabel(prioridade) {
        const labels = {
            'normal': 'Normal',
            'urgente': 'Urgente',
            'muito-urgente': 'Muito Urgente',
            'prioridade-advogado': 'Prioridade a pedido do advogado'
        };
        return labels[prioridade] || prioridade;
    }

    atualizarContagemRelatorio() {
        const dataInicial = document.getElementById('relatorio-data-inicial').value;
        const dataFinal = document.getElementById('relatorio-data-final').value;

        if (!dataInicial || !dataFinal) {
            document.getElementById('preview-count').textContent = '';
            return;
        }

        const processosFiltrados = this.filtrarProcessosPorPeriodo(dataInicial, dataFinal);
        const count = processosFiltrados.length;

        if (count === 0) {
            document.getElementById('preview-count').textContent = '⚠️ Nenhum processo encontrado no período selecionado.';
            document.getElementById('preview-count').style.color = '#f59e0b';
        } else if (count === 1) {
            document.getElementById('preview-count').textContent = '✓ 1 processo encontrado no período.';
            document.getElementById('preview-count').style.color = '#16a34a';
        } else {
            document.getElementById('preview-count').textContent = `✓ ${count} processos encontrados no período.`;
            document.getElementById('preview-count').style.color = '#16a34a';
        }
    }

    filtrarProcessosPorPeriodo(dataInicial, dataFinal) {
        const inicio = new Date(dataInicial + 'T00:00:00');
        const fim = new Date(dataFinal + 'T23:59:59');

        return this.processos.filter(p => {
            if (p.status !== 'finalizado') return false;

            // Usar dataFinalizacao se existir, senão usar dataConclusao como fallback
            const dataParaFiltro = p.dataFinalizacao || p.dataConclusao;

            if (!dataParaFiltro) return false;

            const dataFinal = new Date(dataParaFiltro + 'T00:00:00');
            return dataFinal >= inicio && dataFinal <= fim;
        });
    }

    gerarRelatorioPDF() {
        const dataInicial = document.getElementById('relatorio-data-inicial').value;
        const dataFinal = document.getElementById('relatorio-data-final').value;

        if (!dataInicial || !dataFinal) {
            this.mostrarNotificacao('Por favor, preencha as datas inicial e final.', 'error');
            return;
        }

        // Mostrar loading e desabilitar botão
        const loadingIndicator = document.getElementById('relatorio-loading');
        const btnGerarPdf = document.getElementById('btn-gerar-pdf');

        if (loadingIndicator) {
            loadingIndicator.style.display = 'block';
        }

        if (btnGerarPdf) {
            btnGerarPdf.disabled = true;
            btnGerarPdf.style.opacity = '0.6';
            btnGerarPdf.style.cursor = 'not-allowed';
        }

        try {
            const processosFiltrados = this.filtrarProcessosPorPeriodo(dataInicial, dataFinal);

            if (processosFiltrados.length === 0) {
                // Ocultar loading e reabilitar botão
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                if (btnGerarPdf) {
                    btnGerarPdf.disabled = false;
                    btnGerarPdf.style.opacity = '1';
                    btnGerarPdf.style.cursor = 'pointer';
                }
                this.mostrarNotificacao('Nenhum processo encontrado no período selecionado.', 'info');
                return;
            }

            // Ordenar processos por data em ordem crescente (mais antiga para mais recente)
            processosFiltrados.sort((a, b) => {
                const dataA = new Date((a.dataFinalizacao || a.dataConclusao || '1900-01-01') + 'T00:00:00');
                const dataB = new Date((b.dataFinalizacao || b.dataConclusao || '1900-01-01') + 'T00:00:00');
                return dataA - dataB; // Ordem crescente
            });

            // Verificar se jsPDF está disponível
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                throw new Error('Biblioteca jsPDF não carregada');
            }

            // Criar PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

        // Cabeçalho
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('RELATÓRIO DE PROCESSOS FINALIZADOS', 105, 20, { align: 'center' });

        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Sistema de Controle de Processos - Gabinete Judicial', 105, 28, { align: 'center' });

        // Período
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        const periodoTexto = `Período: ${this.formatarData(dataInicial)} a ${this.formatarData(dataFinal)}`;
        doc.text(periodoTexto, 105, 38, { align: 'center' });

        // Estatísticas
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Total de processos finalizados: ${processosFiltrados.length}`, 14, 48);
        doc.text(`Data de geração: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}`, 14, 54);

        // Tabela
        const tableData = processosFiltrados.map(p => [
            p.numeroProcesso,
            this.getAssuntoLabel(p.assunto),
            this.getClasseProcessualLabel(p.classeProcessual),
            this.formatarData(p.dataFinalizacao || p.dataConclusao || ''),
            p.observacoes || '-'
        ]);

        doc.autoTable({
            startY: 62,
            head: [['Número', 'Assunto', 'Classe Processual', 'Data Finalização', 'Observações']],
            body: tableData,
            styles: {
                fontSize: 8,
                cellPadding: 3,
                overflow: 'linebreak'
            },
            headStyles: {
                fillColor: [30, 64, 175],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            columnStyles: {
                0: { cellWidth: 35 },
                1: { cellWidth: 50 },
                2: { cellWidth: 35 },
                3: { cellWidth: 30 },
                4: { cellWidth: 40 }
            },
            margin: { left: 14, right: 14 }
        });

        // Rodapé
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            doc.text(`Página ${i} de ${pageCount}`, 105, 285, { align: 'center' });
        }

            // Salvar PDF
            const nomeArquivo = `relatorio-processos-finalizados-${dataInicial}-a-${dataFinal}.pdf`;
            doc.save(nomeArquivo);

            // Ocultar loading e reabilitar botão
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            if (btnGerarPdf) {
                btnGerarPdf.disabled = false;
                btnGerarPdf.style.opacity = '1';
                btnGerarPdf.style.cursor = 'pointer';
            }

            this.fecharModalRelatorio();
            this.mostrarNotificacao('Relatório PDF gerado com sucesso!', 'success');
        } catch (error) {
            console.error('Erro ao gerar PDF:', error);

            // Ocultar loading e reabilitar botão
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            if (btnGerarPdf) {
                btnGerarPdf.disabled = false;
                btnGerarPdf.style.opacity = '1';
                btnGerarPdf.style.cursor = 'pointer';
            }

            let mensagemErro = 'Erro ao gerar o relatório PDF. ';
            if (error.message.includes('jsPDF não carregada')) {
                mensagemErro += 'A biblioteca de geração de PDF não está disponível. Verifique sua conexão com a internet.';
            } else {
                mensagemErro += 'Por favor, tente novamente.';
            }

            alert(mensagemErro);
            this.mostrarNotificacao('Falha ao gerar PDF', 'error');
        }
    }

    getClasseProcessualLabel(slug) {
        // Debug: verificar se classesProcessuais existe
        if (!this.classesProcessuais) {
            console.error('❌ classesProcessuais não está definido!');
            // Tentar carregar
            this.classesProcessuais = this.carregarClassesProcessuais();
        }

        // Buscar na lista dinâmica de classes
        const classe = this.classesProcessuais.find(c => c.slug === slug);
        if (classe) {
            return classe.nome;
        }

        // Fallback para valores antigos
        const labels = {
            'apelacao-civel': 'Apelação Cível',
            'agravo-instrumento': 'Agravo de Instrumento',
            'pedido-efeito-suspensivo': 'Pedido de Efeito Suspensivo',
            'habeas-corpus': 'Habeas Corpus'
        };

        if (labels[slug]) {
            return labels[slug];
        }

        // Se não encontrou em lugar nenhum, retorna o slug mesmo
        return slug;
    }

    getAssuntoLabel(slug) {
        // Debug: verificar se assuntos existe
        if (!this.assuntos) {
            console.error('❌ assuntos não está definido!');
            // Tentar carregar
            this.assuntos = this.carregarAssuntos();
        }

        // Buscar na lista dinâmica de assuntos
        const assunto = this.assuntos.find(a => a.slug === slug);
        if (assunto) {
            return assunto.nome;
        }

        // Se não encontrar, converter slug para formato legível
        // Exemplo: "busca-e-apreensao" → "Busca e Apreensão"
        return this.slugParaTexto(slug);
    }

    slugParaTexto(slug) {
        if (!slug) return '';

        // Mapeamento de palavras sem acento para palavras com acento
        const mapAcentos = {
            // Verbos e ações
            'apreensao': 'Apreensão',
            'execucao': 'Execução',
            'peticao': 'Petição',
            'revisao': 'Revisão',
            'inscricao': 'Inscrição',
            'exclusao': 'Exclusão',
            'inclusao': 'Inclusão',
            'cassacao': 'Cassação',
            'anulacao': 'Anulação',
            'extincao': 'Extinção',
            'rescisao': 'Rescisão',
            'reintegracao': 'Reintegração',
            'indenizacao': 'Indenização',
            'reparacao': 'Reparação',
            'restituicao': 'Restituição',
            'suspensao': 'Suspensão',
            'producao': 'Produção',
            'adicao': 'Adição',
            'remocao': 'Remoção',
            'exoneracao': 'Exoneração',
            'promocao': 'Promoção',
            'progressao': 'Progressão',
            'locacao': 'Locação',
            'relocacao': 'Relocação',
            'apuracao': 'Apuração',
            'prestacao': 'Prestação',
            'incorporacao': 'Incorporação',
            'desapropriacaoo': 'Desapropriação',

            // Substantivos comuns
            'saude': 'Saúde',
            'transito': 'Trânsito',
            'tributario': 'Tributário',
            'tributaria': 'Tributária',
            'previdenciario': 'Previdenciário',
            'previdenciaria': 'Previdenciária',
            'previdencia': 'Previdência',
            'transporte': 'Transporte',
            'credito': 'Crédito',
            'debito': 'Débito',
            'obrigacao': 'Obrigação',
            'contribuicao': 'Contribuição',
            'acidente': 'Acidente',
            'veiculo': 'Veículo',
            'movel': 'Móvel',
            'imovel': 'Imóvel',
            'imoveis': 'Imóveis',
            'orgao': 'Órgão',
            'orgaos': 'Órgãos',
            'publico': 'Público',
            'publica': 'Pública',
            'publicos': 'Públicos',
            'publicas': 'Públicas',
            'honorarios': 'Honorários',
            'funcao': 'Função',
            'aereo': 'Aéreo',
            'aeronautico': 'Aeronáutico',
            'maritimo': 'Marítimo',
            'eletrico': 'Elétrico',
            'eletrica': 'Elétrica',
            'nucleo': 'Núcleo',
            'periodo': 'Período',
            'transito': 'Trânsito',
            'alcool': 'Álcool',
            'eletronico': 'Eletrônico',
            'eletronica': 'Eletrônica',
            'cientifico': 'Científico',
            'tecnologico': 'Tecnológico',
            'biologico': 'Biológico',
            'quimico': 'Químico',
            'medico': 'Médico',
            'medica': 'Médica',
            'farmaceutico': 'Farmacêutico',
            'cirurgico': 'Cirúrgico',
            'hospitalar': 'Hospitalar',
            'sanitario': 'Sanitário',
            'sanitaria': 'Sanitária',

            // Adjetivos
            'social': 'Social',
            'sociais': 'Sociais',
            'estatutario': 'Estatutário',
            'estatutaria': 'Estatutária',
            'criminal': 'Criminal',
            'penal': 'Penal',
            'civil': 'Civil',
            'civel': 'Cível',
            'comercial': 'Comercial',
            'trabalhista': 'Trabalhista',
            'administrativo': 'Administrativo',
            'administrativa': 'Administrativa',
            'constitucional': 'Constitucional',
            'processual': 'Processual',
            'judicial': 'Judicial',
            'extrajudicial': 'Extrajudicial',
            'ambiental': 'Ambiental',
            'empresarial': 'Empresarial',
            'consumerista': 'Consumerista',
            'imobiliario': 'Imobiliário',
            'imobiliaria': 'Imobiliária',
            'bancario': 'Bancário',
            'bancaria': 'Bancária',
            'financeiro': 'Financeiro',
            'financeira': 'Financeira',
            'economico': 'Econômico',
            'economica': 'Econômica',
            'patrimonial': 'Patrimonial',
            'contratual': 'Contratual',
            'ilicito': 'Ilícito',
            'ilicita': 'Ilícita',
            'ilegal': 'Ilegal',
            'licito': 'Lícito',
            'licita': 'Lícita',
            'legal': 'Legal',
            'legitimo': 'Legítimo',
            'legitima': 'Legítima',
            'provisorio': 'Provisório',
            'provisoria': 'Provisória',
            'temporario': 'Temporário',
            'temporaria': 'Temporária',
            'extraordinario': 'Extraordinário',
            'extraordinaria': 'Extraordinária',
            'ordinario': 'Ordinário',
            'ordinaria': 'Ordinária',

            // Termos jurídicos específicos
            'aposentadoria': 'Aposentadoria',
            'pensao': 'Pensão',
            'auxilio': 'Auxílio',
            'beneficio': 'Benefício',
            'beneficios': 'Benefícios',
            'salario': 'Salário',
            'salarios': 'Salários',
            'subsidio': 'Subsídio',
            'subsidios': 'Subsídios',
            'funcionario': 'Funcionário',
            'funcionarios': 'Funcionários',
            'funcionaria': 'Funcionária',
            'servidor': 'Servidor',
            'servidora': 'Servidora',
            'servidores': 'Servidores',
            'familia': 'Família',
            'maternidade': 'Maternidade',
            'paternidade': 'Paternidade',
            'inventario': 'Inventário',
            'sucessorio': 'Sucessório',
            'sucessoria': 'Sucessória',
            'heranca': 'Herança',
            'matrimonio': 'Matrimônio',
            'matrimonial': 'Matrimonial',
            'conjugal': 'Conjugal',
            'divorcio': 'Divórcio',
            'uniao': 'União',
            'estavel': 'Estável',

            // Termos diversos
            'construcao': 'Construção',
            'construtora': 'Construtora',
            'area': 'Área',
            'areas': 'Áreas',
            'energia': 'Energia',
            'eletrica': 'Elétrica',
            'agua': 'Água',
            'residuos': 'Resíduos',
            'educacao': 'Educação',
            'educacional': 'Educacional',
            'escola': 'Escola',
            'universidade': 'Universidade',
            'universitario': 'Universitário',
            'universitaria': 'Universitária',
            'brasil': 'Brasil',
            'brasileiro': 'Brasileiro',
            'brasileira': 'Brasileira',
            'automovel': 'Automóvel',
            'automoveis': 'Automóveis',
            'telefone': 'Telefone',
            'telefonia': 'Telefonia',
            'telecomunicacao': 'Telecomunicação',
            'telecomunicacoes': 'Telecomunicações',
            'residencia': 'Residência',
            'residencial': 'Residencial',
            'comercio': 'Comércio',
            'industria': 'Indústria',
            'industrial': 'Industrial',
            'agraria': 'Agrária',
            'agrario': 'Agrário',
            'agricultura': 'Agricultura',
            'pecuaria': 'Pecuária',
            'justica': 'Justiça',
            'jurisdicao': 'Jurisdição'
        };

        // Preposições e artigos (manter minúsculos)
        const preposicoes = ['de', 'da', 'do', 'das', 'dos', 'a', 'o', 'e', 'em', 'para', 'por', 'com', 'sem', 'sob'];

        const palavras = slug.split('-');
        const textoFormatado = palavras.map((palavra, index) => {
            const palavraLower = palavra.toLowerCase();

            // Primeira palavra: verificar no mapa de acentos
            if (index === 0) {
                if (mapAcentos[palavraLower]) {
                    return mapAcentos[palavraLower];
                }
                return palavra.charAt(0).toUpperCase() + palavra.slice(1);
            }

            // Preposições e artigos em minúsculo (exceto se for a primeira palavra)
            if (preposicoes.includes(palavraLower)) {
                return palavraLower;
            }

            // Verificar no mapa de acentos
            if (mapAcentos[palavraLower]) {
                return mapAcentos[palavraLower];
            }

            // Outras palavras com primeira letra maiúscula
            return palavra.charAt(0).toUpperCase() + palavra.slice(1);
        }).join(' ');

        return textoFormatado;
    }

    getPrioridadeLabel(prioridade) {
        const labels = {
            'normal': 'Normal',
            'urgente': 'Urgente',
            'muito-urgente': 'Muito Urgente',
            'prioridade-advogado': 'Prioridade a pedido do advogado'
        };

        return labels[prioridade] || prioridade;
    }

    formatarData(data) {
        if (!data) return '';

        // Validar se é uma string
        if (typeof data !== 'string') {
            console.error('formatarData recebeu tipo inválido:', typeof data, data);
            return 'Data inválida';
        }

        // Validar formato YYYY-MM-DD
        const partes = data.split('-');
        if (partes.length !== 3) {
            console.error('formatarData recebeu formato inválido:', data);
            return 'Data inválida';
        }

        const [ano, mes, dia] = partes;

        // Validar se são números válidos
        if (!ano || !mes || !dia || isNaN(ano) || isNaN(mes) || isNaN(dia)) {
            console.error('formatarData recebeu componentes inválidos:', data);
            return 'Data inválida';
        }

        // Validar ranges
        const anoNum = parseInt(ano);
        const mesNum = parseInt(mes);
        const diaNum = parseInt(dia);

        if (anoNum < 1900 || anoNum > 2100 || mesNum < 1 || mesNum > 12 || diaNum < 1 || diaNum > 31) {
            console.error('formatarData recebeu valores fora do range:', data);
            return 'Data inválida';
        }

        return `${dia}/${mes}/${ano}`;
    }

    obterNomeStatus(status) {
        const statusMap = {
            'aguardando-despacho': 'Aguardando despacho',
            'concluso': 'Concluso para julgamento',
            'despachado': 'Despachado',
            'finalizado': 'Finalizado'
        };
        return statusMap[status] || status;
    }

    normalizarTexto(texto) {
        // Remove acentos e converte para lowercase para busca insensível a acentos
        if (!texto) return '';
        return texto
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');
    }

    calcularDiasConclusos(dataConclusao) {
        if (!dataConclusao) return 'N/A';

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const dataConc = new Date(dataConclusao + 'T00:00:00');
        const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));

        if (diffDias < 0) {
            return '0 dias';
        } else if (diffDias === 0) {
            return 'Hoje';
        } else if (diffDias === 1) {
            return '1 dia';
        } else {
            return `${diffDias} dias`;
        }
    }

    renderizarDiasConclusosBadge(dataConclusao) {
        if (!dataConclusao) return '<span class="dias-badge dias-normal">N/A</span>';

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const dataConc = new Date(dataConclusao + 'T00:00:00');
        const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));

        let texto = '';
        let icone = '';
        let classe = 'dias-normal';

        if (diffDias < 0) {
            texto = '0 dias';
            icone = '✓';
            classe = 'dias-normal';
        } else if (diffDias === 0) {
            texto = 'Hoje';
            icone = '✓';
            classe = 'dias-normal';
        } else if (diffDias === 1) {
            texto = '1 dia';
            icone = '✓';
            classe = 'dias-normal';
        } else if (diffDias >= ProcessoManager.DIAS_CRITICO) {
            texto = `${diffDias} dias`;
            icone = '✖';
            classe = 'dias-critico';
        } else if (diffDias >= ProcessoManager.DIAS_ATENCAO) {
            texto = `${diffDias} dias`;
            icone = '⚠';
            classe = 'dias-atencao';
        } else {
            texto = `${diffDias} dias`;
            icone = '✓';
            classe = 'dias-normal';
        }

        return `<span class="dias-badge ${classe}">${icone} ${texto}</span>`;
    }

    escaparHTML(texto) {
        const div = document.createElement('div');
        div.textContent = texto;
        return div.innerHTML;
    }

    limparTooltipsOrfaos() {
        // Remover todos os tooltips que estão no body mas cujos wrappers não existem mais no DOM
        const tooltipsNoBody = document.body.querySelectorAll('.tooltip-observacoes');

        tooltipsNoBody.forEach(tooltip => {
            // Verificar se o tooltip tem um wrapper pai válido no DOM
            let temWrapperValido = false;

            // Procurar todos os wrappers de observações no DOM
            const wrappers = document.querySelectorAll('.obs-wrapper');
            wrappers.forEach(wrapper => {
                if (wrapper._tooltip === tooltip) {
                    temWrapperValido = true;
                }
            });

            // Se não tem wrapper válido, remover o tooltip
            if (!temWrapperValido) {
                tooltip.remove();
            }
        });
    }

    posicionarTooltip(event, wrapper) {
        // Buscar tooltip dentro do wrapper ou usar a referência guardada
        let tooltip = wrapper._tooltip || wrapper.querySelector('.tooltip-observacoes');
        if (!tooltip) return;

        // Guardar referência do tooltip no wrapper
        if (!wrapper._tooltip) {
            wrapper._tooltip = tooltip;
        }

        // Mover tooltip para o body se ainda não foi movido
        if (tooltip.parentElement !== document.body) {
            document.body.appendChild(tooltip);
        }

        const rect = wrapper.getBoundingClientRect();

        // Posicionar à direita do elemento
        tooltip.style.left = `${rect.right + 12}px`;
        tooltip.style.top = `${rect.top + (rect.height / 2)}px`;
        tooltip.style.transform = 'translateY(-50%)';
        tooltip.style.visibility = 'visible';
        tooltip.style.opacity = '1';

        // Remover listener antigo se existir
        if (wrapper._tooltipUpdateHandler) {
            window.removeEventListener('scroll', wrapper._tooltipUpdateHandler, true);
        }

        // Atualizar posição durante o scroll
        wrapper._tooltipUpdateHandler = () => {
            const newRect = wrapper.getBoundingClientRect();
            tooltip.style.left = `${newRect.right + 12}px`;
            tooltip.style.top = `${newRect.top + (newRect.height / 2)}px`;
        };
        window.addEventListener('scroll', wrapper._tooltipUpdateHandler, true);
    }

    esconderTooltip(wrapper) {
        // Usar a referência guardada do tooltip
        const tooltip = wrapper._tooltip;
        if (tooltip) {
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';

            // Remover listener de scroll
            if (wrapper._tooltipUpdateHandler) {
                window.removeEventListener('scroll', wrapper._tooltipUpdateHandler, true);
                wrapper._tooltipUpdateHandler = null;
            }
        }
    }

    copiarPorId(id, event) {
        event.stopPropagation();

        // Buscar processo pelo ID
        const processo = this.encontrarProcessoPorId(id);
        if (!processo) {
            alert('Processo não encontrado.');
            return;
        }

        // Copiar para área de transferência
        navigator.clipboard.writeText(processo.numeroProcesso).then(() => {
            // Feedback visual
            const button = event.target;
            const textoOriginal = button.textContent;

            button.textContent = '✓';
            button.style.backgroundColor = '#16a34a';

            setTimeout(() => {
                button.textContent = textoOriginal;
                button.style.backgroundColor = '';
            }, 1500);

            this.mostrarNotificacao('Número do processo copiado!', 'success');
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            this.mostrarNotificacao('Erro ao copiar número do processo.', 'error');
        });
    }

    copiarNumeroProcesso(numeroProcesso, event) {
        event.stopPropagation();

        // Copiar para área de transferência
        navigator.clipboard.writeText(numeroProcesso).then(() => {
            this.mostrarNotificacao('Número do processo copiado!', 'success');
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            this.mostrarNotificacao('Erro ao copiar número do processo.', 'error');
        });
    }

    salvarProcessos() {
        try {
            // Verificar se localStorage está disponível
            if (typeof localStorage === 'undefined') {
                throw new Error('localStorage não está disponível');
            }

            // Usar replacer para evitar erros de referências circulares
            const seen = new WeakSet();
            const jsonString = JSON.stringify(this.processos, (key, value) => {
                // Detectar referências circulares
                if (typeof value === 'object' && value !== null) {
                    if (seen.has(value)) {
                        return; // Omitir referência circular
                    }
                    seen.add(value);
                }
                return value;
            });

            localStorage.setItem('processos-gabinete', jsonString);
        } catch (error) {
            console.error('Erro ao salvar processos:', error);

            // Verificar se é erro de quota excedida
            if (error.name === 'QuotaExceededError' || error.code === 22) {
                this.mostrarNotificacao('Espaço de armazenamento esgotado! Por favor, exporte seus dados e limpe processos antigos.', 'error');
            } else if (error.message.includes('não está disponível')) {
                this.mostrarNotificacao('Armazenamento local não disponível. Seus dados não serão salvos.', 'error');
            } else if (error.message.includes('circular')) {
                this.mostrarNotificacao('Erro: dados com referências circulares detectadas. Por favor, reporte este problema.', 'error');
            } else {
                this.mostrarNotificacao('Erro ao salvar dados. Por favor, exporte um backup.', 'error');
            }
        }
    }

    carregarProcessos() {
        try {
            // Verificar se localStorage está disponível
            if (typeof localStorage === 'undefined') {
                console.warn('localStorage não está disponível');
                return [];
            }

            const dados = localStorage.getItem('processos-gabinete');

            if (!dados) {
                return [];
            }

            const processos = JSON.parse(dados);

            // Validar que é um array
            if (!Array.isArray(processos)) {
                console.error('Dados corrompidos: processos não é um array');
                this.mostrarNotificacao('Dados corrompidos detectados. Iniciando com lista vazia.', 'error');
                return [];
            }

            // CORREÇÃO: Garantir que todos os IDs sejam números
            // Isso previne problemas de comparação quando IDs são salvos como strings
            processos.forEach(processo => {
                if (processo.id && typeof processo.id === 'string') {
                    const idNumerico = parseFloat(processo.id);
                    if (!isNaN(idNumerico)) {
                        processo.id = idNumerico;
                    }
                } else if (!processo.id || typeof processo.id !== 'number') {
                    // ID inválido ou ausente, gerar um novo
                    console.warn(`Processo com ID inválido detectado: ${processo.numeroProcesso}. Gerando novo ID.`);
                    processo.id = parseFloat(`${Date.now()}.${Math.floor(Math.random() * 1000000)}`);
                }
            });

            return processos;
        } catch (error) {
            console.error('Erro ao carregar processos:', error);
            this.mostrarNotificacao('Erro ao carregar dados. Iniciando com lista vazia.', 'error');
            return [];
        }
    }

    // ==================== SISTEMA DE HISTÓRICO ====================

    carregarHistorico() {
        try {
            const dados = localStorage.getItem('historico-processos');
            if (!dados) {
                return {}; // Objeto vazio: { processoId: [logs...], ... }
            }
            return JSON.parse(dados);
        } catch (error) {
            console.error('Erro ao carregar histórico:', error);
            return {};
        }
    }

    salvarHistorico() {
        try {
            localStorage.setItem('historico-processos', JSON.stringify(this.historico));
        } catch (error) {
            console.error('Erro ao salvar histórico:', error);
        }
    }

    // Adicionar log ao histórico de um processo
    adicionarLog(processoId, tipo, descricao, alteracoes = {}) {
        if (!this.historico[processoId]) {
            this.historico[processoId] = [];
        }

        const log = {
            id: Date.now() + Math.random(), // ID único do log
            tipo: tipo, // 'criacao', 'edicao', 'status-change', 'despacho', 'finalizacao', 'retorno'
            descricao: descricao,
            alteracoes: alteracoes, // Objeto com as mudanças: { campo: { antes: x, depois: y } }
            dataHora: new Date().toISOString(),
            timestamp: Date.now()
        };

        this.historico[processoId].push(log);
        this.salvarHistorico();
    }

    // Obter histórico de um processo
    obterHistorico(processoId) {
        return this.historico[processoId] || [];
    }

    // Limpar histórico de um processo (quando excluído)
    limparHistoricoProcesso(processoId) {
        delete this.historico[processoId];
        this.salvarHistorico();
    }

    // ==================== FIM SISTEMA DE HISTÓRICO ====================

    // Gerenciamento de Classes Processuais
    carregarClassesProcessuais() {
        try {
            const dados = localStorage.getItem('classes-processuais');
            if (!dados) {
                // Classes padrão
                return [
                    { id: 1, nome: 'Apelação Cível', slug: 'apelacao-civel' },
                    { id: 2, nome: 'Agravo de Instrumento', slug: 'agravo-instrumento' },
                    { id: 3, nome: 'Pedido de Efeito Suspensivo', slug: 'pedido-efeito-suspensivo' }
                ];
            }
            return JSON.parse(dados);
        } catch (error) {
            console.error('Erro ao carregar classes processuais:', error);
            return [];
        }
    }

    salvarClassesProcessuais() {
        try {
            localStorage.setItem('classes-processuais', JSON.stringify(this.classesProcessuais));
        } catch (error) {
            console.error('Erro ao salvar classes processuais:', error);
            this.mostrarNotificacao('Erro ao salvar classes processuais.', 'error');
        }
    }

    // Gerenciamento de Assuntos
    carregarAssuntos() {
        try {
            const dados = localStorage.getItem('assuntos');
            if (!dados) {
                // Assuntos padrão para facilitar o uso inicial
                return [
                    { id: 1, nome: 'Busca e Apreensão', slug: 'busca-e-apreensao' },
                    { id: 2, nome: 'Plano de Saúde', slug: 'plano-de-saude' },
                    { id: 3, nome: 'Tributário', slug: 'tributario' },
                    { id: 4, nome: 'Previdenciário', slug: 'previdenciario' },
                    { id: 5, nome: 'Responsabilidade Civil', slug: 'responsabilidade-civil' },
                    { id: 6, nome: 'Indenização', slug: 'indenizacao' },
                    { id: 7, nome: 'Execução', slug: 'execucao' },
                    { id: 8, nome: 'Construtora', slug: 'construtora' },
                    { id: 9, nome: 'Contratos', slug: 'contratos' },
                    { id: 10, nome: 'Família', slug: 'familia' },
                    { id: 11, nome: 'Trabalhista', slug: 'trabalhista' },
                    { id: 12, nome: 'Consumidor', slug: 'consumidor' },
                    { id: 13, nome: 'Bancário', slug: 'bancario' },
                    { id: 14, nome: 'Imobiliário', slug: 'imobiliario' },
                    { id: 15, nome: 'A editar', slug: 'a-editar' }
                ];
            }
            return JSON.parse(dados);
        } catch (error) {
            console.error('Erro ao carregar assuntos:', error);
            return [];
        }
    }

    salvarAssuntos() {
        try {
            localStorage.setItem('assuntos', JSON.stringify(this.assuntos));
        } catch (error) {
            console.error('Erro ao salvar assuntos:', error);
            this.mostrarNotificacao('Erro ao salvar assuntos.', 'error');
        }
    }

    mostrarNotificacao(mensagem, tipo = 'success') {
        // Criar elemento de notificação
        const notificacao = document.createElement('div');
        notificacao.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: ${tipo === 'success' ? '#16a34a' : '#dc2626'};
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        `;
        notificacao.textContent = mensagem;
        notificacao.setAttribute('role', 'alert');

        document.body.appendChild(notificacao);

        setTimeout(() => {
            notificacao.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(notificacao);
            }, 300);
        }, 3000);
    }


    exportarDados() {
        // Mostrar loading
        const loadingOverlay = document.getElementById('import-export-loading');
        const loadingText = document.getElementById('import-export-loading-text');

        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
        if (loadingText) {
            loadingText.textContent = 'Exportando dados...';
        }

        // Usar setTimeout para permitir que o loading apareça antes da operação
        setTimeout(() => {
            try {
                // Criar objeto com todos os dados
                const dados = {
                    processos: this.processos,
                    dataExportacao: new Date().toISOString(),
                    versao: '1.0'
                };

                // Converter para JSON
                const jsonString = JSON.stringify(dados, null, 2);

                // Criar blob
                const blob = new Blob([jsonString], { type: 'application/json' });

                // Criar link de download
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;

                // Nome do arquivo com data
                const dataHoje = new Date().toISOString().split('T')[0];
                link.download = `processos-backup-${dataHoje}.json`;

                // Simular clique
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Limpar URL
                URL.revokeObjectURL(url);

                this.mostrarNotificacao('Dados exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                this.mostrarNotificacao('Erro ao exportar dados. Tente novamente.', 'error');
            } finally {
                // Ocultar loading após um breve delay
                setTimeout(() => {
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                }, 500);
            }
        }, 100);
    }

    importarDados(event) {
        const arquivo = event.target.files[0];
        if (!arquivo) return;

        // Validar tamanho do arquivo (máximo 10MB)
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        if (arquivo.size > MAX_FILE_SIZE) {
            this.mostrarNotificacao('Arquivo muito grande. O tamanho máximo permitido é 10MB.', 'error');
            event.target.value = '';
            return;
        }

        // Validar tipo de arquivo
        if (!arquivo.name.endsWith('.json')) {
            this.mostrarNotificacao('Apenas arquivos .json são permitidos.', 'error');
            event.target.value = '';
            return;
        }

        // Mostrar loading
        const loadingOverlay = document.getElementById('import-export-loading');
        const loadingText = document.getElementById('import-export-loading-text');

        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
        if (loadingText) {
            loadingText.textContent = 'Importando dados...';
        }

        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const dados = JSON.parse(e.target.result);

                // Validar estrutura básica
                if (!dados.processos || !Array.isArray(dados.processos)) {
                    throw new Error('Estrutura do arquivo inválida: campo "processos" não encontrado ou não é um array');
                }

                // Validar campos obrigatórios em cada processo
                const camposObrigatorios = ['id', 'numeroProcesso', 'assunto', 'classeProcessual', 'status'];
                const processosInvalidos = [];

                dados.processos.forEach((p, index) => {
                    const camposFaltando = camposObrigatorios.filter(campo => !p[campo]);
                    if (camposFaltando.length > 0) {
                        processosInvalidos.push(`Processo ${index + 1}: faltam campos ${camposFaltando.join(', ')}`);
                    }
                });

                if (processosInvalidos.length > 0) {
                    const msg = `Arquivo contém processos inválidos:\n\n${processosInvalidos.slice(0, 5).join('\n')}${processosInvalidos.length > 5 ? `\n... e mais ${processosInvalidos.length - 5}` : ''}`;
                    alert(msg);
                    event.target.value = '';
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    return;
                }

                // Validar versão (aviso se versões diferentes)
                if (dados.versao && dados.versao !== '1.0') {
                    const continuarComVersaoDiferente = confirm(
                        `ATENÇÃO: O arquivo foi exportado com uma versão diferente (${dados.versao}).\n\n` +
                        `A versão atual é 1.0.\n\n` +
                        `Deseja continuar mesmo assim? Pode haver incompatibilidades.`
                    );

                    if (!continuarComVersaoDiferente) {
                        event.target.value = '';
                        if (loadingOverlay) loadingOverlay.style.display = 'none';
                        return;
                    }
                }

                // Confirmar importação
                const dataExportacao = dados.dataExportacao
                    ? new Date(dados.dataExportacao).toLocaleString('pt-BR')
                    : 'Data desconhecida';

                const confirmar = confirm(
                    `Deseja importar ${dados.processos.length} processo(s)?\n\n` +
                    `⚠️ ATENÇÃO: Esta ação substituirá TODOS os ${this.processos.length} dados atuais.\n\n` +
                    `Data da exportação: ${dataExportacao}\n\n` +
                    `Recomendação: Exporte seus dados atuais antes de continuar.`
                );

                if (!confirmar) {
                    event.target.value = ''; // Limpar input
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    return;
                }

                // Importar dados
                this.processos = dados.processos;
                this.salvarProcessos();
                this.renderizarProcessos();
                this.atualizarEstatisticas();

                this.mostrarNotificacao('Dados importados com sucesso!', 'success');

                // Limpar input
                event.target.value = '';

                // Ocultar loading
                if (loadingOverlay) loadingOverlay.style.display = 'none';

            } catch (error) {
                console.error('Erro ao importar dados:', error);
                alert('Erro ao importar dados. Verifique se o arquivo é válido.');
                event.target.value = '';
                // Ocultar loading
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            }
        };

        reader.onerror = () => {
            alert('Erro ao ler arquivo.');
            event.target.value = '';
            // Ocultar loading
            const loadingOverlay = document.getElementById('import-export-loading');
            if (loadingOverlay) loadingOverlay.style.display = 'none';
        };

        reader.readAsText(arquivo);
    }

    limparDados() {
        // Primeira confirmação
        const primeiraConfirmacao = confirm(
            'ATENÇÃO: Esta ação irá apagar TODOS os processos cadastrados!\n\n' +
            'Você tem certeza que deseja continuar?'
        );

        if (!primeiraConfirmacao) {
            return;
        }

        // Segunda confirmação (dupla segurança)
        const segundaConfirmacao = confirm(
            `Última confirmação!\n\n` +
            `Você tem ${this.processos.length} processo(s) cadastrado(s).\n\n` +
            `Esta ação é IRREVERSÍVEL e não poderá ser desfeita.\n\n` +
            `Deseja realmente apagar TODOS os dados?\n\n` +
            `💡 Dica: Use "Salvar Dados" antes de limpar para fazer backup.`
        );

        if (!segundaConfirmacao) {
            return;
        }

        // Limpar todos os processos
        this.processos = [];
        this.salvarProcessos();
        this.renderizarProcessos();
        this.atualizarEstatisticas();

        this.mostrarNotificacao('Todos os dados foram limpos com sucesso!', 'success');
    }

    // Funções de Despacho
    abrirModalDespachar(id) {
        const modal = document.getElementById('modal-despachar');

        // Guardar o ID do processo
        document.getElementById('despachar-processo-id').value = id;

        // Definir data padrão como hoje
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('despachar-data').value = hoje;

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalDespachar() {
        const modal = document.getElementById('modal-despachar');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    confirmarDespacho() {
        const id = parseFloat(document.getElementById('despachar-processo-id').value);
        const dataDespacho = document.getElementById('despachar-data').value;

        const processo = this.encontrarProcessoPorId(id);
        if (!processo) {
            alert('Processo não encontrado.');
            return;
        }

        // Validar se a data de despacho não é anterior à data de conclusão
        if (processo.dataConclusao && dataDespacho < processo.dataConclusao) {
            alert(`A data do despacho não pode ser anterior à data de conclusão (${this.formatarData(processo.dataConclusao)}).`);
            return;
        }

        // Validar se a data não é futura
        const hoje = new Date().toISOString().split('T')[0];
        if (dataDespacho > hoje) {
            alert('A data do despacho não pode ser no futuro.');
            return;
        }

        // Calcular dias conclusos até o despacho
        const diasConclusos = this.calcularDiasConclusos(processo.dataConclusao, dataDespacho);

        // Atualizar status e data
        const statusAnterior = processo.status;
        processo.status = 'despachado';
        processo.dataDespacho = dataDespacho;
        processo.dataModificacao = new Date().toISOString();

        // Registrar log de despacho
        this.adicionarLog(id, 'despacho', 'O processo foi despachado pelo magistrado.', {
            dataDespacho: { depois: this.formatarData(dataDespacho) },
            diasConclusos: { depois: `${diasConclusos} dias` },
            status: { antes: this.getStatusLabel(statusAnterior), depois: this.getStatusLabel('despachado') }
        });

        this.salvarProcessos();
        this.renderizarProcessos();
        this.atualizarEstatisticas();
        this.fecharModalDespachar();
        this.atualizarHeatmapSeAberto(); // Atualizar calendário se estiver aberto

        this.mostrarNotificacao('Processo despachado com sucesso!', 'success');
    }

    // Funções de Finalização
    abrirModalFinalizar(id) {
        const modal = document.getElementById('modal-finalizar');

        // Guardar o ID do processo
        document.getElementById('finalizar-processo-id').value = id;

        // Definir data padrão como hoje
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('finalizar-data').value = hoje;

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalFinalizar() {
        const modal = document.getElementById('modal-finalizar');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    confirmarFinalizacao() {
        const id = parseFloat(document.getElementById('finalizar-processo-id').value);
        const dataFinalizacao = document.getElementById('finalizar-data').value;

        const processo = this.encontrarProcessoPorId(id);
        if (!processo) {
            alert('Processo não encontrado.');
            return;
        }

        // Validar se a data de finalização não é anterior à data de conclusão
        if (processo.dataConclusao && dataFinalizacao < processo.dataConclusao) {
            alert(`A data de finalização não pode ser anterior à data de conclusão (${this.formatarData(processo.dataConclusao)}).`);
            return;
        }

        // Validar se a data não é futura
        const hoje = new Date().toISOString().split('T')[0];
        if (dataFinalizacao > hoje) {
            alert('A data de finalização não pode ser no futuro.');
            return;
        }

        // Atualizar status e data
        const statusAnterior = processo.status;
        processo.status = 'finalizado';
        processo.dataFinalizacao = dataFinalizacao;
        processo.dataModificacao = new Date().toISOString();

        // Registrar log de finalização
        this.adicionarLog(id, 'finalizacao', 'O processo foi finalizado e arquivado.', {
            dataFinalizacao: { depois: this.formatarData(dataFinalizacao) },
            status: { antes: this.getStatusLabel(statusAnterior), depois: this.getStatusLabel('finalizado') }
        });

        this.salvarProcessos();
        this.renderizarProcessos();
        this.atualizarEstatisticas();
        this.fecharModalFinalizar();
        this.atualizarHeatmapSeAberto(); // Atualizar calendário se estiver aberto

        this.mostrarNotificacao('Processo finalizado com sucesso!', 'success');
    }

    // Funções de Retorno
    abrirModalRetornar(id) {
        const modal = document.getElementById('modal-retornar');

        // Guardar o ID do processo
        document.getElementById('retornar-processo-id').value = id;

        // Definir data padrão como hoje
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('retornar-data').value = hoje;

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalRetornar() {
        const modal = document.getElementById('modal-retornar');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    confirmarRetorno() {
        const id = parseFloat(document.getElementById('retornar-processo-id').value);
        const dataConclusao = document.getElementById('retornar-data').value;

        const processo = this.encontrarProcessoPorId(id);
        if (!processo) {
            alert('Processo não encontrado.');
            return;
        }

        // Validar se a data não é futura
        const hoje = new Date().toISOString().split('T')[0];
        if (dataConclusao > hoje) {
            alert('A data de conclusão não pode ser no futuro.');
            return;
        }

        // Validar se existe data de despacho anterior
        if (processo.dataDespacho && dataConclusao < processo.dataDespacho) {
            alert(`A nova data de conclusão não pode ser anterior à data do despacho (${this.formatarData(processo.dataDespacho)}).`);
            return;
        }

        // Atualizar status e data
        const statusAnterior = processo.status;
        processo.status = 'concluso';
        processo.dataConclusao = dataConclusao;
        processo.dataModificacao = new Date().toISOString();

        // Registrar log de retorno
        this.adicionarLog(id, 'retorno', 'O processo retornou de "Despachado" para conclusão.', {
            dataConclusao: { depois: this.formatarData(dataConclusao) },
            status: { antes: this.getStatusLabel(statusAnterior), depois: this.getStatusLabel('concluso') }
        });

        this.salvarProcessos();
        this.renderizarProcessos();
        this.atualizarEstatisticas();
        this.fecharModalRetornar();
        this.atualizarHeatmapSeAberto(); // Atualizar calendário se estiver aberto

        this.mostrarNotificacao('Processo retornado para Em Andamento!', 'success');
    }

    // Funções de Reabertura de Processo Finalizado
    abrirModalReabrirFinalizado(id) {
        const modal = document.getElementById('modal-reabrir-finalizado');

        // Guardar o ID do processo
        document.getElementById('reabrir-finalizado-processo-id').value = id;

        // Definir data padrão como hoje
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('reabrir-finalizado-data').value = hoje;

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalReabrirFinalizado() {
        const modal = document.getElementById('modal-reabrir-finalizado');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    confirmarReaberturaFinalizado() {
        const id = parseFloat(document.getElementById('reabrir-finalizado-processo-id').value);
        const dataConclusao = document.getElementById('reabrir-finalizado-data').value;

        const processo = this.encontrarProcessoPorId(id);
        if (!processo) {
            alert('Processo não encontrado.');
            return;
        }

        // Validar se a data não é futura
        const hoje = new Date().toISOString().split('T')[0];
        if (dataConclusao > hoje) {
            alert('A data de conclusão não pode ser no futuro.');
            return;
        }

        // Validar se a data não é anterior à data de finalização original
        if (processo.dataFinalizacao && dataConclusao < processo.dataFinalizacao) {
            const confirmar = confirm(
                `Atenção: A nova data de conclusão (${this.formatarData(dataConclusao)}) ` +
                `é anterior à data de finalização (${this.formatarData(processo.dataFinalizacao)}).\n\n` +
                `Deseja continuar mesmo assim?`
            );
            if (!confirmar) {
                return;
            }
        }

        // Atualizar status e data
        const statusAnterior = processo.status;
        const dataFinalizacaoAnterior = processo.dataFinalizacao;

        processo.status = 'concluso';
        processo.dataConclusao = dataConclusao;
        processo.dataFinalizacao = null; // Limpar data de finalização
        processo.dataModificacao = new Date().toISOString();

        // Registrar log de reabertura
        this.adicionarLog(id, 'reabertura', 'O processo foi reaberto e retornou para "Em Andamento".', {
            dataConclusao: { depois: this.formatarData(dataConclusao) },
            dataFinalizacao: { antes: this.formatarData(dataFinalizacaoAnterior), depois: '-' },
            status: { antes: this.getStatusLabel(statusAnterior), depois: this.getStatusLabel('concluso') }
        });

        this.salvarProcessos();
        this.renderizarProcessos();
        this.atualizarEstatisticas();
        this.fecharModalReabrirFinalizado();
        this.atualizarHeatmapSeAberto(); // Atualizar calendário se estiver aberto

        this.mostrarNotificacao('Processo reaberto e retornado para Em Andamento!', 'success');
    }

    // Funções de Produção Mensal

    // Função para alternar sidebar em mobile
    toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('show');
    }

    // ============================================
    // SIDEBAR RECOLHÍVEL - NAVEGAÇÃO
    // ============================================

    carregarPreferenciasSidebar() {
        const saved = localStorage.getItem('sidebar-preferencias');
        if (saved) {
            return JSON.parse(saved);
        }
        return {
            isCollapsed: false,
            activeSection: 'andamento'
        };
    }

    salvarPreferenciasSidebar() {
        localStorage.setItem('sidebar-preferencias', JSON.stringify(this.sidebarState));
    }

    toggleSidebarCollapse() {
        const sidebar = document.getElementById('sidebar');
        const container = document.querySelector('.container');

        this.sidebarState.isCollapsed = !this.sidebarState.isCollapsed;

        if (this.sidebarState.isCollapsed) {
            sidebar.classList.add('collapsed');
            container.classList.add('sidebar-collapsed');
        } else {
            sidebar.classList.remove('collapsed');
            container.classList.remove('sidebar-collapsed');
        }

        this.salvarPreferenciasSidebar();
    }

    navegarParaSecao(secaoId) {
        // Atualizar item ativo no sidebar
        document.querySelectorAll('.sidebar-nav-item').forEach(item => {
            item.classList.remove('active');
        });

        const itemAtivo = document.querySelector(`.sidebar-nav-item[data-section="${secaoId}"]`);
        if (itemAtivo) {
            itemAtivo.classList.add('active');
        }

        // Fechar sidebar mobile se estiver aberto
        if (window.innerWidth <= 768) {
            this.toggleSidebar();
        }

        // Expandir tabela se colapsada e fazer scroll
        const content = document.getElementById(`table-content-${secaoId}`);
        if (content && content.classList.contains('collapsed')) {
            this.toggleTabela(secaoId);
        }

        const section = document.querySelector(`.table-section-${secaoId}`);
        if (section) {
            // Pequeno delay para garantir que a tabela expandiu antes do scroll
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        this.sidebarState.activeSection = secaoId;
        this.salvarPreferenciasSidebar();
    }

    inicializarSidebar() {
        // Carregar estado do sidebar
        this.sidebarState = this.carregarPreferenciasSidebar();

        // Restaurar estado do sidebar (colapsado/expandido)
        if (this.sidebarState.isCollapsed) {
            const sidebar = document.getElementById('sidebar');
            const container = document.querySelector('.container');
            if (sidebar && container) {
                sidebar.classList.add('collapsed');
                container.classList.add('sidebar-collapsed');
            }
        }

        // Restaurar seção ativa
        if (this.sidebarState.activeSection) {
            document.querySelectorAll('.sidebar-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const itemAtivo = document.querySelector(`.sidebar-nav-item[data-section="${this.sidebarState.activeSection}"]`);
            if (itemAtivo) {
                itemAtivo.classList.add('active');
            }
        }

        // Atualizar badges do sidebar
        this.atualizarBadgesSidebar();
    }

    atualizarBadgesSidebar() {
        // Atualizar contagem de processos em andamento
        const emAndamento = this.processos.filter(p =>
            p.status !== 'finalizado' && p.status !== 'despachado'
        ).length;

        const badgeAndamento = document.getElementById('sidebar-badge-andamento');
        if (badgeAndamento) {
            badgeAndamento.textContent = emAndamento;
        }

        // Calcular alertas
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        const processosAndamento = this.processos.filter(p =>
            p.status !== 'finalizado' && p.status !== 'despachado'
        );

        // Críticos (>= DIAS_CRITICO)
        const criticos = processosAndamento.filter(p => {
            if (!p.dataConclusao) return false;
            const dataConc = new Date(p.dataConclusao + 'T00:00:00');
            const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));
            return diffDias >= ProcessoManager.DIAS_CRITICO;
        }).length;

        // Atenção (DIAS_ATENCAO até DIAS_CRITICO-1)
        const atencao = processosAndamento.filter(p => {
            if (!p.dataConclusao) return false;
            const dataConc = new Date(p.dataConclusao + 'T00:00:00');
            const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));
            return diffDias >= ProcessoManager.DIAS_ATENCAO && diffDias < ProcessoManager.DIAS_CRITICO;
        }).length;

        // Processos críticos total (atuais + futuros no mês)
        const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        ultimoDiaMes.setHours(23, 59, 59, 999);
        const processosCriticosTotalSidebar = processosAndamento.filter(p => {
            if (!p.dataConclusao) return false;
            const dataConc = new Date(p.dataConclusao + 'T00:00:00');
            const diasNoFimDoMes = Math.floor((ultimoDiaMes - dataConc) / (1000 * 60 * 60 * 24));
            return diasNoFimDoMes >= ProcessoManager.DIAS_CRITICO;
        }).length;

        // Atualizar badges no sidebar
        const sidebarCriticos = document.getElementById('sidebar-criticos');
        const sidebarAtencao = document.getElementById('sidebar-atencao');
        const sidebar70dias = document.getElementById('sidebar-70dias');

        if (sidebarCriticos) sidebarCriticos.textContent = criticos;
        if (sidebarAtencao) sidebarAtencao.textContent = atencao;
        if (sidebar70dias) sidebar70dias.textContent = processosCriticosTotalSidebar;
    }

    // Modal de Novo Processo
    abrirModalNovoProcesso() {
        const modal = document.getElementById('modal-novo-processo');

        // Fechar sidebar em mobile
        if (window.innerWidth <= 768) {
            this.toggleSidebar();
        }

        // Limpar formulário
        document.getElementById('processo-form').reset();

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        // Configurar eventos de fechar
        const closeButtons = modal.querySelectorAll('.close-modal-novo-processo');
        closeButtons.forEach(btn => {
            btn.onclick = () => this.fecharModalNovoProcesso();
        });

        // Fechar ao clicar fora
        modal.onclick = (e) => {
            if (e.target === modal) {
                this.fecharModalNovoProcesso();
            }
        };

        // Focar no primeiro campo
        setTimeout(() => {
            const primeiroInput = document.getElementById('numero-processo');
            if (primeiroInput) {
                primeiroInput.focus();
            }
        }, 100);
    }

    fecharModalNovoProcesso() {
        const modal = document.getElementById('modal-novo-processo');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    abrirModalProducao() {
        const modal = document.getElementById('modal-producao');

        // Inicializar seletor de ano
        const selectAno = document.getElementById('producao-ano');
        const anoAtual = new Date().getFullYear();
        selectAno.innerHTML = '';
        for (let ano = anoAtual; ano >= anoAtual - 5; ano--) {
            const option = document.createElement('option');
            option.value = ano;
            option.textContent = ano;
            selectAno.appendChild(option);
        }

        // Definir mês e ano atuais
        const mesAtual = new Date().getMonth() + 1;
        document.getElementById('producao-mes').value = mesAtual;
        document.getElementById('producao-ano').value = anoAtual;

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        // Atualizar relatório com dados do mês atual
        this.atualizarRelatorioProducao();
    }

    fecharModalProducao() {
        const modal = document.getElementById('modal-producao');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    // ============================================
    // CONFIGURAÇÕES DO SISTEMA
    // ============================================

    carregarConfiguracoes() {
        try {
            const config = localStorage.getItem('configuracoes-sistema');
            if (config) {
                const dados = JSON.parse(config);
                ProcessoManager.DIAS_ATENCAO = dados.diasAtencao || 70;
                ProcessoManager.DIAS_CRITICO = dados.diasCritico || 89;
            }
        } catch (error) {
            console.error('Erro ao carregar configurações:', error);
        }
    }

    salvarConfiguracoes() {
        const diasAtencao = parseInt(document.getElementById('config-dias-atencao').value);
        const diasCritico = parseInt(document.getElementById('config-dias-critico').value);

        // Validações
        if (isNaN(diasAtencao) || diasAtencao < 1) {
            alert('O valor de dias para "Atenção" deve ser um número maior que 0.');
            return;
        }

        if (isNaN(diasCritico) || diasCritico < 1) {
            alert('O valor de dias para "Crítico" deve ser um número maior que 0.');
            return;
        }

        if (diasCritico <= diasAtencao) {
            alert('O valor de dias para "Crítico" deve ser maior que o valor de "Atenção".');
            return;
        }

        // Atualizar constantes
        ProcessoManager.DIAS_ATENCAO = diasAtencao;
        ProcessoManager.DIAS_CRITICO = diasCritico;

        // Salvar no localStorage
        const config = {
            diasAtencao: diasAtencao,
            diasCritico: diasCritico
        };
        localStorage.setItem('configuracoes-sistema', JSON.stringify(config));

        // Atualizar labels na interface
        this.atualizarLabelsConfiguracoes();

        // Atualizar tudo (renderizarProcessos já chama atualizarPrioridadesAutomaticas e atualizarAlertas)
        this.renderizarProcessos();

        // Fechar modal e mostrar confirmação
        this.fecharModalConfiguracoes();
        alert('Configurações salvas com sucesso!');
    }

    atualizarLabelsConfiguracoes() {
        const diasAtencao = ProcessoManager.DIAS_ATENCAO;
        const diasCritico = ProcessoManager.DIAS_CRITICO;

        // Atualizar cards de alerta
        const descCriticos = document.getElementById('alert-criticos-desc');
        if (descCriticos) descCriticos.textContent = `≥${diasCritico} dias`;

        const descAtencao = document.getElementById('alert-atencao-desc');
        if (descAtencao) descAtencao.textContent = `${diasAtencao}-${diasCritico - 1} dias`;

        // Atualizar labels do monitoramento (agora baseado em DIAS_CRITICO)
        const label70Atuais = document.getElementById('alert-70dias-atuais-label');
        if (label70Atuais) label70Atuais.textContent = `Já críticos (${diasCritico}+ dias)`;

        const label70Proximos = document.getElementById('alert-70dias-proximos-label');
        if (label70Proximos) {
            const mesDesc = document.getElementById('alert-70dias-mes-desc');
            const mesTexto = mesDesc ? mesDesc.textContent : '';
            label70Proximos.innerHTML = `Atingirão nível crítico <span id="alert-70dias-mes-desc">${mesTexto}</span>`;
        }

        // Atualizar legenda do heatmap/planejamento
        const legendaCritico = document.getElementById('legenda-critico');
        if (legendaCritico) legendaCritico.textContent = `Crítico (≥${diasCritico} dias)`;

        const legendaAtencao = document.getElementById('legenda-atencao');
        if (legendaAtencao) legendaAtencao.textContent = `Atenção (${diasAtencao}-${diasCritico - 1} dias)`;

        const legendaNormal = document.getElementById('legenda-normal');
        if (legendaNormal) legendaNormal.textContent = `Normal (<${diasAtencao} dias)`;
    }

    abrirModalConfiguracoes() {
        const modal = document.getElementById('modal-configuracoes');

        // Preencher campos com valores atuais
        document.getElementById('config-dias-atencao').value = ProcessoManager.DIAS_ATENCAO;
        document.getElementById('config-dias-critico').value = ProcessoManager.DIAS_CRITICO;

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        // Configurar eventos de fechar
        const closeButtons = modal.querySelectorAll('.close-modal-configuracoes');
        closeButtons.forEach(btn => {
            btn.onclick = () => this.fecharModalConfiguracoes();
        });

        // Fechar ao clicar fora
        modal.onclick = (e) => {
            if (e.target === modal) {
                this.fecharModalConfiguracoes();
            }
        };
    }

    fecharModalConfiguracoes() {
        const modal = document.getElementById('modal-configuracoes');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    // ============================================
    // GERENCIAMENTO DE FÉRIAS E FERIADOS
    // ============================================

    carregarFeriados() {
        try {
            const dados = localStorage.getItem('feriados');
            return dados ? JSON.parse(dados) : [];
        } catch (error) {
            console.error('Erro ao carregar feriados:', error);
            return [];
        }
    }

    salvarFeriados() {
        try {
            localStorage.setItem('feriados', JSON.stringify(this.feriados));
        } catch (error) {
            console.error('Erro ao salvar feriados:', error);
        }
    }

    carregarFerias() {
        try {
            const dados = localStorage.getItem('ferias');
            return dados ? JSON.parse(dados) : [];
        } catch (error) {
            console.error('Erro ao carregar férias:', error);
            return [];
        }
    }

    salvarFerias() {
        try {
            localStorage.setItem('ferias', JSON.stringify(this.ferias));
        } catch (error) {
            console.error('Erro ao salvar férias:', error);
        }
    }

    abrirModalAdicionarFeriado() {
        const modal = document.getElementById('modal-adicionar-feriado');
        document.getElementById('feriado-nome').value = '';
        document.getElementById('feriado-data').value = '';
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalAdicionarFeriado() {
        const modal = document.getElementById('modal-adicionar-feriado');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    adicionarFeriado() {
        const nome = document.getElementById('feriado-nome').value.trim();
        const data = document.getElementById('feriado-data').value;

        if (!nome || !data) {
            alert('Por favor, preencha todos os campos.');
            return;
        }

        this.feriados.push({ nome, data });
        this.salvarFeriados();
        this.fecharModalAdicionarFeriado();
        this.mostrarNotificacao('Feriado adicionado com sucesso!', 'success');

        // Atualizar calendário se estiver aberto
        this.atualizarHeatmapSeAberto();
    }

    abrirModalAdicionarFerias() {
        const modal = document.getElementById('modal-adicionar-ferias');
        // Limpar os 3 períodos
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`ferias-data-inicial-${i}`).value = '';
            document.getElementById(`ferias-data-final-${i}`).value = '';
        }
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalAdicionarFerias() {
        const modal = document.getElementById('modal-adicionar-ferias');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    adicionarFerias() {
        const periodosAdicionados = [];

        // Processar os 3 períodos
        for (let i = 1; i <= 3; i++) {
            const dataInicial = document.getElementById(`ferias-data-inicial-${i}`).value;
            const dataFinal = document.getElementById(`ferias-data-final-${i}`).value;

            // Se ambos os campos estão vazios, ignorar este período
            if (!dataInicial && !dataFinal) {
                continue;
            }

            // Se apenas um campo está preenchido, mostrar erro
            if (!dataInicial || !dataFinal) {
                alert(`Período ${i}: Por favor, preencha ambas as datas ou deixe ambas vazias.`);
                return;
            }

            // Validar se data inicial não é posterior à final
            if (dataInicial > dataFinal) {
                alert(`Período ${i}: A data inicial não pode ser posterior à data final.`);
                return;
            }

            periodosAdicionados.push({ dataInicial, dataFinal });
        }

        // Verificar se pelo menos um período foi preenchido
        if (periodosAdicionados.length === 0) {
            alert('Por favor, preencha pelo menos um período de férias.');
            return;
        }

        // Adicionar todos os períodos válidos
        for (const periodo of periodosAdicionados) {
            this.ferias.push(periodo);
        }

        this.salvarFerias();
        this.fecharModalAdicionarFerias();

        const mensagem = periodosAdicionados.length === 1
            ? 'Período de férias adicionado com sucesso!'
            : `${periodosAdicionados.length} períodos de férias adicionados com sucesso!`;
        this.mostrarNotificacao(mensagem, 'success');

        // Atualizar calendário se estiver aberto
        this.atualizarHeatmapSeAberto();
    }

    abrirModalGerenciarDiasNaoUteis() {
        const modal = document.getElementById('modal-gerenciar-dias-nao-uteis');
        this.renderizarListaFeriados();
        this.renderizarListaFerias();
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    fecharModalGerenciarDiasNaoUteis() {
        const modal = document.getElementById('modal-gerenciar-dias-nao-uteis');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    renderizarListaFeriados() {
        const container = document.getElementById('lista-feriados');

        if (this.feriados.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8; font-style: italic; padding: 16px; background: #f8fafc; border-radius: 10px; text-align: center;">Nenhum feriado cadastrado.</p>';
            return;
        }

        // Ordenar por data
        const feriadosOrdenados = [...this.feriados].sort((a, b) => a.data.localeCompare(b.data));

        container.innerHTML = feriadosOrdenados.map((feriado, index) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: #f8fafc; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #1e293b; font-size: 1rem; margin-bottom: 4px;">${this.escaparHTML(feriado.nome)}</div>
                    <div style="color: #64748b; font-size: 0.9rem;">${this.formatarData(feriado.data)}</div>
                </div>
                <button onclick="manager.removerFeriado(${index})" style="background: #fee2e2; color: #dc2626; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Remover
                </button>
            </div>
        `).join('');
    }

    renderizarListaFerias() {
        const container = document.getElementById('lista-ferias');

        if (this.ferias.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8; font-style: italic; padding: 16px; background: #f8fafc; border-radius: 10px; text-align: center;">Nenhum período de férias cadastrado.</p>';
            return;
        }

        // Ordenar por data inicial
        const feriasOrdenadas = [...this.ferias].sort((a, b) => a.dataInicial.localeCompare(b.dataInicial));

        container.innerHTML = feriasOrdenadas.map((periodo, index) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: #f8fafc; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #1e293b; font-size: 1rem; margin-bottom: 4px;">Período de Férias</div>
                    <div style="color: #64748b; font-size: 0.9rem;">${this.formatarData(periodo.dataInicial)} até ${this.formatarData(periodo.dataFinal)}</div>
                </div>
                <button onclick="manager.removerFerias(${index})" style="background: #fee2e2; color: #dc2626; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Remover
                </button>
            </div>
        `).join('');
    }

    removerFeriado(index) {
        if (confirm('Deseja realmente remover este feriado?')) {
            this.feriados.splice(index, 1);
            this.salvarFeriados();
            this.renderizarListaFeriados();
            this.mostrarNotificacao('Feriado removido com sucesso!', 'success');

            // Atualizar calendário se estiver aberto
            this.atualizarHeatmapSeAberto();
        }
    }

    removerFerias(index) {
        if (confirm('Deseja realmente remover este período de férias?')) {
            this.ferias.splice(index, 1);
            this.salvarFerias();
            this.renderizarListaFerias();
            this.mostrarNotificacao('Período de férias removido com sucesso!', 'success');

            // Atualizar calendário se estiver aberto
            this.atualizarHeatmapSeAberto();
        }
    }

    ehDiaNaoUtil(data) {
        const dataStr = this.formatarDataISO(data);

        // Verificar se é feriado
        if (this.feriados.some(f => f.data === dataStr)) {
            return 'feriado';
        }

        // Verificar se está em período de férias
        for (const periodo of this.ferias) {
            if (dataStr >= periodo.dataInicial && dataStr <= periodo.dataFinal) {
                return 'ferias';
            }
        }

        return false;
    }

    formatarDataISO(data) {
        const ano = data.getFullYear();
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const dia = String(data.getDate()).padStart(2, '0');
        return `${ano}-${mes}-${dia}`;
    }

    // ============================================
    // HEATMAP DE PRAZOS - CALENDÁRIO MENSAL
    // ============================================

    abrirModalHeatmap() {
        const modal = document.getElementById('modal-heatmap');
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        // Inicializar com o mês atual se não houver mês selecionado
        if (!this.mesAtualHeatmap) {
            const hoje = new Date();
            this.mesAtualHeatmap = hoje.getMonth();
            this.anoAtualHeatmap = hoje.getFullYear();
        }

        this.gerarCalendarioMensal();
    }

    fecharModalHeatmap() {
        const modal = document.getElementById('modal-heatmap');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    // Função auxiliar para atualizar o heatmap se ele estiver aberto
    atualizarHeatmapSeAberto() {
        const modal = document.getElementById('modal-heatmap');
        if (modal && modal.classList.contains('active')) {
            // Heatmap está aberto, atualizar o calendário
            this.gerarCalendarioMensal();
        }
    }

    navegarMesHeatmap(direcao) {
        this.mesAtualHeatmap += direcao;

        if (this.mesAtualHeatmap > 11) {
            this.mesAtualHeatmap = 0;
            this.anoAtualHeatmap++;
        } else if (this.mesAtualHeatmap < 0) {
            this.mesAtualHeatmap = 11;
            this.anoAtualHeatmap--;
        }

        this.gerarCalendarioMensal();
    }

    gerarCalendarioMensal() {
        // Filtrar processos em andamento (ignora filtro de busca - mostra todos)
        const processosEmAndamento = this.processos.filter(p =>
            (p.status === 'aguardando-despacho' || p.status === 'concluso') &&
            p.dataConclusao
        );

        // 3. Usar a MESMA ordenação da tabela "Processos em Andamento"
        const processosOrdenados = this.ordenarProcessos(processosEmAndamento, 'andamento');

        // 4. Gerar calendário do mês
        const diasDoMes = this.gerarDiasDoMes(this.anoAtualHeatmap, this.mesAtualHeatmap);

        // 5. Distribuir processos apenas nos dias úteis (3 por dia) - usa a mesma ordem da tabela
        const distribuicao = this.distribuirProcessosNoMes(processosOrdenados, diasDoMes);

        // 6. Atualizar título do mês
        this.atualizarTituloMes();

        // 7. Renderizar calendário
        this.renderizarCalendarioMensal(distribuicao);
    }

    gerarDiasDoMes(ano, mes) {
        const dias = [];

        // Primeiro dia do mês
        const primeiroDia = new Date(ano, mes, 1);

        // Último dia do mês
        const ultimoDia = new Date(ano, mes + 1, 0);

        // Dia da semana do primeiro dia (0=Dom, 1=Seg, ..., 6=Sáb)
        let diaSemanaInicial = primeiroDia.getDay();

        // Ajustar para segunda-feira ser o primeiro dia (0=Seg, ..., 6=Dom)
        diaSemanaInicial = diaSemanaInicial === 0 ? 6 : diaSemanaInicial - 1;

        // Adicionar dias do mês anterior para completar a primeira semana
        const diasMesAnterior = new Date(ano, mes, 0).getDate();
        for (let i = diaSemanaInicial - 1; i >= 0; i--) {
            const dia = diasMesAnterior - i;
            dias.push({
                dia: dia,
                mes: mes - 1,
                ano: mes === 0 ? ano - 1 : ano,
                mesAtual: false,
                data: new Date(mes === 0 ? ano - 1 : ano, mes === 0 ? 11 : mes - 1, dia)
            });
        }

        // Adicionar dias do mês atual
        for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
            dias.push({
                dia: dia,
                mes: mes,
                ano: ano,
                mesAtual: true,
                data: new Date(ano, mes, dia)
            });
        }

        // Adicionar dias do próximo mês para completar as semanas (até 42 dias = 6 semanas)
        const diasRestantes = 42 - dias.length;
        for (let dia = 1; dia <= diasRestantes; dia++) {
            dias.push({
                dia: dia,
                mes: mes + 1,
                ano: mes === 11 ? ano + 1 : ano,
                mesAtual: false,
                data: new Date(mes === 11 ? ano + 1 : ano, mes === 11 ? 0 : mes + 1, dia)
            });
        }

        return dias;
    }

    distribuirProcessosNoMes(processos, diasDoMes) {
        const distribuicao = new Map();

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        // Calcular o primeiro dia do mês visualizado
        const primeiroDiaMesVisualizado = new Date(this.anoAtualHeatmap, this.mesAtualHeatmap, 1);
        primeiroDiaMesVisualizado.setHours(0, 0, 0, 0);

        // Contar quantos dias úteis existem entre HOJE e o primeiro dia do mês visualizado
        // (para saber quantos processos já foram "consumidos" em meses anteriores)
        let diasUteisAnteriores = 0;

        if (primeiroDiaMesVisualizado > hoje) {
            // O mês visualizado é futuro - contar dias úteis entre hoje e o início do mês
            let dataIteracao = new Date(hoje);

            while (dataIteracao < primeiroDiaMesVisualizado) {
                const diaSemana = dataIteracao.getDay();
                const ehDiaUtil = diaSemana !== 0 && diaSemana !== 6;
                const naoEhFeriadoNemFerias = !this.ehDiaNaoUtil(dataIteracao);

                if (ehDiaUtil && naoEhFeriadoNemFerias) {
                    diasUteisAnteriores++;
                }

                dataIteracao.setDate(dataIteracao.getDate() + 1);
            }
        }

        // Calcular o índice inicial dos processos (pular os já distribuídos em meses anteriores)
        let indiceProcesso = diasUteisAnteriores * 3; // 3 processos por dia útil

        // Filtrar apenas dias úteis do mês atual que sejam >= hoje E não sejam feriados/férias
        const diasUteisDisponiveis = diasDoMes.filter(diaObj => {
            const diaSemana = diaObj.data.getDay();
            const ehDiaUtil = diaSemana !== 0 && diaSemana !== 6; // Não é sábado nem domingo
            const ehMesAtual = diaObj.mesAtual;
            const ehFuturoOuHoje = diaObj.data >= hoje;
            const naoEhFeriadoNemFerias = !this.ehDiaNaoUtil(diaObj.data); // Excluir feriados e férias

            return ehDiaUtil && ehMesAtual && ehFuturoOuHoje && naoEhFeriadoNemFerias;
        });

        // =============================================
        // SISTEMA DE POSIÇÕES CUSTOMIZADAS (DRAG DROP)
        // =============================================

        // Separar processos com posição customizada dos processos normais
        const processosComPosicaoCustom = [];
        const processosParaDistribuir = [];

        processos.forEach(p => {
            const customPos = this.posicoesCustomizadas && this.posicoesCustomizadas[p.numeroProcesso];
            if (customPos) {
                processosComPosicaoCustom.push({
                    processo: p,
                    dataDestino: customPos.dataDestino
                });
            } else {
                processosParaDistribuir.push(p);
            }
        });

        // Primeiro, colocar processos com posições customizadas nos seus dias designados
        // SEM LIMITE - o usuário pode arrastar quantos quiser para um dia
        processosComPosicaoCustom.forEach(({ processo, dataDestino }) => {
            if (!distribuicao.has(dataDestino)) {
                distribuicao.set(dataDestino, []);
            }
            distribuicao.get(dataDestino).push(processo);
        });

        // Distribuir processos normais nos dias úteis (3 por dia automático)
        // Processos customizados NÃO contam contra o limite de 3
        for (const diaObj of diasUteisDisponiveis) {
            const chave = `${diaObj.ano}-${diaObj.mes}-${diaObj.dia}`;

            // Contar apenas processos AUTOMÁTICOS já neste dia (não os customizados)
            const processosExistentes = distribuicao.get(chave) || [];
            const processosAutomaticosNoDia = processosExistentes.filter(p =>
                !processosComPosicaoCustom.some(pc => pc.processo.numeroProcesso === p.numeroProcesso)
            ).length;

            let processosAdicionadosHoje = 0;

            // Adicionar até 3 processos automáticos por dia
            while (indiceProcesso < processosParaDistribuir.length && processosAdicionadosHoje < 3) {
                const processo = processosParaDistribuir[indiceProcesso];

                // Verificar se este processo já está em outro lugar (customizado)
                const jaCustomizado = processosComPosicaoCustom.some(pc => pc.processo.numeroProcesso === processo.numeroProcesso);
                if (jaCustomizado) {
                    indiceProcesso++;
                    continue;
                }

                // Adicionar ao dia
                if (!distribuicao.has(chave)) {
                    distribuicao.set(chave, []);
                }

                distribuicao.get(chave).push(processo);
                processosAdicionadosHoje++;
                indiceProcesso++;
            }

            // Se já distribuímos todos os processos, parar
            if (indiceProcesso >= processosParaDistribuir.length) break;
        }

        return distribuicao;
    }

    atualizarTituloMes() {
        const meses = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        const titulo = `${meses[this.mesAtualHeatmap]} ${this.anoAtualHeatmap}`;
        document.getElementById('month-title-heatmap').textContent = titulo;
    }

    renderizarCalendarioMensal(distribuicao) {
        const container = document.getElementById('heatmap-container');
        const diasDoMes = this.gerarDiasDoMes(this.anoAtualHeatmap, this.mesAtualHeatmap);

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        // Cabeçalhos dos dias da semana
        let html = `
            <div class="calendar-day-header-heatmap">SEG</div>
            <div class="calendar-day-header-heatmap">TER</div>
            <div class="calendar-day-header-heatmap">QUA</div>
            <div class="calendar-day-header-heatmap">QUI</div>
            <div class="calendar-day-header-heatmap">SEX</div>
            <div class="calendar-day-header-heatmap weekend-header">SÁB</div>
            <div class="calendar-day-header-heatmap weekend-header">DOM</div>
        `;

        // Renderizar cada dia
        diasDoMes.forEach(diaObj => {
            const diaSemana = diaObj.data.getDay();
            const ehFimDeSemana = diaSemana === 0 || diaSemana === 6;
            const ehHoje = diaObj.data.getTime() === hoje.getTime();

            const chave = `${diaObj.ano}-${diaObj.mes}-${diaObj.dia}`;
            const processos = distribuicao.get(chave) || [];

            // Classes CSS
            let classes = ['calendar-day-heatmap'];
            if (ehFimDeSemana) classes.push('weekend');
            if (!diaObj.mesAtual) classes.push('other-month');

            // Verificar se é feriado ou férias
            const tipoDiaNaoUtil = this.ehDiaNaoUtil(diaObj.data);
            if (tipoDiaNaoUtil === 'feriado') classes.push('feriado');
            if (tipoDiaNaoUtil === 'ferias') classes.push('ferias');

            // Calcular dias entre hoje e a data do calendário (para previsão)
            const diasAteData = Math.floor((diaObj.data - hoje) / (1000 * 60 * 60 * 24));
            const diasAdicionais = diasAteData > 0 ? diasAteData : 0;

            // Renderizar processos do dia
            const processosHtml = processos.map(p => {
                const diasConclusosHoje = this.calcularDiasNumerico(p.dataConclusao);
                // Previsão: dias atuais + dias até a data do calendário
                const diasPrevisao = diasConclusosHoje + diasAdicionais;
                let classeUrgencia = 'processo-item-heatmap';

                // Usar a previsão para determinar urgência
                if (diasPrevisao >= ProcessoManager.DIAS_CRITICO) {
                    classeUrgencia += ' critico';
                } else if (diasPrevisao >= ProcessoManager.DIAS_ATENCAO) {
                    classeUrgencia += ' urgente';
                }

                // Verificar se é posição customizada
                const ehCustomizado = this.posicaoCustomizada(p.numeroProcesso, chave);
                if (ehCustomizado) {
                    classeUrgencia += ' customizado';
                }

                return `
                    <div class="${classeUrgencia}"
                         draggable="true"
                         data-processo-id="${p.numeroProcesso}"
                         data-data-origem="${chave}"
                         ondragstart="manager.handleDragStart(event)"
                         ondragend="manager.handleDragEnd(event)">
                        <span class="processo-numero-heatmap">
                            ${p.numeroProcesso}
                            <button class="btn-copiar-heatmap" onclick="manager.copiarNumeroProcesso('${p.numeroProcesso}', event)" title="Copiar número">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </span>
                        <span class="processo-dias-heatmap">${diasPrevisao} dias</span>
                        ${this.renderizarPrioridadeBadge(p.prioridade)}
                    </div>
                `;
            }).join('');

            html += `
                <div class="${classes.join(' ')}"
                     data-data="${chave}"
                     ondragover="manager.handleDragOver(event)"
                     ondragleave="manager.handleDragLeave(event)"
                     ondrop="manager.handleDrop(event)">
                    <div class="day-number-heatmap ${ehHoje ? 'today' : ''}">${diaObj.dia}</div>
                    ${processosHtml}
                </div>
            `;
        });

        container.innerHTML = html;
    }

    calcularDiasNumerico(dataConclusao) {
        if (!dataConclusao) return 0;

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const dataConc = new Date(dataConclusao + 'T00:00:00');
        const diffDias = Math.floor((hoje - dataConc) / (1000 * 60 * 60 * 24));

        return diffDias >= 0 ? diffDias : 0;
    }

    abrirCalendarioNovaba() {
        // Filtrar processos em andamento
        const processosEmAndamento = this.processos.filter(p =>
            (p.status === 'aguardando-despacho' || p.status === 'concluso') &&
            p.dataConclusao
        );

        // Ordenar por data de conclusão (mais antigos primeiro)
        processosEmAndamento.sort((a, b) =>
            new Date(a.dataConclusao) - new Date(b.dataConclusao)
        );

        console.log('📊 Preparando calendário com', processosEmAndamento.length, 'processos');

        // Converter para JSON e codificar para URL
        const dadosJson = JSON.stringify(processosEmAndamento);
        const dadosCodificados = encodeURIComponent(dadosJson);

        // Abrir nova aba com os dados na URL
        const url = `calendario-planejamento.html?dados=${dadosCodificados}`;
        window.open(url, '_blank');
    }

    // ============================================
    // DRAG AND DROP - CALENDÁRIO DE PLANEJAMENTO
    // ============================================

    inicializarDragDrop() {
        // Carregar posições customizadas do localStorage
        const saved = localStorage.getItem('calendario-posicoes-customizadas');
        this.posicoesCustomizadas = saved ? JSON.parse(saved) : {};
    }

    salvarPosicoesCustomizadas() {
        localStorage.setItem('calendario-posicoes-customizadas', JSON.stringify(this.posicoesCustomizadas));
    }

    posicaoCustomizada(processoId, dataAtual) {
        // Verifica se o processo foi movido para esta data
        return this.posicoesCustomizadas &&
               this.posicoesCustomizadas[processoId] &&
               this.posicoesCustomizadas[processoId].dataDestino === dataAtual;
    }

    handleDragStart(event) {
        const elemento = event.target.closest('.processo-item-heatmap');
        if (!elemento) return;

        const processoId = elemento.dataset.processoId;
        const dataOrigem = elemento.dataset.dataOrigem;

        // Armazenar dados no evento de drag
        event.dataTransfer.setData('text/plain', JSON.stringify({
            processoId: processoId,
            dataOrigem: dataOrigem
        }));

        event.dataTransfer.effectAllowed = 'move';

        // Adicionar classe visual
        elemento.classList.add('dragging');

        // Armazenar referência para uso posterior
        this.elementoArrastando = elemento;
    }

    handleDragEnd(event) {
        const elemento = event.target.closest('.processo-item-heatmap');
        if (elemento) {
            elemento.classList.remove('dragging');
        }

        // Remover classe de todos os dias
        document.querySelectorAll('.calendar-day-heatmap.drag-over').forEach(el => {
            el.classList.remove('drag-over');
        });

        this.elementoArrastando = null;
    }

    handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        const diaElement = event.target.closest('.calendar-day-heatmap');
        if (diaElement && !diaElement.classList.contains('drag-over')) {
            // Remover de outros
            document.querySelectorAll('.calendar-day-heatmap.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            diaElement.classList.add('drag-over');
        }
    }

    handleDragLeave(event) {
        const diaElement = event.target.closest('.calendar-day-heatmap');
        if (diaElement) {
            // Verificar se realmente saiu do elemento (não apenas entrou em filho)
            const relatedTarget = event.relatedTarget;
            if (!diaElement.contains(relatedTarget)) {
                diaElement.classList.remove('drag-over');
            }
        }
    }

    handleDrop(event) {
        event.preventDefault();

        const diaDestino = event.target.closest('.calendar-day-heatmap');
        if (!diaDestino) return;

        // Remover classe visual
        diaDestino.classList.remove('drag-over');

        // Obter dados do processo arrastado
        let dados;
        try {
            dados = JSON.parse(event.dataTransfer.getData('text/plain'));
        } catch (e) {
            console.error('Erro ao processar dados do drag:', e);
            return;
        }

        const { processoId, dataOrigem } = dados;
        const dataDestino = diaDestino.dataset.data;

        // Não fazer nada se for o mesmo dia
        if (dataOrigem === dataDestino) return;

        // Registrar a movimentação
        this.moverProcessoNoCalendario(processoId, dataOrigem, dataDestino);
    }

    moverProcessoNoCalendario(processoId, dataOrigem, dataDestino) {
        // Inicializar objeto se necessário
        if (!this.posicoesCustomizadas) {
            this.posicoesCustomizadas = {};
        }

        // Registrar a nova posição
        this.posicoesCustomizadas[processoId] = {
            dataOrigem: dataOrigem,
            dataDestino: dataDestino,
            dataMovimentacao: new Date().toISOString()
        };

        // Salvar no localStorage
        this.salvarPosicoesCustomizadas();

        // Re-renderizar o calendário imediatamente
        this.gerarCalendarioMensal();

        // Feedback visual
        this.mostrarNotificacao(`Processo movido para ${this.formatarDataChave(dataDestino)}`, 'sucesso');
    }

    formatarDataChave(chave) {
        // Converte "2024-0-15" para "15/01/2024"
        const partes = chave.split('-');
        const ano = partes[0];
        const mes = parseInt(partes[1]) + 1;
        const dia = partes[2];
        return `${dia.padStart(2, '0')}/${mes.toString().padStart(2, '0')}/${ano}`;
    }

    mostrarNotificacao(mensagem, tipo = 'info') {
        // Criar elemento de notificação
        const notif = document.createElement('div');
        notif.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            background: ${tipo === 'sucesso' ? 'linear-gradient(135deg, #16a34a, #22c55e)' : '#3b82f6'};
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        `;
        notif.textContent = mensagem;
        document.body.appendChild(notif);

        // Remover após 3 segundos
        setTimeout(() => {
            notif.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => notif.remove(), 300);
        }, 3000);
    }

    limparPosicoesCustomizadas() {
        this.posicoesCustomizadas = {};
        this.salvarPosicoesCustomizadas();
        this.gerarCalendarioMensal();
        this.mostrarNotificacao('Posições resetadas para o padrão', 'sucesso');
    }

    imprimirCalendario() {
        // Obter o título do mês atual para exibir na impressão
        const tituloMes = document.getElementById('month-title-heatmap').textContent;

        // Adicionar título temporário para impressão
        const modalHeader = document.querySelector('#modal-heatmap .modal-header h2');
        const tituloOriginal = modalHeader.textContent;
        modalHeader.textContent = `Planejamento de Prazos - ${tituloMes}`;

        // Imprimir
        window.print();

        // Restaurar título original após impressão
        setTimeout(() => {
            modalHeader.textContent = tituloOriginal;
        }, 500);
    }

    // ============================================
    // FIM DO HEATMAP DE PRAZOS
    // ============================================

    atualizarRelatorioProducao() {
        const mes = parseInt(document.getElementById('producao-mes').value);
        const ano = parseInt(document.getElementById('producao-ano').value);

        // Contar despachados no mês
        const despachados = this.processos.filter(p => {
            if (!p.dataDespacho) return false;
            const data = new Date(p.dataDespacho + 'T00:00:00');
            return data.getMonth() + 1 === mes && data.getFullYear() === ano;
        }).length;

        // Contar finalizados no mês
        const finalizados = this.processos.filter(p => {
            if (!p.dataFinalizacao) return false;
            const data = new Date(p.dataFinalizacao + 'T00:00:00');
            return data.getMonth() + 1 === mes && data.getFullYear() === ano;
        }).length;

        const total = despachados + finalizados;

        // Atualizar cards
        document.getElementById('producao-total-despachados').textContent = despachados;
        document.getElementById('producao-total-finalizados').textContent = finalizados;
        document.getElementById('producao-total-geral').textContent = total;

        // Mostrar/ocultar mensagem
        const mensagem = document.getElementById('producao-mensagem');
        if (total === 0) {
            mensagem.textContent = 'Nenhuma produção encontrada no período selecionado.';
            mensagem.style.display = 'block';
        } else {
            mensagem.style.display = 'none';
        }
    }

    // ============================================
    // SISTEMA DE ABAS PARA PROCESSOS FINALIZADOS
    // ============================================

    inicializarSistemaFinalizados() {
        this.finalizadosState = {
            anoSelecionado: new Date().getFullYear(),
            mesSelecionado: null,
            dropdownAberto: false
        };

        // Carregar preferências salvas
        const saved = localStorage.getItem('finalizados-preferencias');
        if (saved) {
            const prefs = JSON.parse(saved);
            this.finalizadosState.anoSelecionado = prefs.ano || new Date().getFullYear();
            this.finalizadosState.mesSelecionado = prefs.mes || null;
        }

        // Restaurar visibilidade do sistema de abas
        const filterContainer = document.querySelector('.finalizados-filter-container');
        if (filterContainer) {
            filterContainer.style.display = '';
        }

        this.renderizarSistemaFinalizados();
    }

    salvarPreferenciasFinalizados() {
        localStorage.setItem('finalizados-preferencias', JSON.stringify({
            ano: this.finalizadosState.anoSelecionado,
            mes: this.finalizadosState.mesSelecionado
        }));
    }

    obterAnosDisponiveis() {
        const processosFinalizados = this.processos.filter(p => p.status === 'finalizado');
        if (processosFinalizados.length === 0) return [new Date().getFullYear()];

        const anos = new Set();
        processosFinalizados.forEach(p => {
            if (p.dataFinalizacao) {
                const ano = new Date(p.dataFinalizacao + 'T00:00:00').getFullYear();
                anos.add(ano);
            }
        });

        return Array.from(anos).sort((a, b) => b - a);
    }

    obterMesesComProcessos(ano) {
        const processosDoAno = this.processos.filter(p => {
            if (p.status !== 'finalizado' || !p.dataFinalizacao) return false;
            const data = new Date(p.dataFinalizacao + 'T00:00:00');
            return data.getFullYear() === ano;
        });

        const mesesMap = {};
        processosDoAno.forEach(p => {
            const data = new Date(p.dataFinalizacao + 'T00:00:00');
            const mes = data.getMonth() + 1;
            mesesMap[mes] = (mesesMap[mes] || 0) + 1;
        });

        return mesesMap;
    }

    renderizarSistemaFinalizados() {
        const anos = this.obterAnosDisponiveis();
        const ano = this.finalizadosState.anoSelecionado;

        // Renderizar seletor de ano
        const yearSelect = document.getElementById('finalizados-year-select');
        yearSelect.innerHTML = anos.map(a =>
            `<option value="${a}" ${a === ano ? 'selected' : ''}>${a}</option>`
        ).join('');

        // Obter meses com processos
        const mesesMap = this.obterMesesComProcessos(ano);
        const mesesOrdenados = Object.keys(mesesMap).map(Number).sort((a, b) => b - a);

        // Renderizar abas
        this.renderizarAbas(mesesOrdenados, mesesMap, ano);

        // Selecionar aba padrão
        if (!this.finalizadosState.mesSelecionado) {
            if (mesesOrdenados.length > 0) {
                this.finalizadosState.mesSelecionado = mesesOrdenados[0];
            } else {
                this.finalizadosState.mesSelecionado = 'todos';
            }
        }

        // Renderizar conteúdo
        this.renderizarConteudoAba();
    }

    renderizarAbas(meses, mesesMap, ano) {
        const tabsContainer = document.getElementById('finalizados-tabs');

        const nomesMeses = [
            '', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
            'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
        ];

        // Mostrar últimos 3 meses + dropdown "Mais meses"
        const mesesVisiveis = meses.slice(0, 3);
        const mesesNoDropdown = meses.slice(3);

        let html = '';

        // Abas dos últimos 3 meses
        mesesVisiveis.forEach((mes, index) => {
            const count = mesesMap[mes];
            const active = this.finalizadosState.mesSelecionado === mes ? 'active' : '';
            const tabindex = active ? '0' : '-1';
            html += `
                <button class="finalizados-tab ${active}"
                        onclick="manager.selecionarMesFinalizados(${mes})"
                        data-mes="${mes}"
                        role="tab"
                        aria-selected="${active ? 'true' : 'false'}"
                        tabindex="${tabindex}">
                    ${nomesMeses[mes]}/${ano}
                    <span class="finalizados-tab-badge">${count}</span>
                </button>
            `;
        });

        // Dropdown "Mais meses" (se houver)
        if (mesesNoDropdown.length > 0) {
            const dropdownActive = mesesNoDropdown.includes(this.finalizadosState.mesSelecionado) ? 'active' : '';
            html += `
                <div class="finalizados-dropdown" id="finalizados-dropdown">
                    <button class="finalizados-dropdown-button ${dropdownActive}" onclick="manager.toggleDropdownFinalizados(event)">
                        Mais meses
                        <span class="finalizados-dropdown-icon">▼</span>
                    </button>
                    <div class="finalizados-dropdown-menu">
                        ${mesesNoDropdown.map(mes => {
                            const count = mesesMap[mes];
                            const active = this.finalizadosState.mesSelecionado === mes ? 'active' : '';
                            return `
                                <div class="finalizados-dropdown-item ${active}" onclick="manager.selecionarMesFinalizados(${mes})">
                                    <span>${nomesMeses[mes]}/${ano}</span>
                                    <span class="finalizados-dropdown-item-badge">${count}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Aba "Todos"
        const totalProcessos = Object.values(mesesMap).reduce((a, b) => a + b, 0);
        const todosActive = this.finalizadosState.mesSelecionado === 'todos' ? 'active' : '';
        const todosTabindex = todosActive ? '0' : '-1';
        html += `
            <button class="finalizados-tab ${todosActive}"
                    onclick="manager.selecionarMesFinalizados('todos')"
                    data-mes="todos"
                    role="tab"
                    aria-selected="${todosActive ? 'true' : 'false'}"
                    tabindex="${todosTabindex}">
                Todos
                <span class="finalizados-tab-badge">${totalProcessos}</span>
            </button>
        `;

        tabsContainer.innerHTML = html;

        // Adicionar keyboard navigation
        this.adicionarKeyboardNavigationAbas();
    }

    adicionarKeyboardNavigationAbas() {
        const tabs = document.querySelectorAll('.finalizados-tab');

        tabs.forEach(tab => {
            tab.addEventListener('keydown', (e) => {
                const currentIndex = Array.from(tabs).indexOf(tab);
                let nextTab = null;

                switch (e.key) {
                    case 'ArrowRight':
                    case 'ArrowDown':
                        e.preventDefault();
                        nextTab = tabs[currentIndex + 1] || tabs[0];
                        break;
                    case 'ArrowLeft':
                    case 'ArrowUp':
                        e.preventDefault();
                        nextTab = tabs[currentIndex - 1] || tabs[tabs.length - 1];
                        break;
                    case 'Home':
                        e.preventDefault();
                        nextTab = tabs[0];
                        break;
                    case 'End':
                        e.preventDefault();
                        nextTab = tabs[tabs.length - 1];
                        break;
                    case 'Enter':
                    case ' ':
                        e.preventDefault();
                        tab.click();
                        return;
                }

                if (nextTab) {
                    nextTab.focus();
                    // Atualizar tabindex
                    tabs.forEach(t => t.setAttribute('tabindex', '-1'));
                    nextTab.setAttribute('tabindex', '0');
                }
            });
        });
    }

    toggleDropdownFinalizados(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('finalizados-dropdown');
        dropdown.classList.toggle('open');

        // Fechar ao clicar fora
        if (dropdown.classList.contains('open')) {
            const closeHandler = (e) => {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('open');
                    document.removeEventListener('click', closeHandler);
                }
            };
            setTimeout(() => document.addEventListener('click', closeHandler), 10);
        }
    }

    selecionarMesFinalizados(mes) {
        this.finalizadosState.mesSelecionado = mes;
        this.salvarPreferenciasFinalizados();

        // Atualizar abas ativas
        document.querySelectorAll('.finalizados-tab, .finalizados-dropdown-button, .finalizados-dropdown-item').forEach(el => {
            el.classList.remove('active');
        });

        if (mes === 'todos') {
            const todosTab = document.querySelector('.finalizados-tab[data-mes="todos"]');
            if (todosTab) todosTab.classList.add('active');
        } else {
            const tab = document.querySelector(`.finalizados-tab[data-mes="${mes}"]`);
            const dropdownItem = document.querySelector(`.finalizados-dropdown-item[onclick*="${mes}"]`);

            if (tab) {
                tab.classList.add('active');
            } else if (dropdownItem) {
                dropdownItem.classList.add('active');
                const dropdownBtn = document.querySelector('.finalizados-dropdown-button');
                if (dropdownBtn) dropdownBtn.classList.add('active');
            }
        }

        // Fechar dropdown
        const dropdown = document.getElementById('finalizados-dropdown');
        if (dropdown) dropdown.classList.remove('open');

        // Renderizar conteúdo
        this.renderizarConteudoAba();
    }

    mudarAnoFinalizados(ano) {
        this.finalizadosState.anoSelecionado = parseInt(ano);
        this.finalizadosState.mesSelecionado = null; // Resetar mês
        this.salvarPreferenciasFinalizados();
        this.renderizarSistemaFinalizados();
    }

    renderizarConteudoAba() {
        const container = document.getElementById('finalizados-tabs-content');
        const ano = this.finalizadosState.anoSelecionado;
        const mes = this.finalizadosState.mesSelecionado;

        // Filtrar processos
        let processosFiltrados;
        if (mes === 'todos') {
            processosFiltrados = this.processos.filter(p => {
                if (p.status !== 'finalizado' || !p.dataFinalizacao) return false;
                const data = new Date(p.dataFinalizacao + 'T00:00:00');
                return data.getFullYear() === ano;
            });
        } else {
            processosFiltrados = this.processos.filter(p => {
                if (p.status !== 'finalizado' || !p.dataFinalizacao) return false;
                const data = new Date(p.dataFinalizacao + 'T00:00:00');
                return data.getFullYear() === ano && data.getMonth() + 1 === mes;
            });
        }

        // Ordenar processos
        const processosOrdenados = this.ordenarProcessos(processosFiltrados, 'finalizados');

        // Renderizar
        if (processosOrdenados.length === 0) {
            container.innerHTML = `
                <div class="finalizados-empty-state">
                    <div class="finalizados-empty-state-icon">📭</div>
                    <div class="finalizados-empty-state-text">Nenhum processo finalizado</div>
                    <div class="finalizados-empty-state-subtext">Não há processos finalizados neste período</div>
                </div>
            `;
        } else {
            const nomesMeses = [
                '', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];

            const periodoTexto = mes === 'todos'
                ? `${processosOrdenados.length} processos finalizados em ${ano}`
                : `${processosOrdenados.length} processos finalizados em ${nomesMeses[mes]}/${ano}`;

            container.innerHTML = `
                <div class="finalizados-info-bar">
                    📊 ${periodoTexto}
                </div>
                <div class="table-responsive">
                    <table aria-label="Tabela de processos finalizados">
                        <thead>
                            <tr>
                                <th scope="col" class="sortable" onclick="manager.ordenarPor('finalizados', 'numero')">
                                    Número <span class="sort-indicator" id="sort-finalizados-numero"></span>
                                </th>
                                <th scope="col" class="sortable" onclick="manager.ordenarPor('finalizados', 'assunto')">
                                    Assunto <span class="sort-indicator" id="sort-finalizados-assunto"></span>
                                </th>
                                <th scope="col" class="sortable" onclick="manager.ordenarPor('finalizados', 'classe')">
                                    Classe processual <span class="sort-indicator" id="sort-finalizados-classe"></span>
                                </th>
                                <th scope="col" class="sortable" onclick="manager.ordenarPor('finalizados', 'dataFinalizacao')">
                                    Data da Finalização <span class="sort-indicator" id="sort-finalizados-dataFinalizacao">▼</span>
                                </th>
                                <th scope="col" class="sortable" onclick="manager.ordenarPor('finalizados', 'status')">
                                    Status <span class="sort-indicator" id="sort-finalizados-status"></span>
                                </th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${processosOrdenados.map(p => this.gerarLinhaProcesso(p, false, false)).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            this.atualizarIndicadoresOrdenacao('finalizados');
        }
    }
}

// Adicionar estilos de animação
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Adicionar métodos de gerenciamento de classes e assuntos ao ProcessoManager
ProcessoManager.prototype.atualizarSelectClasses = function() {
    const select = document.getElementById('classe-processual');
    const valorAtual = select.value;

    select.innerHTML = '<option value="">Selecione...</option>';

    this.classesProcessuais.forEach(classe => {
        const option = document.createElement('option');
        option.value = classe.slug;
        option.textContent = classe.nome;
        select.appendChild(option);
    });

    // Restaurar valor selecionado se ainda existir
    if (valorAtual) {
        select.value = valorAtual;
    }
};

ProcessoManager.prototype.atualizarSelectAssuntos = function() {
    const select = document.getElementById('assunto');
    const valorAtual = select.value;

    select.innerHTML = '<option value="">Selecione...</option>';

    this.assuntos.forEach(assunto => {
        const option = document.createElement('option');
        option.value = assunto.slug;
        option.textContent = assunto.nome;
        select.appendChild(option);
    });

    // Restaurar valor selecionado se ainda existir
    if (valorAtual) {
        select.value = valorAtual;
    }
};

ProcessoManager.prototype.atualizarSelectEditClasses = function() {
    const select = document.getElementById('edit-classe-processual');
    if (!select) return; // Garantir que o elemento existe

    const valorAtual = select.value;

    select.innerHTML = '<option value="">Selecione...</option>';

    this.classesProcessuais.forEach(classe => {
        const option = document.createElement('option');
        option.value = classe.slug;
        option.textContent = classe.nome;
        select.appendChild(option);
    });

    // Restaurar valor selecionado se ainda existir
    if (valorAtual) {
        select.value = valorAtual;
    }
};

ProcessoManager.prototype.atualizarSelectEditAssuntos = function() {
    const select = document.getElementById('edit-assunto');
    if (!select) return; // Garantir que o elemento existe

    const valorAtual = select.value;

    select.innerHTML = '<option value="">Selecione...</option>';

    this.assuntos.forEach(assunto => {
        const option = document.createElement('option');
        option.value = assunto.slug;
        option.textContent = assunto.nome;
        select.appendChild(option);
    });

    // Restaurar valor selecionado se ainda existir
    if (valorAtual) {
        select.value = valorAtual;
    }
};

ProcessoManager.prototype.renderizarListaClasses = function() {
    const lista = document.getElementById('lista-classes');
    lista.innerHTML = '';

    if (this.classesProcessuais.length === 0) {
        lista.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Nenhuma classe cadastrada ainda.</p>';
        return;
    }

    this.classesProcessuais.forEach(classe => {
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
            <span class="item-text">${this.escaparHTML(classe.nome)}</span>
            <div class="item-actions">
                <button class="btn-delete" onclick="manager.excluirClasse(${classe.id})">
                    🗑️ Excluir
                </button>
            </div>
        `;
        lista.appendChild(item);
    });
};

ProcessoManager.prototype.renderizarListaAssuntos = function() {
    const lista = document.getElementById('lista-assuntos');
    lista.innerHTML = '';

    if (this.assuntos.length === 0) {
        lista.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Nenhum assunto cadastrado ainda.</p>';
        return;
    }

    this.assuntos.forEach(assunto => {
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
            <span class="item-text">${this.escaparHTML(assunto.nome)}</span>
            <div class="item-actions">
                <button class="btn-delete" onclick="manager.excluirAssunto(${assunto.id})">
                    🗑️ Excluir
                </button>
            </div>
        `;
        lista.appendChild(item);
    });
};

// Modais de gerenciamento
ProcessoManager.prototype.abrirModalGerenciarClasses = function() {
    const modal = document.getElementById('modal-gerenciar-classes');
    this.renderizarListaClasses();
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
};

ProcessoManager.prototype.fecharModalGerenciarClasses = function() {
    const modal = document.getElementById('modal-gerenciar-classes');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    document.getElementById('nova-classe').value = '';
    this.atualizarSelectClasses();
    this.atualizarSelectEditClasses();
};

ProcessoManager.prototype.abrirModalGerenciarAssuntos = function() {
    const modal = document.getElementById('modal-gerenciar-assuntos');
    this.renderizarListaAssuntos();
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
};

ProcessoManager.prototype.fecharModalGerenciarAssuntos = function() {
    const modal = document.getElementById('modal-gerenciar-assuntos');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    document.getElementById('novo-assunto').value = '';
    this.atualizarSelectAssuntos();
    this.atualizarSelectEditAssuntos();
};

// CRUD de Classes
ProcessoManager.prototype.adicionarClasse = function() {
    const input = document.getElementById('nova-classe');
    const nome = input.value.trim();

    if (!nome) {
        alert('Por favor, digite o nome da classe processual.');
        return;
    }

    // Verificar duplicata
    const existe = this.classesProcessuais.find(c => c.nome.toLowerCase() === nome.toLowerCase());
    if (existe) {
        alert('Esta classe já está cadastrada.');
        return;
    }

    // Gerar slug
    const slug = nome.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');

    // Gerar ID único
    const novoId = this.classesProcessuais.length > 0
        ? Math.max(...this.classesProcessuais.map(c => c.id)) + 1
        : 1;

    this.classesProcessuais.push({
        id: novoId,
        nome: nome,
        slug: slug
    });

    this.salvarClassesProcessuais();
    this.renderizarListaClasses();
    input.value = '';
    this.mostrarNotificacao('Classe adicionada com sucesso!', 'success');
};

ProcessoManager.prototype.excluirClasse = function(id) {
    const classe = this.classesProcessuais.find(c => c.id === id);
    if (!classe) return;

    // Verificar se está em uso
    const emUso = this.processos.some(p => p.classeProcessual === classe.slug);
    if (emUso) {
        alert(`Não é possível excluir "${classe.nome}" pois existem processos usando esta classe.`);
        return;
    }

    if (!confirm(`Deseja realmente excluir a classe "${classe.nome}"?`)) {
        return;
    }

    this.classesProcessuais = this.classesProcessuais.filter(c => c.id !== id);
    this.salvarClassesProcessuais();
    this.renderizarListaClasses();
    this.mostrarNotificacao('Classe excluída com sucesso!', 'success');
};

// CRUD de Assuntos
ProcessoManager.prototype.adicionarAssunto = function() {
    const input = document.getElementById('novo-assunto');
    const nome = input.value.trim();

    if (!nome) {
        alert('Por favor, digite o nome do assunto.');
        return;
    }

    // Verificar duplicata
    const existe = this.assuntos.find(a => a.nome.toLowerCase() === nome.toLowerCase());
    if (existe) {
        alert('Este assunto já está cadastrado.');
        return;
    }

    // Gerar slug
    const slug = nome.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');

    // Gerar ID único
    const novoId = this.assuntos.length > 0
        ? Math.max(...this.assuntos.map(a => a.id)) + 1
        : 1;

    this.assuntos.push({
        id: novoId,
        nome: nome,
        slug: slug
    });

    this.salvarAssuntos();
    this.renderizarListaAssuntos();
    input.value = '';
    this.mostrarNotificacao('Assunto adicionado com sucesso!', 'success');
};

ProcessoManager.prototype.excluirAssunto = function(id) {
    const assunto = this.assuntos.find(a => a.id === id);
    if (!assunto) return;

    // Verificar se está em uso
    const emUso = this.processos.some(p => p.assunto === assunto.slug);
    if (emUso) {
        alert(`Não é possível excluir "${assunto.nome}" pois existem processos usando este assunto.`);
        return;
    }

    if (!confirm(`Deseja realmente excluir o assunto "${assunto.nome}"?`)) {
        return;
    }

    this.assuntos = this.assuntos.filter(a => a.id !== id);
    this.salvarAssuntos();
    this.renderizarListaAssuntos();
    this.mostrarNotificacao('Assunto excluído com sucesso!', 'success');
};

// Função para abrir o histórico do processo
ProcessoManager.prototype.abrirHistoricoProcesso = function(id) {
    const processo = this.encontrarProcessoPorId(id);

    if (!processo) {
        this.mostrarNotificacao('Processo não encontrado!', 'error');
        return;
    }

    // Guardar ID do processo para exportação PDF
    this.processoHistoricoAtual = id;

    // Obter histórico do processo
    const logs = this.obterHistorico(id);

    // Preencher informações do processo no modal
    document.getElementById('historico-processo-numero').textContent = `📋 Processo nº ${processo.numeroProcesso}`;
    document.getElementById('historico-processo-assunto').textContent = this.getAssuntoLabel(processo.assunto);
    document.getElementById('historico-processo-classe').textContent = this.getClasseProcessualLabel(processo.classeProcessual);
    document.getElementById('historico-processo-status').textContent = this.getStatusLabel(processo.status);

    // Calcular estatísticas
    const totalMovimentacoes = logs.length;
    const totalEdicoes = logs.filter(log => log.tipo === 'edicao').length;
    const totalStatusAlterados = logs.filter(log => log.tipo === 'status-change').length;
    const diasConclusos = this.calcularDiasConclusos(processo.dataConclusao);

    // Preencher estatísticas
    document.getElementById('historico-total-movimentacoes').textContent = totalMovimentacoes;
    document.getElementById('historico-total-edicoes').textContent = totalEdicoes;
    document.getElementById('historico-total-status').textContent = totalStatusAlterados;
    document.getElementById('historico-dias-conclusos').textContent = diasConclusos;

    // Renderizar timeline
    this.renderizarTimeline(logs, id);

    // Abrir modal
    const modal = document.getElementById('modal-historico');
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');

    // Configurar evento de fechar (se ainda não configurado)
    this.configurarEventosModalHistorico();
};

// Renderizar timeline do histórico
ProcessoManager.prototype.renderizarTimeline = function(logs, processoId) {
    const timeline = document.getElementById('historico-timeline');

    if (logs.length === 0) {
        timeline.innerHTML = `
            <div class="empty-state-historico">
                <div class="empty-state-icon-historico">📋</div>
                <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">Nenhuma movimentação registrada</p>
                <p style="color: #94a3b8;">Este processo ainda não possui histórico de movimentações.</p>
            </div>
        `;
        return;
    }

    // Ordenar logs por data (mais recente primeiro)
    const logsOrdenados = [...logs].sort((a, b) => b.timestamp - a.timestamp);

    // Gerar HTML para cada log
    const htmlLogs = logsOrdenados.map(log => this.gerarHtmlLog(log)).join('');

    timeline.innerHTML = htmlLogs;
};

// Gerar HTML para um log individual
ProcessoManager.prototype.gerarHtmlLog = function(log) {
    const data = new Date(log.dataHora);
    const dataFormatada = this.formatarData(data.toISOString().split('T')[0]);
    const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

    // Determinar ícone e badge baseado no tipo
    const config = this.getConfigLog(log.tipo);

    // Gerar HTML das alterações
    let htmlAlteracoes = '';
    if (log.alteracoes && Object.keys(log.alteracoes).length > 0) {
        const alteracoesHtml = Object.entries(log.alteracoes).map(([campo, mudanca]) => {
            if (mudanca.antes && mudanca.depois) {
                return `
                    <div class="change-item-historico">
                        <span class="change-label-historico">${this.getLabelCampo(campo)}:</span>
                        <span class="change-old-historico">${this.escaparHTML(String(mudanca.antes))}</span>
                        <span class="change-arrow-historico">→</span>
                        <span class="change-new-historico">${this.escaparHTML(String(mudanca.depois))}</span>
                    </div>
                `;
            } else if (mudanca.depois) {
                return `
                    <div class="change-item-historico">
                        <span class="change-label-historico">${this.getLabelCampo(campo)}:</span>
                        <span class="change-new-historico">${this.escaparHTML(String(mudanca.depois))}</span>
                    </div>
                `;
            }
            return '';
        }).join('');

        if (alteracoesHtml) {
            htmlAlteracoes = `
                <div class="timeline-changes-historico">
                    ${alteracoesHtml}
                </div>
            `;
        }
    }

    return `
        <div class="timeline-item-historico ${log.tipo}">
            <div class="timeline-header-historico">
                <div class="timeline-title-historico">
                    <span class="timeline-icon-historico">${config.icone}</span>
                    ${config.titulo}
                    <span class="badge-historico badge-${config.classe}">${config.badge}</span>
                </div>
                <div class="timeline-datetime-historico">
                    <span class="timeline-date-historico">${dataFormatada}</span>
                    <span class="timeline-time-historico">${horaFormatada}</span>
                </div>
            </div>
            <div class="timeline-content-historico">
                ${this.escaparHTML(log.descricao)}
            </div>
            ${htmlAlteracoes}
        </div>
    `;
};

// Obter configuração visual do log
ProcessoManager.prototype.getConfigLog = function(tipo) {
    const configs = {
        'criacao': { icone: '➕', titulo: 'Processo cadastrado', badge: 'CRIAÇÃO', classe: 'criacao' },
        'edicao': { icone: '✏️', titulo: 'Processo editado', badge: 'EDIÇÃO', classe: 'edicao' },
        'status-change': { icone: '🔄', titulo: 'Status alterado', badge: 'STATUS', classe: 'status' },
        'despacho': { icone: '⚖️', titulo: 'Processo despachado', badge: 'DESPACHO', classe: 'despacho' },
        'finalizacao': { icone: '✅', titulo: 'Processo finalizado', badge: 'FINALIZAÇÃO', classe: 'finalizacao' },
        'retorno': { icone: '↩️', titulo: 'Processo retornou', badge: 'RETORNO', classe: 'retorno' }
    };

    return configs[tipo] || { icone: '📝', titulo: 'Movimentação', badge: 'LOG', classe: 'edicao' };
};

// Obter label amigável para campo
ProcessoManager.prototype.getLabelCampo = function(campo) {
    const labels = {
        'numeroProcesso': 'Número',
        'assunto': 'Assunto',
        'classeProcessual': 'Classe processual',
        'dataConclusao': 'Data de conclusão',
        'status': 'Status',
        'prioridade': 'Prioridade',
        'observacoes': 'Observações',
        'dataDespacho': 'Data do despacho',
        'dataFinalizacao': 'Data de finalização',
        'diasConclusos': 'Dias conclusos'
    };

    return labels[campo] || campo;
};

// Obter label do status
ProcessoManager.prototype.getStatusLabel = function(status) {
    const labels = {
        'aguardando-despacho': 'Aguardando despacho',
        'concluso': 'Concluso para julgamento',
        'despachado': 'Despachado',
        'finalizado': 'Finalizado'
    };

    return labels[status] || status;
};

// Configurar eventos do modal de histórico
ProcessoManager.prototype.configurarEventosModalHistorico = function() {
    if (this.eventosModalHistoricoConfigurados) {
        return; // Já configurado
    }

    const modal = document.getElementById('modal-historico');
    const botoesFechar = document.querySelectorAll('.close-modal-historico');

    // Fechar ao clicar no X ou no botão Fechar
    botoesFechar.forEach(btn => {
        btn.addEventListener('click', () => {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
        });
    });

    // Fechar ao clicar fora do modal
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
        }
    });

    // Fechar com ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
        }
    });

    this.eventosModalHistoricoConfigurados = true;
};

// Exportar histórico do processo em PDF
ProcessoManager.prototype.exportarHistoricoPDF = function() {
    if (!this.processoHistoricoAtual) {
        this.mostrarNotificacao('Nenhum processo selecionado.', 'error');
        return;
    }

    const processo = this.processos.find(p => p.id === this.processoHistoricoAtual);
    if (!processo) {
        this.mostrarNotificacao('Processo não encontrado.', 'error');
        return;
    }

    const logs = this.obterHistorico(this.processoHistoricoAtual);

    try {
        // Verificar se jsPDF está disponível
        if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
            throw new Error('Biblioteca jsPDF não carregada');
        }

        // Criar PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Cabeçalho
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('HISTÓRICO DO PROCESSO', 105, 20, { align: 'center' });

        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.text('Sistema de Controle de Processos - Gabinete Judicial', 105, 27, { align: 'center' });

        // Informações do Processo
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('Dados do Processo:', 14, 38);

        doc.setFont('helvetica', 'normal');
        let yPos = 44;
        doc.text(`Número: ${processo.numeroProcesso}`, 14, yPos);
        yPos += 6;
        doc.text(`Assunto: ${this.getAssuntoLabel(processo.assunto)}`, 14, yPos);
        yPos += 6;
        doc.text(`Classe: ${this.getClasseProcessualLabel(processo.classeProcessual)}`, 14, yPos);
        yPos += 6;
        doc.text(`Status atual: ${this.getStatusLabel(processo.status)}`, 14, yPos);
        yPos += 6;

        // Estatísticas
        const totalMovimentacoes = logs.length;
        const totalEdicoes = logs.filter(log => log.tipo === 'edicao').length;
        const totalStatusAlterados = logs.filter(log => log.tipo === 'status-change').length;
        const diasConclusos = this.calcularDiasConclusos(processo.dataConclusao);

        doc.setFont('helvetica', 'bold');
        yPos += 4;
        doc.text('Estatísticas:', 14, yPos);
        yPos += 6;
        doc.setFont('helvetica', 'normal');
        doc.text(`Total de movimentações: ${totalMovimentacoes}`, 14, yPos);
        yPos += 6;
        doc.text(`Edições realizadas: ${totalEdicoes}`, 14, yPos);
        yPos += 6;
        doc.text(`Status alterados: ${totalStatusAlterados}`, 14, yPos);
        if (processo.status !== 'finalizado') {
            yPos += 6;
            doc.text(`Dias conclusos: ${diasConclusos}`, 14, yPos);
        }
        yPos += 6;

        // Data de geração
        doc.setFontSize(8);
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}`, 14, yPos);
        yPos += 8;

        // Histórico de Movimentações
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text('Histórico de Movimentações:', 14, yPos);
        yPos += 6;

        if (logs.length === 0) {
            doc.setFontSize(10);
            doc.setFont('helvetica', 'italic');
            doc.text('Nenhuma movimentação registrada.', 14, yPos);
        } else {
            // Ordenar logs por data (mais recente primeiro)
            const logsOrdenados = [...logs].sort((a, b) => b.timestamp - a.timestamp);

            // Preparar dados para a tabela
            const tableData = [];

            logsOrdenados.forEach(log => {
                const data = new Date(log.dataHora);
                const dataFormatada = this.formatarData(data.toISOString().split('T')[0]);
                const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const config = this.getConfigLog(log.tipo);

                // Linha principal com data/hora e tipo
                let descricao = `${config.titulo}\n${log.descricao}`;

                // Adicionar alterações se houver
                if (log.alteracoes && Object.keys(log.alteracoes).length > 0) {
                    descricao += '\n\nAlterações:';
                    Object.entries(log.alteracoes).forEach(([campo, mudanca]) => {
                        const label = this.getLabelCampo(campo);
                        if (mudanca.antes && mudanca.depois) {
                            descricao += `\n• ${label}: ${mudanca.antes} → ${mudanca.depois}`;
                        } else if (mudanca.depois) {
                            descricao += `\n• ${label}: ${mudanca.depois}`;
                        }
                    });
                }

                tableData.push([
                    `${dataFormatada}\n${horaFormatada}`,
                    config.badge,
                    descricao
                ]);
            });

            // Renderizar tabela
            doc.autoTable({
                startY: yPos,
                head: [['Data/Hora', 'Tipo', 'Descrição']],
                body: tableData,
                styles: {
                    fontSize: 8,
                    cellPadding: 3,
                    overflow: 'linebreak',
                    valign: 'top'
                },
                headStyles: {
                    fillColor: [102, 126, 234],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    halign: 'left'
                },
                columnStyles: {
                    0: { cellWidth: 30, halign: 'left' },
                    1: { cellWidth: 30, halign: 'left' },
                    2: { cellWidth: 'auto', halign: 'left' }
                },
                alternateRowStyles: {
                    fillColor: [245, 247, 250]
                },
                margin: { top: 10, right: 14, bottom: 10, left: 14 }
            });
        }

        // Salvar PDF
        const nomeArquivo = `Historico_${processo.numeroProcesso.replace(/[^0-9]/g, '')}_${new Date().getTime()}.pdf`;
        doc.save(nomeArquivo);

        this.mostrarNotificacao('Histórico exportado com sucesso!', 'success');

    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        this.mostrarNotificacao('Erro ao gerar PDF do histórico. Verifique o console para mais detalhes.', 'error');
    }
};

// Inicializar aplicação
const manager = new ProcessoManager();

// Event listener para fechar sidebar ao clicar fora em mobile
document.addEventListener('click', (e) => {
    if (window.innerWidth <= 768) {
        const sidebar = document.querySelector('.sidebar');
        const menuToggle = document.getElementById('menu-toggle');

        // Verificar se clicou fora da sidebar e do botão menu
        if (sidebar && sidebar.classList.contains('show') &&
            !sidebar.contains(e.target) &&
            !menuToggle.contains(e.target)) {
            sidebar.classList.remove('show');
        }
    }
});

// Event listener para fechar sidebar ao clicar em botões da sidebar em mobile
document.querySelectorAll('.sidebar-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar && sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
            }
        }
    });
});

// Atalhos de teclado
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K para focar no campo de busca
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('busca').focus();
    }

    // ESC para fechar sidebar em mobile
    if (e.key === 'Escape' && window.innerWidth <= 768) {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar && sidebar.classList.contains('show')) {
            sidebar.classList.remove('show');
        }
    }
});
</script>
</body>
</html>